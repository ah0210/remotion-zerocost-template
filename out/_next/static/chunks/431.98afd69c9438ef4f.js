"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[431],{2431:(e,t,r)=>{r.d(t,{renderMediaOnWeb:()=>ij});var i=r(3468),a=r(8734);class o{constructor(e){this.mutex=new a.aD,this.firstMediaStreamTimestamp=null,this.trackTimestampInfo=new WeakMap,this.output=e}onTrackClose(e){}validateAndNormalizeTimestamp(e,t,r){t+=e.source._timestampOffset;let i=this.trackTimestampInfo.get(e);if(!i){if(!r)throw Error("First packet must be a key packet.");i={maxTimestamp:t,maxTimestampBeforeLastKeyPacket:t},this.trackTimestampInfo.set(e,i)}if(t<0)throw Error(`Timestamps must be non-negative (got ${t}s).`);if(r&&(i.maxTimestampBeforeLastKeyPacket=i.maxTimestamp),t<i.maxTimestampBeforeLastKeyPacket)throw Error(`Timestamps cannot be smaller than the largest timestamp of the previous GOP (a GOP begins with a key packet and ends right before the next key packet). Got ${t}s, but largest timestamp is ${i.maxTimestampBeforeLastKeyPacket}s.`);return i.maxTimestamp=Math.max(i.maxTimestamp,t),t}}var s=r(5799),n=r(8113),l=r(4159);r(2778);let c=/<(?:(\d{2}):)?(\d{2}):(\d{2}).(\d{3})>/g,d=/(?:(\d{2}):)?(\d{2}):(\d{2}).(\d{3})/,h=e=>{let t=d.exec(e);if(!t)throw Error("Expected match.");return 36e5*Number(t[1]||"0")+6e4*Number(t[2])+1e3*Number(t[3])+Number(t[4])},u=e=>{let t=Math.floor(e/36e5),r=Math.floor(e%36e5/6e4),i=Math.floor(e%6e4/1e3);return t.toString().padStart(2,"0")+":"+r.toString().padStart(2,"0")+":"+i.toString().padStart(2,"0")+"."+(e%1e3).toString().padStart(3,"0")};class m{constructor(e){this.writer=e,this.helper=new Uint8Array(8),this.helperView=new DataView(this.helper.buffer),this.offsets=new WeakMap}writeU32(e){this.helperView.setUint32(0,e,!1),this.writer.write(this.helper.subarray(0,4))}writeU64(e){this.helperView.setUint32(0,Math.floor(e/0x100000000),!1),this.helperView.setUint32(4,e,!1),this.writer.write(this.helper.subarray(0,8))}writeAscii(e){for(let t=0;t<e.length;t++)this.helperView.setUint8(t%8,e.charCodeAt(t)),t%8==7&&this.writer.write(this.helper);e.length%8!=0&&this.writer.write(this.helper.subarray(0,e.length%8))}writeBox(e){if(this.offsets.set(e,this.writer.getPos()),e.contents&&!e.children)this.writeBoxHeader(e,e.size??e.contents.byteLength+8),this.writer.write(e.contents);else{let t=this.writer.getPos();if(this.writeBoxHeader(e,0),e.contents&&this.writer.write(e.contents),e.children)for(let t of e.children)t&&this.writeBox(t);let r=this.writer.getPos(),i=e.size??r-t;this.writer.seek(t),this.writeBoxHeader(e,i),this.writer.seek(r)}}writeBoxHeader(e,t){this.writeU32(e.largeSize?1:t),this.writeAscii(e.type),e.largeSize&&this.writeU64(t)}measureBoxHeader(e){return 8+8*!!e.largeSize}patchBox(e){let t=this.offsets.get(e);(0,a.vA)(void 0!==t);let r=this.writer.getPos();this.writer.seek(t),this.writeBox(e),this.writer.seek(r)}measureBox(e){if(e.contents&&!e.children)return this.measureBoxHeader(e)+e.contents.byteLength;{let t=this.measureBoxHeader(e);if(e.contents&&(t+=e.contents.byteLength),e.children)for(let r of e.children)r&&(t+=this.measureBox(r));return t}}}let f=new Uint8Array(8),p=new DataView(f.buffer),g=e=>[(e%256+256)%256],w=e=>(p.setUint16(0,e,!1),[f[0],f[1]]),b=e=>(p.setInt16(0,e,!1),[f[0],f[1]]),y=e=>(p.setUint32(0,e,!1),[f[1],f[2],f[3]]),k=e=>(p.setUint32(0,e,!1),[f[0],f[1],f[2],f[3]]),v=e=>(p.setInt32(0,e,!1),[f[0],f[1],f[2],f[3]]),C=e=>(p.setUint32(0,Math.floor(e/0x100000000),!1),p.setUint32(4,e,!1),[f[0],f[1],f[2],f[3],f[4],f[5],f[6],f[7]]),T=e=>(p.setInt16(0,256*e,!1),[f[0],f[1]]),x=e=>(p.setInt32(0,65536*e,!1),[f[0],f[1],f[2],f[3]]),E=e=>(p.setInt32(0,0x40000000*e,!1),[f[0],f[1],f[2],f[3]]),S=(e,t)=>{let r=[],i=e;do{let e=127&i;i>>=7,r.length>0&&(e|=128),r.push(e),void 0!==t&&t--}while(i>0||t);return r.reverse()},M=(e,t=!1)=>{let r=Array(e.length).fill(null).map((t,r)=>e.charCodeAt(r));return t&&r.push(0),r},A=e=>{let t=null;for(let r of e)(!t||r.timestamp>t.timestamp)&&(t=r);return t},_=e=>{let t=Math.PI/180*e,r=Math.round(Math.cos(t)),i=Math.round(Math.sin(t));return[r,i,0,-i,r,0,0,0,1]},R=_(0),P=e=>[x(e[0]),x(e[1]),E(e[2]),x(e[3]),x(e[4]),E(e[5]),x(e[6]),x(e[7]),E(e[8])],z=(e,t,r)=>({type:e,contents:t&&new Uint8Array(t.flat(10)),children:r}),F=(e,t,r,i,a)=>z(e,[g(t),y(r),i??[]],a),W=e=>e.isQuickTime?z("ftyp",[M("qt  "),k(512),M("qt  ")]):e.fragmented?z("ftyp",[M("iso5"),k(512),M("iso5"),M("iso6"),M("mp41")]):z("ftyp",[M("isom"),k(512),M("isom"),e.holdsAvc?M("avc1"):[],M("mp41")]),I=e=>({type:"mdat",largeSize:e}),L=e=>({type:"free",size:e}),O=e=>z("moov",void 0,[D(e.creationTime,e.trackDatas),...e.trackDatas.map(t=>B(t,e.creationTime)),e.isFragmented?eb(e.trackDatas):null,eF(e)]),D=(e,t)=>{let r=e8(Math.max(0,...t.filter(e=>e.samples.length>0).map(e=>{let t=A(e.samples);return t.timestamp+t.duration})),e4),i=Math.max(0,...t.map(e=>e.track.id))+1,o=!(0,a.vv)(e)||!(0,a.vv)(r),s=o?C:k;return F("mvhd",+o,0,[s(e),s(e),k(e4),s(r),x(1),T(1),Array(10).fill(0),P(R),Array(24).fill(0),k(i)])},B=(e,t)=>{let r=e6(e);return z("trak",void 0,[U(e,t),N(e,t),void 0!==r.name?z("udta",void 0,[z("name",[...a.UG.encode(r.name)])]):null])},U=(e,t)=>{let r;let i=A(e.samples),o=e8(i?i.timestamp+i.duration:0,e4),s=!(0,a.vv)(t)||!(0,a.vv)(o),n=s?C:k;r="video"===e.type?_(e.track.metadata.rotation??0):R;let l=2;return e.track.metadata.disposition?.default!==!1&&(l|=1),F("tkhd",+s,l,[n(t),n(t),k(e.track.id),k(0),n(o),Array(8).fill(0),w(0),w(e.track.id),T(+("audio"===e.type)),w(0),P(r),x("video"===e.type?e.info.width:0),x("video"===e.type?e.info.height:0)])},N=(e,t)=>z("mdia",void 0,[$(e,t),Q(!0,V[e.type],H[e.type]),j(e)]),$=(e,t)=>{let r=A(e.samples),i=e8(r?r.timestamp+r.duration:0,e.timescale),o=!(0,a.vv)(t)||!(0,a.vv)(i),s=o?C:k;return F("mdhd",+o,0,[s(t),s(t),k(e.timescale),s(i),w(eq(e.track.metadata.languageCode??a.IR)),w(0)])},V={video:"vide",audio:"soun",subtitle:"text"},H={video:"MediabunnyVideoHandler",audio:"MediabunnySoundHandler",subtitle:"MediabunnyTextHandler"},Q=(e,t,r,i="\0\0\0\0")=>F("hdlr",0,0,[e?M("mhlr"):k(0),M(t),M(i),k(0),k(0),M(r,!0)]),j=e=>z("minf",void 0,[q[e.type](),X(),Y(e)]),q={video:()=>F("vmhd",0,1,[w(0),w(0),w(0),w(0)]),audio:()=>F("smhd",0,0,[w(0),w(0)]),subtitle:()=>F("nmhd",0,0)},X=()=>z("dinf",void 0,[G()]),G=()=>F("dref",0,0,[k(1)],[K()]),K=()=>F("url ",0,1),Y=e=>{let t=e.compositionTimeOffsetTable.length>1||e.compositionTimeOffsetTable.some(e=>0!==e.sampleCompositionTimeOffset);return z("stbl",void 0,[Z(e),eh(e),t?eg(e):null,t?ew(e):null,em(e),ef(e),ep(e),eu(e)])},Z=e=>{let t;if("video"===e.type)t=J(eN(e.track.source._codec,e.info.decoderConfig.codec),e);else if("audio"===e.type){let r=eV(e.track.source._codec,e.muxer.isQuickTime);(0,a.vA)(r),t=er(r,e)}else"subtitle"===e.type&&(t=ed(eQ[e.track.source._codec],e));return(0,a.vA)(t),F("stsd",0,0,[k(1)],[t])},J=(e,t)=>z(e,[Array(6).fill(0),w(1),w(0),w(0),Array(12).fill(0),w(t.info.width),w(t.info.height),k(4718592),k(4718592),k(0),w(1),Array(32).fill(0),w(24),b(65535)],[e$[t.track.source._codec](t),(0,a.HV)(t.info.decoderConfig.colorSpace)?ee(t):null]),ee=e=>z("colr",[M("nclx"),w(a.wd[e.info.decoderConfig.colorSpace.primaries]),w(a.uN[e.info.decoderConfig.colorSpace.transfer]),w(a.Au[e.info.decoderConfig.colorSpace.matrix]),g(+!!e.info.decoderConfig.colorSpace.fullRange<<7)]),et=e=>{if(!e.info.decoderConfig)return null;let t=e.info.decoderConfig,r=t.codec.split("."),i=Number(r[1]),o=Number(r[2]),s=Number(r[3]),n=r[4]?Number(r[4]):1,l=r[8]?Number(r[8]):Number(t.colorSpace?.fullRange??0),c=r[5]?Number(r[5]):t.colorSpace?.primaries?a.wd[t.colorSpace.primaries]:2,d=r[6]?Number(r[6]):t.colorSpace?.transfer?a.uN[t.colorSpace.transfer]:2,h=r[7]?Number(r[7]):t.colorSpace?.matrix?a.Au[t.colorSpace.matrix]:2;return F("vpcC",1,0,[g(i),g(o),g((s<<4)+(n<<1)+l),g(c),g(d),g(h),w(0)])},er=(e,t)=>{let r,a=0,o=16;if(i.Wq.includes(t.track.source._codec)){let e=t.track.source._codec,{sampleSize:r}=(0,i.Ei)(e);(o=8*r)>16&&(a=1)}return z(e,0===a?[Array(6).fill(0),w(1),w(a),w(0),k(0),w(t.info.numberOfChannels),w(o),w(0),w(0),w(t.info.sampleRate<65536?t.info.sampleRate:0),w(0)]:[Array(6).fill(0),w(1),w(a),w(0),k(0),w(t.info.numberOfChannels),w(Math.min(o,16)),w(0),w(0),w(t.info.sampleRate<65536?t.info.sampleRate:0),w(0),k(1),k(o/8),k(t.info.numberOfChannels*o/8),k(2)],[eH(t.track.source._codec,t.muxer.isQuickTime)?.(t)??null])},ei=e=>{let t;switch(e.track.source._codec){case"aac":t=64;break;case"mp3":t=107;break;case"vorbis":t=221;break;default:throw Error(`Unhandled audio codec: ${e.track.source._codec}`)}let r=[...g(t),...g(21),...y(0),...k(0),...k(0)];if(e.info.decoderConfig.description){let t=(0,a.Fo)(e.info.decoderConfig.description);r=[...r,...g(5),...S(t.byteLength),...t]}return r=[...w(1),...g(0),...g(4),...S(r.length),...r,...g(6),...g(1),...g(2)],F("esds",0,0,r=[...g(3),...S(r.length),...r])},ea=e=>z("wave",void 0,[eo(e),es(e),z("\0\0\0\0")]),eo=e=>z("frma",[M(eV(e.track.source._codec,e.muxer.isQuickTime))]),es=e=>{let{littleEndian:t}=(0,i.Ei)(e.track.source._codec);return z("enda",[w(+t)])},en=e=>{let t=e.info.numberOfChannels,r=3840,i=e.info.sampleRate,o=0,n=0,l=new Uint8Array(0),c=e.info.decoderConfig?.description;if(c){(0,a.vA)(c.byteLength>=18);let e=(0,a.Fo)(c),d=(0,s.Qf)(e);t=d.outputChannelCount,r=d.preSkip,i=d.inputSampleRate,o=d.outputGain,n=d.channelMappingFamily,d.channelMappingTable&&(l=d.channelMappingTable)}return z("dOps",[g(0),g(t),w(r),k(i),b(o),g(n),...l])},el=e=>{let t=e.info.decoderConfig?.description;return(0,a.vA)(t),F("dfLa",0,0,[...(0,a.Fo)(t).subarray(4)])},ec=e=>{let{littleEndian:t,sampleSize:r}=(0,i.Ei)(e.track.source._codec);return F("pcmC",0,0,[g(+t),g(8*r)])},ed=(e,t)=>z(e,[Array(6).fill(0),w(1)],[ej[t.track.source._codec](t)]),eh=e=>F("stts",0,0,[k(e.timeToSampleTable.length),e.timeToSampleTable.map(e=>[k(e.sampleCount),k(e.sampleDelta)])]),eu=e=>{if(e.samples.every(e=>"key"===e.type))return null;let t=[...e.samples.entries()].filter(([,e])=>"key"===e.type);return F("stss",0,0,[k(t.length),t.map(([e])=>k(e+1))])},em=e=>F("stsc",0,0,[k(e.compactlyCodedChunkTable.length),e.compactlyCodedChunkTable.map(e=>[k(e.firstChunk),k(e.samplesPerChunk),k(1)])]),ef=e=>{if("audio"===e.type&&e.info.requiresPcmTransformation){let{sampleSize:t}=(0,i.Ei)(e.track.source._codec);return F("stsz",0,0,[k(t*e.info.numberOfChannels),k(e.samples.reduce((t,r)=>t+e8(r.duration,e.timescale),0))])}return F("stsz",0,0,[k(0),k(e.samples.length),e.samples.map(e=>k(e.size))])},ep=e=>e.finalizedChunks.length>0&&(0,a._g)(e.finalizedChunks).offset>=0x100000000?F("co64",0,0,[k(e.finalizedChunks.length),e.finalizedChunks.map(e=>C(e.offset))]):F("stco",0,0,[k(e.finalizedChunks.length),e.finalizedChunks.map(e=>k(e.offset))]),eg=e=>F("ctts",1,0,[k(e.compositionTimeOffsetTable.length),e.compositionTimeOffsetTable.map(e=>[k(e.sampleCount),v(e.sampleCompositionTimeOffset)])]),ew=e=>{let t=1/0,r=-1/0,i=1/0,o=-1/0;(0,a.vA)(e.compositionTimeOffsetTable.length>0),(0,a.vA)(e.samples.length>0);for(let i=0;i<e.compositionTimeOffsetTable.length;i++){let a=e.compositionTimeOffsetTable[i];t=Math.min(t,a.sampleCompositionTimeOffset),r=Math.max(r,a.sampleCompositionTimeOffset)}for(let t=0;t<e.samples.length;t++){let r=e.samples[t];i=Math.min(i,e8(r.timestamp,e.timescale)),o=Math.max(o,e8(r.timestamp+r.duration,e.timescale))}let s=Math.max(-t,0);return o>=0x80000000?null:F("cslg",0,0,[v(s),v(t),v(r),v(i),v(o)])},eb=e=>z("mvex",void 0,e.map(ey)),ey=e=>F("trex",0,0,[k(e.track.id),k(1),k(0),k(0),k(0)]),ek=(e,t)=>z("moof",void 0,[ev(e),...t.map(eT)]),ev=e=>F("mfhd",0,0,[k(e)]),eC=e=>{let t=0,r=0,i="delta"===e.type;return r|=+i,i?t|=1:t|=2,t<<24|r<<16|0},eT=e=>z("traf",void 0,[ex(e),eE(e),eS(e)]),ex=e=>{(0,a.vA)(e.currentChunk);let t=e.currentChunk.samples[1]??e.currentChunk.samples[0],r={duration:t.timescaleUnitsToNextSample,size:t.size,flags:eC(t)};return F("tfhd",0,131128,[k(e.track.id),k(r.duration),k(r.size),k(r.flags)])},eE=e=>((0,a.vA)(e.currentChunk),F("tfdt",1,0,[C(e8(e.currentChunk.startTimestamp,e.timescale))])),eS=e=>{let t;(0,a.vA)(e.currentChunk);let r=e.currentChunk.samples.map(e=>e.timescaleUnitsToNextSample),i=e.currentChunk.samples.map(e=>e.size),o=e.currentChunk.samples.map(eC),s=e.currentChunk.samples.map(t=>e8(t.timestamp-t.decodeTimestamp,e.timescale)),n=new Set(r),l=new Set(i),c=new Set(o),d=new Set(s),h=2===c.size&&o[0]!==o[1],u=n.size>1,m=l.size>1,f=!h&&c.size>1,p=d.size>1||[...d].some(e=>0!==e);return F("trun",1,1|4*+h|256*+u|512*+m|1024*+f|2048*+p,[k(e.currentChunk.samples.length),k(e.currentChunk.offset-e.currentChunk.moofOffset||0),h?k(o[0]):[],e.currentChunk.samples.map((e,t)=>[u?k(r[t]):[],m?k(i[t]):[],f?k(o[t]):[],p?v(s[t]):[]])])},eM=e=>z("mfra",void 0,[...e.map(eA),e_()]),eA=(e,t)=>F("tfra",1,0,[k(e.track.id),k(63),k(e.finalizedChunks.length),e.finalizedChunks.map(r=>[C(e8(r.samples[0].timestamp,e.timescale)),C(r.moofOffset),k(t+1),k(1),k(1)])]),e_=()=>F("mfro",0,0,[k(0)]),eR=()=>z("vtte"),eP=(e,t,r,i,o)=>z("vttc",void 0,[null!==o?z("vsid",[v(o)]):null,null!==r?z("iden",[...a.UG.encode(r)]):null,null!==t?z("ctim",[...a.UG.encode(u(t))]):null,null!==i?z("sttg",[...a.UG.encode(i)]):null,z("payl",[...a.UG.encode(e)])]),ez=e=>z("vtta",[...a.UG.encode(e)]),eF=e=>{let t=[],r=e.format._options.metadataFormat??"auto",i=e.output._metadataTags;if("mdir"!==r&&("auto"!==r||e.isQuickTime)){if("mdta"===r){let e=eB(i);e&&t.push(e)}else("udta"===r||"auto"===r&&e.isQuickTime)&&eW(t,e.output._metadataTags)}else{let e=eD(i);e&&t.push(e)}return 0===t.length?null:z("udta",void 0,t)},eW=(e,t)=>{for(let{key:r,value:i}of(0,a.rk)(t))switch(r){case"title":e.push(eI("\xa9nam",i));break;case"description":e.push(eI("\xa9des",i));break;case"artist":e.push(eI("\xa9ART",i));break;case"album":e.push(eI("\xa9alb",i));break;case"albumArtist":e.push(eI("albr",i));break;case"genre":e.push(eI("\xa9gen",i));break;case"date":e.push(eI("\xa9day",i.toISOString().slice(0,10)));break;case"comment":e.push(eI("\xa9cmt",i));break;case"lyrics":e.push(eI("\xa9lyr",i));break;case"raw":case"discNumber":case"discsTotal":case"trackNumber":case"tracksTotal":case"images":break;default:(0,a.xb)(r)}if(t.raw)for(let r in t.raw){let i=t.raw[r];!(null==i||4!==r.length||e.some(e=>e.type===r))&&("string"==typeof i?e.push(eI(r,i)):i instanceof Uint8Array&&e.push(z(r,Array.from(i))))}},eI=(e,t)=>{let r=a.UG.encode(t);return z(e,[w(r.length),w(eq("und")),Array.from(r)])},eL={"image/jpeg":13,"image/png":14,"image/bmp":27},eO=(e,t)=>{let r=[];for(let{key:i,value:o}of(0,a.rk)(e))switch(i){case"title":r.push({key:t?"title":"\xa9nam",value:eU(o)});break;case"description":r.push({key:t?"description":"\xa9des",value:eU(o)});break;case"artist":r.push({key:t?"artist":"\xa9ART",value:eU(o)});break;case"album":r.push({key:t?"album":"\xa9alb",value:eU(o)});break;case"albumArtist":r.push({key:t?"album_artist":"aART",value:eU(o)});break;case"comment":r.push({key:t?"comment":"\xa9cmt",value:eU(o)});break;case"genre":r.push({key:t?"genre":"\xa9gen",value:eU(o)});break;case"lyrics":r.push({key:t?"lyrics":"\xa9lyr",value:eU(o)});break;case"date":r.push({key:t?"date":"\xa9day",value:eU(o.toISOString().slice(0,10))});break;case"images":for(let e of o)"coverFront"===e.kind&&r.push({key:"covr",value:z("data",[k(eL[e.mimeType]??0),k(0),Array.from(e.data)])});break;case"trackNumber":if(t){let t=void 0!==e.tracksTotal?`${o}/${e.tracksTotal}`:o.toString();r.push({key:"track",value:eU(t)})}else r.push({key:"trkn",value:z("data",[k(0),k(0),w(0),w(o),w(e.tracksTotal??0),w(0)])});break;case"discNumber":t||r.push({key:"disc",value:z("data",[k(0),k(0),w(0),w(o),w(e.discsTotal??0),w(0)])});break;case"tracksTotal":case"discsTotal":case"raw":break;default:(0,a.xb)(i)}if(e.raw)for(let i in e.raw){let a=e.raw[i];!(null==a||!t&&4!==i.length||r.some(e=>e.key===i))&&("string"==typeof a?r.push({key:i,value:eU(a)}):a instanceof Uint8Array?r.push({key:i,value:z("data",[k(0),k(0),Array.from(a)])}):a instanceof l.sF&&r.push({key:i,value:z("data",[k(eL[a.mimeType]??0),k(0),Array.from(a.data)])}))}return r},eD=e=>{let t=eO(e,!1);return 0===t.length?null:F("meta",0,0,void 0,[Q(!1,"mdir","","appl"),z("ilst",void 0,t.map(e=>z(e.key,void 0,[e.value])))])},eB=e=>{let t=eO(e,!0);return 0===t.length?null:z("meta",void 0,[Q(!1,"mdta",""),F("keys",0,0,[k(t.length)],t.map(e=>z("mdta",[...a.UG.encode(e.key)]))),z("ilst",void 0,t.map((e,t)=>z(String.fromCharCode(...k(t+1)),void 0,[e.value])))])},eU=e=>z("data",[k(1),k(0),...a.UG.encode(e)]),eN=(e,t)=>{switch(e){case"avc":return t.startsWith("avc3")?"avc3":"avc1";case"hevc":return"hvc1";case"vp8":return"vp08";case"vp9":return"vp09";case"av1":return"av01"}},e$={avc:e=>e.info.decoderConfig&&z("avcC",[...(0,a.Fo)(e.info.decoderConfig.description)]),hevc:e=>e.info.decoderConfig&&z("hvcC",[...(0,a.Fo)(e.info.decoderConfig.description)]),vp8:et,vp9:et,av1:e=>z("av1C",(0,i.DC)(e.info.decoderConfig.codec))},eV=(e,t)=>{switch(e){case"aac":case"mp3":case"vorbis":return"mp4a";case"opus":return"Opus";case"flac":return"fLaC";case"ulaw":return"ulaw";case"alaw":return"alaw";case"pcm-u8":return"raw ";case"pcm-s8":return"sowt"}if(t)switch(e){case"pcm-s16":return"sowt";case"pcm-s16be":return"twos";case"pcm-s24":case"pcm-s24be":return"in24";case"pcm-s32":case"pcm-s32be":return"in32";case"pcm-f32":case"pcm-f32be":return"fl32";case"pcm-f64":case"pcm-f64be":return"fl64"}else switch(e){case"pcm-s16":case"pcm-s16be":case"pcm-s24":case"pcm-s24be":case"pcm-s32":case"pcm-s32be":return"ipcm";case"pcm-f32":case"pcm-f32be":case"pcm-f64":case"pcm-f64be":return"fpcm"}},eH=(e,t)=>{switch(e){case"aac":case"mp3":case"vorbis":return ei;case"opus":return en;case"flac":return el}if(t)switch(e){case"pcm-s24":case"pcm-s24be":case"pcm-s32":case"pcm-s32be":case"pcm-f32":case"pcm-f32be":case"pcm-f64":case"pcm-f64be":return ea}else switch(e){case"pcm-s16":case"pcm-s16be":case"pcm-s24":case"pcm-s24be":case"pcm-s32":case"pcm-s32be":case"pcm-f32":case"pcm-f32be":case"pcm-f64":case"pcm-f64be":return ec}return null},eQ={webvtt:"wvtt"},ej={webvtt:e=>z("vttC",[...a.UG.encode(e.info.config.description)])},eq=e=>{(0,a.vA)(3===e.length);let t=0;for(let r=0;r<3;r++)t<<=5,t+=e.charCodeAt(r)-96;return t};class eX{constructor(){this.ensureMonotonicity=!1,this.trackedWrites=null,this.trackedStart=-1,this.trackedEnd=-1}start(){}maybeTrackWrites(e){if(!this.trackedWrites)return;let t=this.getPos();if(t<this.trackedStart){if(t+e.byteLength<=this.trackedStart)return;e=e.subarray(this.trackedStart-t),t=0}let r=t+e.byteLength-this.trackedStart,i=this.trackedWrites.byteLength;for(;i<r;)i*=2;if(i!==this.trackedWrites.byteLength){let e=new Uint8Array(i);e.set(this.trackedWrites,0),this.trackedWrites=e}this.trackedWrites.set(e,t-this.trackedStart),this.trackedEnd=Math.max(this.trackedEnd,t+e.byteLength)}startTrackingWrites(){this.trackedWrites=new Uint8Array(1024),this.trackedStart=this.getPos(),this.trackedEnd=this.trackedStart}stopTrackingWrites(){if(!this.trackedWrites)throw Error("Internal error: Can't get tracked writes since nothing was tracked.");let e={data:this.trackedWrites.subarray(0,this.trackedEnd-this.trackedStart),start:this.trackedStart,end:this.trackedEnd};return this.trackedWrites=null,e}}class eG extends eX{constructor(e){if(super(),this.pos=0,this.maxPos=0,this.target=e,this.supportsResize="resize"in new ArrayBuffer(0),this.supportsResize)try{this.buffer=new ArrayBuffer(65536,{maxByteLength:0x100000000})}catch{this.buffer=new ArrayBuffer(65536),this.supportsResize=!1}else this.buffer=new ArrayBuffer(65536);this.bytes=new Uint8Array(this.buffer)}ensureSize(e){let t=this.buffer.byteLength;for(;t<e;)t*=2;if(t!==this.buffer.byteLength){if(t>0x100000000)throw Error("ArrayBuffer exceeded maximum size of 4294967296 bytes. Please consider using another target.");if(this.supportsResize)this.buffer.resize(t);else{let e=new ArrayBuffer(t),r=new Uint8Array(e);r.set(this.bytes,0),this.buffer=e,this.bytes=r}}}write(e){this.maybeTrackWrites(e),this.ensureSize(this.pos+e.byteLength),this.bytes.set(e,this.pos),this.target.onwrite?.(this.pos,this.pos+e.byteLength),this.pos+=e.byteLength,this.maxPos=Math.max(this.maxPos,this.pos)}seek(e){this.pos=e}getPos(){return this.pos}async flush(){}async finalize(){this.ensureSize(this.pos),this.target.buffer=this.buffer.slice(0,Math.max(this.maxPos,this.pos))}async close(){}getSlice(e,t){return this.bytes.slice(e,t)}}class eK extends eX{constructor(e){super(),this.pos=0,this.sections=[],this.lastWriteEnd=0,this.lastFlushEnd=0,this.writer=null,this.chunks=[],this.target=e,this.chunked=e._options.chunked??!1,this.chunkSize=e._options.chunkSize??0x1000000}start(){this.writer=this.target._writable.getWriter()}write(e){if(this.pos>this.lastWriteEnd){let e=this.pos-this.lastWriteEnd;this.pos=this.lastWriteEnd,this.write(new Uint8Array(e))}this.maybeTrackWrites(e),this.sections.push({data:e.slice(),start:this.pos}),this.target.onwrite?.(this.pos,this.pos+e.byteLength),this.pos+=e.byteLength,this.lastWriteEnd=Math.max(this.lastWriteEnd,this.pos)}seek(e){this.pos=e}getPos(){return this.pos}async flush(){if(this.pos>this.lastWriteEnd){let e=this.pos-this.lastWriteEnd;this.pos=this.lastWriteEnd,this.write(new Uint8Array(e))}if((0,a.vA)(this.writer),0===this.sections.length)return;let e=[],t=[...this.sections].sort((e,t)=>e.start-t.start);e.push({start:t[0].start,size:t[0].data.byteLength});for(let r=1;r<t.length;r++){let i=e[e.length-1],a=t[r];a.start<=i.start+i.size?i.size=Math.max(i.size,a.start+a.data.byteLength-i.start):e.push({start:a.start,size:a.data.byteLength})}for(let t of e){for(let e of(t.data=new Uint8Array(t.size),this.sections))t.start<=e.start&&e.start<t.start+t.size&&t.data.set(e.data,e.start-t.start);if(null!==this.writer.desiredSize&&this.writer.desiredSize<=0&&await this.writer.ready,this.chunked)this.writeDataIntoChunks(t.data,t.start),this.tryToFlushChunks();else{if(this.ensureMonotonicity&&t.start!==this.lastFlushEnd)throw Error("Internal error: Monotonicity violation.");this.writer.write({type:"write",data:t.data,position:t.start}),this.lastFlushEnd=t.start+t.data.byteLength}}this.sections.length=0}writeDataIntoChunks(e,t){let r=this.chunks.findIndex(e=>e.start<=t&&t<e.start+this.chunkSize);-1===r&&(r=this.createChunk(t));let i=this.chunks[r],a=t-i.start,o=e.subarray(0,Math.min(this.chunkSize-a,e.byteLength));i.data.set(o,a);let s={start:a,end:a+o.byteLength};if(this.insertSectionIntoChunk(i,s),0===i.written[0].start&&i.written[0].end===this.chunkSize&&(i.shouldFlush=!0),this.chunks.length>2){for(let e=0;e<this.chunks.length-1;e++)this.chunks[e].shouldFlush=!0;this.tryToFlushChunks()}o.byteLength<e.byteLength&&this.writeDataIntoChunks(e.subarray(o.byteLength),t+o.byteLength)}insertSectionIntoChunk(e,t){let r=0,i=e.written.length-1,a=-1;for(;r<=i;){let o=Math.floor(r+(i-r+1)/2);e.written[o].start<=t.start?(r=o+1,a=o):i=o-1}for(e.written.splice(a+1,0,t),(-1===a||e.written[a].end<t.start)&&a++;a<e.written.length-1&&e.written[a].end>=e.written[a+1].start;)e.written[a].end=Math.max(e.written[a].end,e.written[a+1].end),e.written.splice(a+1,1)}createChunk(e){let t={start:Math.floor(e/this.chunkSize)*this.chunkSize,data:new Uint8Array(this.chunkSize),written:[],shouldFlush:!1};return this.chunks.push(t),this.chunks.sort((e,t)=>e.start-t.start),this.chunks.indexOf(t)}tryToFlushChunks(e=!1){(0,a.vA)(this.writer);for(let t=0;t<this.chunks.length;t++){let r=this.chunks[t];if(r.shouldFlush||e){for(let e of r.written){let t=r.start+e.start;if(this.ensureMonotonicity&&t!==this.lastFlushEnd)throw Error("Internal error: Monotonicity violation.");this.writer.write({type:"write",data:r.data.subarray(e.start,e.end),position:t}),this.lastFlushEnd=r.start+e.end}this.chunks.splice(t--,1)}}}finalize(){return this.chunked&&this.tryToFlushChunks(!0),(0,a.vA)(this.writer),this.writer.close()}async close(){return this.writer?.close()}}var eY=r(9313),eZ=r(1845);class eJ{constructor(){this._output=null,this.onwrite=null}}class e0 extends eJ{constructor(){super(...arguments),this.buffer=null}_createWriter(){return new eG(this)}}class e1 extends eJ{constructor(e,t={}){if(super(),!(e instanceof WritableStream))throw TypeError("StreamTarget requires a WritableStream instance.");if(null!=t&&"object"!=typeof t)throw TypeError("StreamTarget options, when provided, must be an object.");if(void 0!==t.chunked&&"boolean"!=typeof t.chunked)throw TypeError("options.chunked, when provided, must be a boolean.");if(void 0!==t.chunkSize&&(!Number.isInteger(t.chunkSize)||t.chunkSize<1024))throw TypeError("options.chunkSize, when provided, must be an integer and not smaller than 1024.");this._writable=e,this._options=t}_createWriter(){return new eK(this)}}var e2=r(2832),e3=r(5555);let e4=1e3,e6=e=>{let t={},r=e.track;return void 0!==r.metadata.name&&(t.name=r.metadata.name),t},e8=(e,t,r=!0)=>{let i=e*t;return r?Math.round(i):i};class e5 extends o{constructor(e,t){super(e),this.auxTarget=new e0,this.auxWriter=this.auxTarget._createWriter(),this.auxBoxWriter=new m(this.auxWriter),this.mdat=null,this.ftypSize=null,this.trackDatas=[],this.allTracksKnown=(0,a.nJ)(),this.creationTime=Math.floor(Date.now()/1e3)+0x7c25b080,this.finalizedChunks=[],this.nextFragmentNumber=1,this.maxWrittenTimestamp=-1/0,this.format=t,this.writer=e._writer,this.boxWriter=new m(this.writer),this.isQuickTime=t instanceof tl;let r=this.writer instanceof eG&&"in-memory";this.fastStart=t._options.fastStart??r,this.isFragmented="fragmented"===this.fastStart,("in-memory"===this.fastStart||this.isFragmented)&&(this.writer.ensureMonotonicity=!0),this.minimumFragmentDuration=t._options.minimumFragmentDuration??1}async start(){let e=await this.mutex.acquire(),t=this.output._tracks.some(e=>"video"===e.type&&"avc"===e.source._codec);if(this.format._options.onFtyp&&this.writer.startTrackingWrites(),this.boxWriter.writeBox(W({isQuickTime:this.isQuickTime,holdsAvc:t,fragmented:this.isFragmented})),this.format._options.onFtyp){let{data:e,start:t}=this.writer.stopTrackingWrites();this.format._options.onFtyp(e,t)}if(this.ftypSize=this.writer.getPos(),"in-memory"===this.fastStart);else if("reserve"===this.fastStart){for(let e of this.output._tracks)if(void 0===e.metadata.maximumPacketCount)throw Error("All tracks must specify maximumPacketCount in their metadata when using fastStart: 'reserve'.")}else this.isFragmented||(this.format._options.onMdat&&this.writer.startTrackingWrites(),this.mdat=I(!0),this.boxWriter.writeBox(this.mdat));await this.writer.flush(),e()}allTracksAreKnown(){for(let e of this.output._tracks)if(!e.source._closed&&!this.trackDatas.some(t=>t.track===e))return!1;return!0}async getMimeType(){await this.allTracksKnown.promise;let e=this.trackDatas.map(e=>"video"===e.type?e.info.decoderConfig.codec:"audio"===e.type?e.info.decoderConfig.codec:({webvtt:"wvtt"})[e.track.source._codec]);return(0,e2.X)({isQuickTime:this.isQuickTime,hasVideo:this.trackDatas.some(e=>"video"===e.type),hasAudio:this.trackDatas.some(e=>"audio"===e.type),codecStrings:e})}getVideoTrackData(e,t,r){let o=this.trackDatas.find(t=>t.track===e);if(o)return o;(0,i.aF)(r),(0,a.vA)(r),(0,a.vA)(r.decoderConfig);let n={...r.decoderConfig};(0,a.vA)(void 0!==n.codedWidth),(0,a.vA)(void 0!==n.codedHeight);let l=!1;if("avc"!==e.source._codec||n.description){if("hevc"===e.source._codec&&!n.description){let e=(0,s.D5)(t.data);if(!e)throw Error("Couldn't extract an HEVCDecoderConfigurationRecord from the HEVC packet. Make sure the packets are in Annex B format (as specified in ITU-T-REC-H.265) when not providing a description, or provide a description (must be an HEVCDecoderConfigurationRecord as specified in ISO 14496-15) and ensure the packets are in HEVC format.");n.description=(0,s.Us)(e),l=!0}}else{let e=(0,s.fH)(t.data);if(!e)throw Error("Couldn't extract an AVCDecoderConfigurationRecord from the AVC packet. Make sure the packets are in Annex B format (as specified in ITU-T-REC-H.264) when not providing a description, or provide a description (must be an AVCDecoderConfigurationRecord as specified in ISO 14496-15) and ensure the packets are in AVCC format.");n.description=(0,s.KU)(e),l=!0}let c=(0,a.b_)(1/(e.metadata.frameRate??57600),1e6).denominator,d={muxer:this,track:e,type:"video",info:{width:n.codedWidth,height:n.codedHeight,decoderConfig:n,requiresAnnexBTransformation:l},timescale:c,samples:[],sampleQueue:[],timestampProcessingQueue:[],timeToSampleTable:[],compositionTimeOffsetTable:[],lastTimescaleUnits:null,lastSample:null,finalizedChunks:[],currentChunk:null,compactlyCodedChunkTable:[]};return this.trackDatas.push(d),this.trackDatas.sort((e,t)=>e.track.id-t.track.id),this.allTracksAreKnown()&&this.allTracksKnown.resolve(),d}getAudioTrackData(e,t,r){let o=this.trackDatas.find(t=>t.track===e);if(o)return o;(0,i.P7)(r),(0,a.vA)(r),(0,a.vA)(r.decoderConfig);let s={...r.decoderConfig},l=!1;if("aac"===e.source._codec&&!s.description){let e=(0,eY.lh)(n.x$.tempFromBytes(t.data));if(!e)throw Error("Couldn't parse ADTS header from the AAC packet. Make sure the packets are in ADTS format (as specified in ISO 13818-7) when not providing a description, or provide a description (must be an AudioSpecificConfig as specified in ISO 14496-3) and ensure the packets are raw AAC data.");let r=i.Im[e.samplingFrequencyIndex],a=i.Ti[e.channelConfiguration];if(void 0===r||void 0===a)throw Error("Invalid ADTS frame header.");s.description=(0,i.Wz)({objectType:e.objectType,sampleRate:r,numberOfChannels:a}),l=!0}let c={muxer:this,track:e,type:"audio",info:{numberOfChannels:r.decoderConfig.numberOfChannels,sampleRate:r.decoderConfig.sampleRate,decoderConfig:s,requiresPcmTransformation:!this.isFragmented&&i.Wq.includes(e.source._codec),requiresAdtsStripping:l},timescale:r.decoderConfig.sampleRate,samples:[],sampleQueue:[],timestampProcessingQueue:[],timeToSampleTable:[],compositionTimeOffsetTable:[],lastTimescaleUnits:null,lastSample:null,finalizedChunks:[],currentChunk:null,compactlyCodedChunkTable:[]};return this.trackDatas.push(c),this.trackDatas.sort((e,t)=>e.track.id-t.track.id),this.allTracksAreKnown()&&this.allTracksKnown.resolve(),c}getSubtitleTrackData(e,t){let r=this.trackDatas.find(t=>t.track===e);if(r)return r;(0,i.GL)(t),(0,a.vA)(t),(0,a.vA)(t.config);let o={muxer:this,track:e,type:"subtitle",info:{config:t.config},timescale:1e3,samples:[],sampleQueue:[],timestampProcessingQueue:[],timeToSampleTable:[],compositionTimeOffsetTable:[],lastTimescaleUnits:null,lastSample:null,finalizedChunks:[],currentChunk:null,compactlyCodedChunkTable:[],lastCueEndTimestamp:0,cueQueue:[],nextSourceId:0,cueToSourceId:new WeakMap};return this.trackDatas.push(o),this.trackDatas.sort((e,t)=>e.track.id-t.track.id),this.allTracksAreKnown()&&this.allTracksKnown.resolve(),o}async addEncodedVideoPacket(e,t,r){let i=await this.mutex.acquire();try{let i=this.getVideoTrackData(e,t,r),a=t.data;if(i.info.requiresAnnexBTransformation){let e=[...(0,s._u)(a)].map(e=>a.subarray(e.offset,e.offset+e.length));if(0===e.length)throw Error("Failed to transform packet data. Make sure all packets are provided in Annex B format, as specified in ITU-T-REC-H.264 and ITU-T-REC-H.265.");a=(0,s.pc)(e,4)}let o=this.validateAndNormalizeTimestamp(i.track,t.timestamp,"key"===t.type),n=this.createSampleForTrack(i,a,o,t.duration,t.type);await this.registerSample(i,n)}finally{i()}}async addEncodedAudioPacket(e,t,r){let i=await this.mutex.acquire();try{let i=this.getAudioTrackData(e,t,r),a=t.data;if(i.info.requiresAdtsStripping){let e=(0,eY.lh)(n.x$.tempFromBytes(a));if(!e)throw Error("Expected ADTS frame, didn't get one.");let t=null===e.crcCheck?eY.gc:eY.Y$;a=a.subarray(t)}let o=this.validateAndNormalizeTimestamp(i.track,t.timestamp,"key"===t.type),s=this.createSampleForTrack(i,a,o,t.duration,t.type);i.info.requiresPcmTransformation&&await this.maybePadWithSilence(i,o),await this.registerSample(i,s)}finally{i()}}async maybePadWithSilence(e,t){let r=(0,a._g)(e.samples),o=r?r.timestamp+r.duration:0,s=t-o,n=e8(s,e.timescale);if(n>0){let{sampleSize:t,silentValue:r}=(0,i.Ei)(e.info.decoderConfig.codec),a=new Uint8Array(t*(n*e.info.numberOfChannels)).fill(r),l=this.createSampleForTrack(e,new Uint8Array(a.buffer),o,s,"key");await this.registerSample(e,l)}}async addSubtitleCue(e,t,r){let i=await this.mutex.acquire();try{let i=this.getSubtitleTrackData(e,r);this.validateAndNormalizeTimestamp(i.track,t.timestamp,!0),"webvtt"===e.source._codec&&(i.cueQueue.push(t),await this.processWebVTTCues(i,t.timestamp))}finally{i()}}async processWebVTTCues(e,t){for(;e.cueQueue.length>0;){let r=new Set([]);for(let i of e.cueQueue)(0,a.vA)(i.timestamp<=t),(0,a.vA)(e.lastCueEndTimestamp<=i.timestamp+i.duration),r.add(Math.max(i.timestamp,e.lastCueEndTimestamp)),r.add(i.timestamp+i.duration);let i=[...r].sort((e,t)=>e-t),o=i[0],s=i[1]??o;if(t<s)break;if(e.lastCueEndTimestamp<o){this.auxWriter.seek(0);let t=eR();this.auxBoxWriter.writeBox(t);let r=this.auxWriter.getSlice(0,this.auxWriter.getPos()),i=this.createSampleForTrack(e,r,e.lastCueEndTimestamp,o-e.lastCueEndTimestamp,"key");await this.registerSample(e,i),e.lastCueEndTimestamp=o}this.auxWriter.seek(0);for(let t=0;t<e.cueQueue.length;t++){let r=e.cueQueue[t];if(r.timestamp>=s)break;c.lastIndex=0;let i=c.test(r.text),a=r.timestamp+r.duration,n=e.cueToSourceId.get(r);if(void 0===n&&s<a&&(n=e.nextSourceId++,e.cueToSourceId.set(r,n)),r.notes){let e=ez(r.notes);this.auxBoxWriter.writeBox(e)}let l=eP(r.text,i?o:null,r.identifier??null,r.settings??null,n??null);this.auxBoxWriter.writeBox(l),a===s&&e.cueQueue.splice(t--,1)}let n=this.auxWriter.getSlice(0,this.auxWriter.getPos()),l=this.createSampleForTrack(e,n,o,s-o,"key");await this.registerSample(e,l),e.lastCueEndTimestamp=s}}createSampleForTrack(e,t,r,i,a){return{timestamp:r,decodeTimestamp:r,duration:i,data:t,size:t.byteLength,type:a,timescaleUnitsToNextSample:e8(i,e.timescale)}}processTimestamps(e,t){if(0===e.timestampProcessingQueue.length)return;if("audio"===e.type&&e.info.requiresPcmTransformation){let t=0;for(let r=0;r<e.timestampProcessingQueue.length;r++)t+=e8(e.timestampProcessingQueue[r].duration,e.timescale);if(0===e.timeToSampleTable.length)e.timeToSampleTable.push({sampleCount:t,sampleDelta:1});else{let r=(0,a._g)(e.timeToSampleTable);r.sampleCount+=t}e.timestampProcessingQueue.length=0;return}let r=e.timestampProcessingQueue.map(e=>e.timestamp).sort((e,t)=>e-t);for(let t=0;t<e.timestampProcessingQueue.length;t++){let i=e.timestampProcessingQueue[t];i.decodeTimestamp=r[t],this.isFragmented||null!==e.lastTimescaleUnits||(i.decodeTimestamp=0);let o=e8(i.timestamp-i.decodeTimestamp,e.timescale),s=e8(i.duration,e.timescale);if(null!==e.lastTimescaleUnits){(0,a.vA)(e.lastSample);let t=Math.round(e8(i.decodeTimestamp,e.timescale,!1)-e.lastTimescaleUnits);if((0,a.vA)(t>=0),e.lastTimescaleUnits+=t,e.lastSample.timescaleUnitsToNextSample=t,!this.isFragmented){let r=(0,a._g)(e.timeToSampleTable);if((0,a.vA)(r),1===r.sampleCount){r.sampleDelta=t;let i=e.timeToSampleTable[e.timeToSampleTable.length-2];i&&i.sampleDelta===t&&(i.sampleCount++,e.timeToSampleTable.pop(),r=i)}else r.sampleDelta!==t&&(r.sampleCount--,e.timeToSampleTable.push(r={sampleCount:1,sampleDelta:t}));r.sampleDelta===s?r.sampleCount++:e.timeToSampleTable.push({sampleCount:1,sampleDelta:s});let i=(0,a._g)(e.compositionTimeOffsetTable);(0,a.vA)(i),i.sampleCompositionTimeOffset===o?i.sampleCount++:e.compositionTimeOffsetTable.push({sampleCount:1,sampleCompositionTimeOffset:o})}}else e.lastTimescaleUnits=e8(i.decodeTimestamp,e.timescale,!1),this.isFragmented||(e.timeToSampleTable.push({sampleCount:1,sampleDelta:s}),e.compositionTimeOffsetTable.push({sampleCount:1,sampleCompositionTimeOffset:o}));e.lastSample=i}if(e.timestampProcessingQueue.length=0,(0,a.vA)(e.lastSample),(0,a.vA)(null!==e.lastTimescaleUnits),void 0!==t&&0===e.lastSample.timescaleUnitsToNextSample){(0,a.vA)("key"===t.type);let r=Math.round(e8(t.timestamp,e.timescale,!1)-e.lastTimescaleUnits);e.lastSample.timescaleUnitsToNextSample=r}}async registerSample(e,t){"key"===t.type&&this.processTimestamps(e,t),e.timestampProcessingQueue.push(t),this.isFragmented?(e.sampleQueue.push(t),await this.interleaveSamples()):"reserve"===this.fastStart?await this.registerSampleFastStartReserve(e,t):await this.addSampleToTrack(e,t)}async addSampleToTrack(e,t){if(!this.isFragmented&&(e.samples.push(t),"reserve"===this.fastStart)){let t=e.track.metadata.maximumPacketCount;if((0,a.vA)(void 0!==t),e.samples.length>t)throw Error(`Track #${e.track.id} has already reached the maximum packet count (${t}). Either add less packets or increase the maximum packet count.`)}let r=!1;if(e.currentChunk){e.currentChunk.startTimestamp=Math.min(e.currentChunk.startTimestamp,t.timestamp);let i=t.timestamp-e.currentChunk.startTimestamp;if(this.isFragmented){let a=this.trackDatas.every(r=>{if(e===r)return"key"===t.type;let i=r.sampleQueue[0];return i?"key"===i.type:r.track.source._closed});i>=this.minimumFragmentDuration&&a&&t.timestamp>this.maxWrittenTimestamp&&(r=!0,await this.finalizeFragment())}else r=i>=.5}else r=!0;r&&(e.currentChunk&&await this.finalizeCurrentChunk(e),e.currentChunk={startTimestamp:t.timestamp,samples:[],offset:null,moofOffset:null}),(0,a.vA)(e.currentChunk),e.currentChunk.samples.push(t),this.isFragmented&&(this.maxWrittenTimestamp=Math.max(this.maxWrittenTimestamp,t.timestamp))}async finalizeCurrentChunk(e){if((0,a.vA)(!this.isFragmented),!e.currentChunk)return;e.finalizedChunks.push(e.currentChunk),this.finalizedChunks.push(e.currentChunk);let t=e.currentChunk.samples.length;if("audio"===e.type&&e.info.requiresPcmTransformation&&(t=e.currentChunk.samples.reduce((t,r)=>t+e8(r.duration,e.timescale),0)),(0===e.compactlyCodedChunkTable.length||(0,a._g)(e.compactlyCodedChunkTable).samplesPerChunk!==t)&&e.compactlyCodedChunkTable.push({firstChunk:e.finalizedChunks.length,samplesPerChunk:t}),"in-memory"===this.fastStart){e.currentChunk.offset=0;return}for(let t of(e.currentChunk.offset=this.writer.getPos(),e.currentChunk.samples))(0,a.vA)(t.data),this.writer.write(t.data),t.data=null;await this.writer.flush()}async interleaveSamples(e=!1){if((0,a.vA)(this.isFragmented),e||this.allTracksAreKnown())e:for(;;){let t=null,r=1/0;for(let i of this.trackDatas){if(!e&&0===i.sampleQueue.length&&!i.track.source._closed)break e;i.sampleQueue.length>0&&i.sampleQueue[0].timestamp<r&&(t=i,r=i.sampleQueue[0].timestamp)}if(!t)break;let i=t.sampleQueue.shift();await this.addSampleToTrack(t,i)}}async finalizeFragment(e=!0){(0,a.vA)(this.isFragmented);let t=this.nextFragmentNumber++;if(1===t){this.format._options.onMoov&&this.writer.startTrackingWrites();let e=O(this);if(this.boxWriter.writeBox(e),this.format._options.onMoov){let{data:e,start:t}=this.writer.stopTrackingWrites();this.format._options.onMoov(e,t)}}let r=this.trackDatas.filter(e=>e.currentChunk),i=ek(t,r),o=this.writer.getPos(),s=o+this.boxWriter.measureBox(i),n=s+e3.ZM,l=1/0;for(let e of r){for(let t of(e.currentChunk.offset=n,e.currentChunk.moofOffset=o,e.currentChunk.samples))n+=t.size;l=Math.min(l,e.currentChunk.startTimestamp)}let c=n-s,d=c>=0x100000000;if(d)for(let e of r)e.currentChunk.offset+=e3.Xk-e3.ZM;this.format._options.onMoof&&this.writer.startTrackingWrites();let h=ek(t,r);if(this.boxWriter.writeBox(h),this.format._options.onMoof){let{data:e,start:t}=this.writer.stopTrackingWrites();this.format._options.onMoof(e,t,l)}(0,a.vA)(this.writer.getPos()===s),this.format._options.onMdat&&this.writer.startTrackingWrites();let u=I(d);for(let e of(u.size=c,this.boxWriter.writeBox(u),this.writer.seek(s+(d?e3.Xk:e3.ZM)),r))for(let t of e.currentChunk.samples)this.writer.write(t.data),t.data=null;if(this.format._options.onMdat){let{data:e,start:t}=this.writer.stopTrackingWrites();this.format._options.onMdat(e,t)}for(let e of r)e.finalizedChunks.push(e.currentChunk),this.finalizedChunks.push(e.currentChunk),e.currentChunk=null;e&&await this.writer.flush()}async registerSampleFastStartReserve(e,t){if(this.allTracksAreKnown()){if(!this.mdat){let e=O(this),t=this.boxWriter.measureBox(e)+this.computeSampleTableSizeUpperBound()+4096;for(let e of((0,a.vA)(null!==this.ftypSize),this.writer.seek(this.ftypSize+t),this.format._options.onMdat&&this.writer.startTrackingWrites(),this.mdat=I(!0),this.boxWriter.writeBox(this.mdat),this.trackDatas)){for(let t of e.sampleQueue)await this.addSampleToTrack(e,t);e.sampleQueue.length=0}}await this.addSampleToTrack(e,t)}else e.sampleQueue.push(t)}computeSampleTableSizeUpperBound(){(0,a.vA)("reserve"===this.fastStart);let e=0;for(let t of this.trackDatas){let r=t.track.metadata.maximumPacketCount;(0,a.vA)(void 0!==r),e+=8*Math.ceil(2/3*r)+4*r+8*Math.ceil(2/3*r)+12*Math.ceil(2/3*r)+4*r+8*r}return e}async onTrackClose(e){let t=await this.mutex.acquire();if("subtitle"===e.type&&"webvtt"===e.source._codec){let t=this.trackDatas.find(t=>t.track===e);t&&await this.processWebVTTCues(t,1/0)}this.allTracksAreKnown()&&this.allTracksKnown.resolve(),this.isFragmented&&await this.interleaveSamples(),t()}async finalize(){let e=await this.mutex.acquire();for(let e of(this.allTracksKnown.resolve(),this.trackDatas))"subtitle"===e.type&&"webvtt"===e.track.source._codec&&await this.processWebVTTCues(e,1/0);if(this.isFragmented){for(let e of(await this.interleaveSamples(!0),this.trackDatas))this.processTimestamps(e);await this.finalizeFragment(!1)}else for(let e of this.trackDatas)this.processTimestamps(e),await this.finalizeCurrentChunk(e);if("in-memory"===this.fastStart){let e;this.mdat=I(!1);for(let t=0;t<2;t++){let t=O(this),r=this.boxWriter.measureBox(t);e=this.boxWriter.measureBox(this.mdat);let i=this.writer.getPos()+r+e;for(let t of this.finalizedChunks)for(let{data:r}of(t.offset=i,t.samples))(0,a.vA)(r),i+=r.byteLength,e+=r.byteLength;if(i<0x100000000)break;e>=0x100000000&&(this.mdat.largeSize=!0)}this.format._options.onMoov&&this.writer.startTrackingWrites();let t=O(this);if(this.boxWriter.writeBox(t),this.format._options.onMoov){let{data:e,start:t}=this.writer.stopTrackingWrites();this.format._options.onMoov(e,t)}for(let t of(this.format._options.onMdat&&this.writer.startTrackingWrites(),this.mdat.size=e,this.boxWriter.writeBox(this.mdat),this.finalizedChunks))for(let e of t.samples)(0,a.vA)(e.data),this.writer.write(e.data),e.data=null;if(this.format._options.onMdat){let{data:e,start:t}=this.writer.stopTrackingWrites();this.format._options.onMdat(e,t)}}else if(this.isFragmented){let e=this.writer.getPos(),t=eM(this.trackDatas);this.boxWriter.writeBox(t);let r=this.writer.getPos()-e;this.writer.seek(this.writer.getPos()-4),this.boxWriter.writeU32(r)}else{(0,a.vA)(this.mdat);let e=this.boxWriter.offsets.get(this.mdat);(0,a.vA)(void 0!==e);let t=this.writer.getPos()-e;if(this.mdat.size=t,this.mdat.largeSize=t>=0x100000000,this.boxWriter.patchBox(this.mdat),this.format._options.onMdat){let{data:e,start:t}=this.writer.stopTrackingWrites();this.format._options.onMdat(e,t)}let r=O(this);if("reserve"===this.fastStart){(0,a.vA)(null!==this.ftypSize),this.writer.seek(this.ftypSize),this.format._options.onMoov&&this.writer.startTrackingWrites(),this.boxWriter.writeBox(r);let e=this.boxWriter.offsets.get(this.mdat)-this.writer.getPos();this.boxWriter.writeBox(L(e))}else this.format._options.onMoov&&this.writer.startTrackingWrites(),this.boxWriter.writeBox(r);if(this.format._options.onMoov){let{data:e,start:t}=this.writer.stopTrackingWrites();this.format._options.onMoov(e,t)}}e()}}var e7=r(4747),e9=r(662);let te="Mediabunny",tt={video:1,audio:2,subtitle:17};class tr extends o{constructor(e,t){super(e),this.trackDatas=[],this.allTracksKnown=(0,a.nJ)(),this.segment=null,this.segmentInfo=null,this.seekHead=null,this.tracksElement=null,this.tagsElement=null,this.attachmentsElement=null,this.segmentDuration=null,this.cues=null,this.currentCluster=null,this.currentClusterStartMsTimestamp=null,this.currentClusterMaxMsTimestamp=null,this.trackDatasInCurrentCluster=new Map,this.duration=0,this.writer=e._writer,this.format=t,this.ebmlWriter=new e7.Qn(this.writer),this.format._options.appendOnly&&(this.writer.ensureMonotonicity=!0)}async start(){let e=await this.mutex.acquire();this.writeEBMLHeader(),this.createSegmentInfo(),this.createCues(),await this.writer.flush(),e()}writeEBMLHeader(){this.format._options.onEbmlHeader&&this.writer.startTrackingWrites();let e={id:e7.Cl.EBML,data:[{id:e7.Cl.EBMLVersion,data:1},{id:e7.Cl.EBMLReadVersion,data:1},{id:e7.Cl.EBMLMaxIDLength,data:4},{id:e7.Cl.EBMLMaxSizeLength,data:8},{id:e7.Cl.DocType,data:this.format instanceof td?"webm":"matroska"},{id:e7.Cl.DocTypeVersion,data:2},{id:e7.Cl.DocTypeReadVersion,data:2}]};if(this.ebmlWriter.writeEBML(e),this.format._options.onEbmlHeader){let{data:e,start:t}=this.writer.stopTrackingWrites();this.format._options.onEbmlHeader(e,t)}}maybeCreateSeekHead(e){if(this.format._options.appendOnly)return;let t=new Uint8Array([28,83,187,107]),r=new Uint8Array([21,73,169,102]),i=new Uint8Array([22,84,174,107]),a=new Uint8Array([25,65,164,105]),o=new Uint8Array([18,84,195,103]),s={id:e7.Cl.SeekHead,data:[{id:e7.Cl.Seek,data:[{id:e7.Cl.SeekID,data:t},{id:e7.Cl.SeekPosition,size:5,data:e?this.ebmlWriter.offsets.get(this.cues)-this.segmentDataOffset:0}]},{id:e7.Cl.Seek,data:[{id:e7.Cl.SeekID,data:r},{id:e7.Cl.SeekPosition,size:5,data:e?this.ebmlWriter.offsets.get(this.segmentInfo)-this.segmentDataOffset:0}]},{id:e7.Cl.Seek,data:[{id:e7.Cl.SeekID,data:i},{id:e7.Cl.SeekPosition,size:5,data:e?this.ebmlWriter.offsets.get(this.tracksElement)-this.segmentDataOffset:0}]},this.attachmentsElement?{id:e7.Cl.Seek,data:[{id:e7.Cl.SeekID,data:a},{id:e7.Cl.SeekPosition,size:5,data:e?this.ebmlWriter.offsets.get(this.attachmentsElement)-this.segmentDataOffset:0}]}:null,this.tagsElement?{id:e7.Cl.Seek,data:[{id:e7.Cl.SeekID,data:o},{id:e7.Cl.SeekPosition,size:5,data:e?this.ebmlWriter.offsets.get(this.tagsElement)-this.segmentDataOffset:0}]}:null]};this.seekHead=s}createSegmentInfo(){let e={id:e7.Cl.Duration,data:new e7.Z4(0)};this.segmentDuration=e;let t={id:e7.Cl.Info,data:[{id:e7.Cl.TimestampScale,data:1e6},{id:e7.Cl.MuxingApp,data:te},{id:e7.Cl.WritingApp,data:te},this.format._options.appendOnly?null:e]};this.segmentInfo=t}createTracks(){let e={id:e7.Cl.Tracks,data:[]};for(let t of(this.tracksElement=e,this.trackDatas)){let r=e7.oo[t.track.source._codec];(0,a.vA)(r);let o=0;if("audio"===t.type&&"opus"===t.track.source._codec){o=1e6*80;let e=t.info.decoderConfig.description;if(e){let t=(0,a.Fo)(e);o=Math.round(1e9*((0,s.Qf)(t).preSkip/i.yo))}}e.data.push({id:e7.Cl.TrackEntry,data:[{id:e7.Cl.TrackNumber,data:t.track.id},{id:e7.Cl.TrackUID,data:t.track.id},{id:e7.Cl.TrackType,data:tt[t.type]},t.track.metadata.disposition?.default===!1?{id:e7.Cl.FlagDefault,data:0}:null,t.track.metadata.disposition?.forced?{id:e7.Cl.FlagForced,data:1}:null,t.track.metadata.disposition?.hearingImpaired?{id:e7.Cl.FlagHearingImpaired,data:1}:null,t.track.metadata.disposition?.visuallyImpaired?{id:e7.Cl.FlagVisualImpaired,data:1}:null,t.track.metadata.disposition?.original?{id:e7.Cl.FlagOriginal,data:1}:null,t.track.metadata.disposition?.commentary?{id:e7.Cl.FlagCommentary,data:1}:null,{id:e7.Cl.FlagLacing,data:0},{id:e7.Cl.Language,data:t.track.metadata.languageCode??a.IR},{id:e7.Cl.CodecID,data:r},{id:e7.Cl.CodecDelay,data:0},{id:e7.Cl.SeekPreRoll,data:o},void 0!==t.track.metadata.name?{id:e7.Cl.Name,data:new e7.lT(t.track.metadata.name)}:null,"video"===t.type?this.videoSpecificTrackInfo(t):null,"audio"===t.type?this.audioSpecificTrackInfo(t):null,"subtitle"===t.type?this.subtitleSpecificTrackInfo(t):null]})}}videoSpecificTrackInfo(e){let{frameRate:t,rotation:r}=e.track.metadata,i=[e.info.decoderConfig.description?{id:e7.Cl.CodecPrivate,data:(0,a.Fo)(e.info.decoderConfig.description)}:null,t?{id:e7.Cl.DefaultDuration,data:1e9/t}:null],o=r?(0,a.qT)(-r):0,s=e.info.decoderConfig.colorSpace;return i.push({id:e7.Cl.Video,data:[{id:e7.Cl.PixelWidth,data:e.info.width},{id:e7.Cl.PixelHeight,data:e.info.height},e.info.alphaMode?{id:e7.Cl.AlphaMode,data:1}:null,(0,a.HV)(s)?{id:e7.Cl.Colour,data:[{id:e7.Cl.MatrixCoefficients,data:a.Au[s.matrix]},{id:e7.Cl.TransferCharacteristics,data:a.uN[s.transfer]},{id:e7.Cl.Primaries,data:a.wd[s.primaries]},{id:e7.Cl.Range,data:s.fullRange?2:1}]}:null,o?{id:e7.Cl.Projection,data:[{id:e7.Cl.ProjectionType,data:0},{id:e7.Cl.ProjectionPoseRoll,data:new e7._v((o+180)%360-180)}]}:null]}),i}audioSpecificTrackInfo(e){let t=i.Wq.includes(e.track.source._codec)?(0,i.Ei)(e.track.source._codec):null;return[e.info.decoderConfig.description?{id:e7.Cl.CodecPrivate,data:(0,a.Fo)(e.info.decoderConfig.description)}:null,{id:e7.Cl.Audio,data:[{id:e7.Cl.SamplingFrequency,data:new e7._v(e.info.sampleRate)},{id:e7.Cl.Channels,data:e.info.numberOfChannels},t?{id:e7.Cl.BitDepth,data:8*t.sampleSize}:null]}]}subtitleSpecificTrackInfo(e){return[{id:e7.Cl.CodecPrivate,data:a.UG.encode(e.info.config.description)}]}maybeCreateTags(){let e=[],t=(t,r)=>{e.push({id:e7.Cl.SimpleTag,data:[{id:e7.Cl.TagName,data:new e7.lT(t)},"string"==typeof r?{id:e7.Cl.TagString,data:new e7.lT(r)}:{id:e7.Cl.TagBinary,data:r}]})},r=this.output._metadataTags,i=new Set;for(let{key:e,value:o}of(0,a.rk)(r))switch(e){case"title":t("TITLE",o),i.add("TITLE");break;case"description":t("DESCRIPTION",o),i.add("DESCRIPTION");break;case"artist":t("ARTIST",o),i.add("ARTIST");break;case"album":t("ALBUM",o),i.add("ALBUM");break;case"albumArtist":t("ALBUM_ARTIST",o),i.add("ALBUM_ARTIST");break;case"genre":t("GENRE",o),i.add("GENRE");break;case"comment":t("COMMENT",o),i.add("COMMENT");break;case"lyrics":t("LYRICS",o),i.add("LYRICS");break;case"date":t("DATE",o.toISOString().slice(0,10)),i.add("DATE");break;case"trackNumber":t("PART_NUMBER",void 0!==r.tracksTotal?`${o}/${r.tracksTotal}`:o.toString()),i.add("PART_NUMBER");break;case"discNumber":t("DISC",void 0!==r.discsTotal?`${o}/${r.discsTotal}`:o.toString()),i.add("DISC");break;case"tracksTotal":case"discsTotal":case"images":case"raw":break;default:(0,a.xb)(e)}if(r.raw)for(let e in r.raw){let a=r.raw[e];!(null==a||i.has(e))&&("string"==typeof a||a instanceof Uint8Array)&&t(e,a)}0!==e.length&&(this.tagsElement={id:e7.Cl.Tags,data:[{id:e7.Cl.Tag,data:[{id:e7.Cl.Targets,data:[{id:e7.Cl.TargetTypeValue,data:50},{id:e7.Cl.TargetType,data:"MOVIE"}]},...e]}]})}maybeCreateAttachments(){let e=this.output._metadataTags,t=[],r=new Set,i=e.images??[];for(let e of i){let i,o=e.name;for(void 0===o&&(o=("coverFront"===e.kind?"cover":"coverBack"===e.kind?"back":"image")+((0,a.sX)(e.mimeType)??""));;){i=0n;for(let e=0;e<8;e++)i<<=8n,i|=BigInt(Math.floor(256*Math.random()));if(0n!==i&&!r.has(i))break}r.add(i),t.push({id:e7.Cl.AttachedFile,data:[void 0!==e.description?{id:e7.Cl.FileDescription,data:new e7.lT(e.description)}:null,{id:e7.Cl.FileName,data:new e7.lT(o)},{id:e7.Cl.FileMediaType,data:e.mimeType},{id:e7.Cl.FileData,data:e.data},{id:e7.Cl.FileUID,data:i}]})}for(let[r,o]of Object.entries(e.raw??{}))!(!(o instanceof l.VF)||!/^\d+$/.test(r)||i.find(e=>e.mimeType===o.mimeType&&(0,a.ju)(e.data,o.data)))&&t.push({id:e7.Cl.AttachedFile,data:[void 0!==o.description?{id:e7.Cl.FileDescription,data:new e7.lT(o.description)}:null,{id:e7.Cl.FileName,data:new e7.lT(o.name??"")},{id:e7.Cl.FileMediaType,data:o.mimeType??""},{id:e7.Cl.FileData,data:o.data},{id:e7.Cl.FileUID,data:BigInt(r)}]});0!==t.length&&(this.attachmentsElement={id:e7.Cl.Attachments,data:t})}createSegment(){this.createTracks(),this.maybeCreateTags(),this.maybeCreateAttachments(),this.maybeCreateSeekHead(!1);let e={id:e7.Cl.Segment,size:this.format._options.appendOnly?-1:6,data:[this.seekHead,this.segmentInfo,this.tracksElement,this.attachmentsElement,this.tagsElement]};if(this.segment=e,this.format._options.onSegmentHeader&&this.writer.startTrackingWrites(),this.ebmlWriter.writeEBML(e),this.format._options.onSegmentHeader){let{data:e,start:t}=this.writer.stopTrackingWrites();this.format._options.onSegmentHeader(e,t)}}createCues(){this.cues={id:e7.Cl.Cues,data:[]}}get segmentDataOffset(){return(0,a.vA)(this.segment),this.ebmlWriter.dataOffsets.get(this.segment)}allTracksAreKnown(){for(let e of this.output._tracks)if(!e.source._closed&&!this.trackDatas.some(t=>t.track===e))return!1;return!0}async getMimeType(){await this.allTracksKnown.promise;let e=this.trackDatas.map(e=>"video"===e.type?e.info.decoderConfig.codec:"audio"===e.type?e.info.decoderConfig.codec:({webvtt:"wvtt"})[e.track.source._codec]);return(0,e9.V)({isWebM:this.format instanceof td,hasVideo:this.trackDatas.some(e=>"video"===e.type),hasAudio:this.trackDatas.some(e=>"audio"===e.type),codecStrings:e})}getVideoTrackData(e,t,r){let o=this.trackDatas.find(t=>t.track===e);if(o)return o;(0,i.aF)(r),(0,a.vA)(r),(0,a.vA)(r.decoderConfig),(0,a.vA)(void 0!==r.decoderConfig.codedWidth),(0,a.vA)(void 0!==r.decoderConfig.codedHeight);let s={track:e,type:"video",info:{width:r.decoderConfig.codedWidth,height:r.decoderConfig.codedHeight,decoderConfig:r.decoderConfig,alphaMode:!!t.sideData.alpha},chunkQueue:[],lastWrittenMsTimestamp:null};return"vp9"===e.source._codec?s.info.decoderConfig={...s.info.decoderConfig,description:new Uint8Array((0,i.mD)(s.info.decoderConfig.codec))}:"av1"===e.source._codec&&(s.info.decoderConfig={...s.info.decoderConfig,description:new Uint8Array((0,i.DC)(s.info.decoderConfig.codec))}),this.trackDatas.push(s),this.trackDatas.sort((e,t)=>e.track.id-t.track.id),this.allTracksAreKnown()&&this.allTracksKnown.resolve(),s}getAudioTrackData(e,t,r){let o=this.trackDatas.find(t=>t.track===e);if(o)return o;(0,i.P7)(r),(0,a.vA)(r),(0,a.vA)(r.decoderConfig);let s={...r.decoderConfig},l=!1;if("aac"===e.source._codec&&!s.description){let e=(0,eY.lh)(n.x$.tempFromBytes(t.data));if(!e)throw Error("Couldn't parse ADTS header from the AAC packet. Make sure the packets are in ADTS format (as specified in ISO 13818-7) when not providing a description, or provide a description (must be an AudioSpecificConfig as specified in ISO 14496-3) and ensure the packets are raw AAC data.");let r=i.Im[e.samplingFrequencyIndex],a=i.Ti[e.channelConfiguration];if(void 0===r||void 0===a)throw Error("Invalid ADTS frame header.");s.description=(0,i.Wz)({objectType:e.objectType,sampleRate:r,numberOfChannels:a}),l=!0}let c={track:e,type:"audio",info:{numberOfChannels:r.decoderConfig.numberOfChannels,sampleRate:r.decoderConfig.sampleRate,decoderConfig:s,requiresAdtsStripping:l},chunkQueue:[],lastWrittenMsTimestamp:null};return this.trackDatas.push(c),this.trackDatas.sort((e,t)=>e.track.id-t.track.id),this.allTracksAreKnown()&&this.allTracksKnown.resolve(),c}getSubtitleTrackData(e,t){let r=this.trackDatas.find(t=>t.track===e);if(r)return r;(0,i.GL)(t),(0,a.vA)(t),(0,a.vA)(t.config);let o={track:e,type:"subtitle",info:{config:t.config},chunkQueue:[],lastWrittenMsTimestamp:null};return this.trackDatas.push(o),this.trackDatas.sort((e,t)=>e.track.id-t.track.id),this.allTracksAreKnown()&&this.allTracksKnown.resolve(),o}async addEncodedVideoPacket(e,t,r){let i=await this.mutex.acquire();try{let i=this.getVideoTrackData(e,t,r),o="key"===t.type,s=this.validateAndNormalizeTimestamp(i.track,t.timestamp,o),n=t.duration;void 0!==e.metadata.frameRate&&(s=(0,a.in)(s,1/e.metadata.frameRate),n=(0,a.in)(n,1/e.metadata.frameRate));let l=i.info.alphaMode?t.sideData.alpha??null:null,c=this.createInternalChunk(t.data,s,n,t.type,l);"vp9"===e.source._codec&&this.fixVP9ColorSpace(i,c),i.chunkQueue.push(c),await this.interleaveChunks()}finally{i()}}async addEncodedAudioPacket(e,t,r){let i=await this.mutex.acquire();try{let i=this.getAudioTrackData(e,t,r),a=t.data;if(i.info.requiresAdtsStripping){let e=(0,eY.lh)(n.x$.tempFromBytes(a));if(!e)throw Error("Expected ADTS frame, didn't get one.");let t=null===e.crcCheck?eY.gc:eY.Y$;a=a.subarray(t)}let o="key"===t.type,s=this.validateAndNormalizeTimestamp(i.track,t.timestamp,o),l=this.createInternalChunk(a,s,t.duration,t.type);i.chunkQueue.push(l),await this.interleaveChunks()}finally{i()}}async addSubtitleCue(e,t,r){let i=await this.mutex.acquire();try{let i=this.getSubtitleTrackData(e,r),o=this.validateAndNormalizeTimestamp(i.track,t.timestamp,!0),s=t.text,n=Math.round(1e3*o);c.lastIndex=0,s=s.replace(c,e=>{let t=h(e.slice(1,-1));return`<${u(t-n)}>`});let l=a.UG.encode(s),d=`${t.settings??""}
${t.identifier??""}
${t.notes??""}`,m=this.createInternalChunk(l,o,t.duration,"key",d.trim()?a.UG.encode(d):null);i.chunkQueue.push(m),await this.interleaveChunks()}finally{i()}}async interleaveChunks(e=!1){if(e||this.allTracksAreKnown()){e:for(;;){let t=null,r=1/0;for(let i of this.trackDatas){if(!e&&0===i.chunkQueue.length&&!i.track.source._closed)break e;i.chunkQueue.length>0&&i.chunkQueue[0].timestamp<r&&(t=i,r=i.chunkQueue[0].timestamp)}if(!t)break;let i=t.chunkQueue.shift();this.writeBlock(t,i)}e||await this.writer.flush()}}fixVP9ColorSpace(e,t){if("key"!==t.type||!e.info.decoderConfig.colorSpace||!e.info.decoderConfig.colorSpace.matrix)return;let r=new a._c(t.data);r.skipBits(2);let i=r.readBits(1),o=(r.readBits(1)<<1)+i;if(3===o&&r.skipBits(1),r.readBits(1)||0!==r.readBits(1)||(r.skipBits(2),4817730!==r.readBits(24)))return;o>=2&&r.skipBits(1);let s={rgb:7,bt709:2,bt470bg:1,smpte170m:3}[e.info.decoderConfig.colorSpace.matrix];(0,a.Wo)(t.data,r.pos,r.pos+3,s)}createInternalChunk(e,t,r,i,a=null){return{data:e,type:i,timestamp:t,duration:r,additions:a}}writeBlock(e,t){this.segment||this.createSegment();let r=Math.round(1e3*t.timestamp),i=this.trackDatas.every(r=>{if(e===r)return"key"===t.type;let i=r.chunkQueue[0];return i?"key"===i.type:r.track.source._closed}),o=!1;if(this.currentCluster){(0,a.vA)(null!==this.currentClusterStartMsTimestamp),(0,a.vA)(null!==this.currentClusterMaxMsTimestamp);let e=r-this.currentClusterStartMsTimestamp;o=i&&r>this.currentClusterMaxMsTimestamp&&e>=1e3*(this.format._options.minimumClusterDuration??1)||e>32767}else o=!0;o&&this.createNewCluster(r);let s=r-this.currentClusterStartMsTimestamp;if(s<-32768)return;let n=new Uint8Array(4),l=new DataView(n.buffer);l.setUint8(0,128|e.track.id),l.setInt16(1,s,!1);let c=Math.round(1e3*t.duration);if(t.additions){let i={id:e7.Cl.BlockGroup,data:[{id:e7.Cl.Block,data:[n,t.data]},"delta"===t.type?{id:e7.Cl.ReferenceBlock,data:new e7.ys(e.lastWrittenMsTimestamp-r)}:null,t.additions?{id:e7.Cl.BlockAdditions,data:[{id:e7.Cl.BlockMore,data:[{id:e7.Cl.BlockAddID,data:1},{id:e7.Cl.BlockAdditional,data:t.additions}]}]}:null,c>0?{id:e7.Cl.BlockDuration,data:c}:null]};this.ebmlWriter.writeEBML(i)}else{l.setUint8(3,Number("key"===t.type)<<7);let e={id:e7.Cl.SimpleBlock,data:[n,t.data]};this.ebmlWriter.writeEBML(e)}this.duration=Math.max(this.duration,r+c),e.lastWrittenMsTimestamp=r,this.trackDatasInCurrentCluster.has(e)||this.trackDatasInCurrentCluster.set(e,{firstMsTimestamp:r}),this.currentClusterMaxMsTimestamp=Math.max(this.currentClusterMaxMsTimestamp,r)}createNewCluster(e){this.currentCluster&&this.finalizeCurrentCluster(),this.format._options.onCluster&&this.writer.startTrackingWrites(),this.currentCluster={id:e7.Cl.Cluster,size:this.format._options.appendOnly?-1:5,data:[{id:e7.Cl.Timestamp,data:e}]},this.ebmlWriter.writeEBML(this.currentCluster),this.currentClusterStartMsTimestamp=e,this.currentClusterMaxMsTimestamp=e,this.trackDatasInCurrentCluster.clear()}finalizeCurrentCluster(){if((0,a.vA)(this.currentCluster),!this.format._options.appendOnly){let e=this.writer.getPos()-this.ebmlWriter.dataOffsets.get(this.currentCluster),t=this.writer.getPos();this.writer.seek(this.ebmlWriter.offsets.get(this.currentCluster)+4),this.ebmlWriter.writeVarInt(e,5),this.writer.seek(t)}if(this.format._options.onCluster){(0,a.vA)(null!==this.currentClusterStartMsTimestamp);let{data:e,start:t}=this.writer.stopTrackingWrites();this.format._options.onCluster(e,t,this.currentClusterStartMsTimestamp/1e3)}let e=this.ebmlWriter.offsets.get(this.currentCluster)-this.segmentDataOffset,t=new Map;for(let[e,{firstMsTimestamp:r}]of this.trackDatasInCurrentCluster)t.has(r)||t.set(r,[]),t.get(r).push(e);for(let[r,i]of[...t.entries()].sort((e,t)=>e[0]-t[0]))(0,a.vA)(this.cues),this.cues.data.push({id:e7.Cl.CuePoint,data:[{id:e7.Cl.CueTime,data:r},...i.map(t=>({id:e7.Cl.CueTrackPositions,data:[{id:e7.Cl.CueTrack,data:t.track.id},{id:e7.Cl.CueClusterPosition,data:e}]}))]})}async onTrackClose(){let e=await this.mutex.acquire();this.allTracksAreKnown()&&this.allTracksKnown.resolve(),await this.interleaveChunks(),e()}async finalize(){let e=await this.mutex.acquire();if(this.allTracksKnown.resolve(),this.segment||this.createSegment(),await this.interleaveChunks(!0),this.currentCluster&&this.finalizeCurrentCluster(),(0,a.vA)(this.cues),this.ebmlWriter.writeEBML(this.cues),!this.format._options.appendOnly){let e=this.writer.getPos(),t=this.writer.getPos()-this.segmentDataOffset;this.writer.seek(this.ebmlWriter.offsets.get(this.segment)+4),this.ebmlWriter.writeVarInt(t,6),this.segmentDuration.data=new e7.Z4(this.duration),this.writer.seek(this.ebmlWriter.offsets.get(this.segmentDuration)),this.ebmlWriter.writeEBML(this.segmentDuration),(0,a.vA)(this.seekHead),this.writer.seek(this.ebmlWriter.offsets.get(this.seekHead)),this.maybeCreateSeekHead(!0),this.ebmlWriter.writeEBML(this.seekHead),this.writer.seek(e)}e()}}r(4700),r(9044),r(7408),r(8195),r(5296),new Uint8Array([9,240]),new Uint8Array([70,1]);let ti=new Uint32Array(256);for(let e=0;e<256;e++){let t=e<<24;for(let e=0;e<8;e++)t=0x80000000&t?t<<1^0x4c11db7:t<<1;ti[e]=t>>>0&0xffffffff}let ta=new Uint8Array(16);{let e=(0,a.Zc)(ta);ta[0]=0,e.setUint16(1,45069,!1),e.setUint16(3,1,!1),ta[5]=193,ta[6]=0,ta[7]=0,e.setUint16(8,1,!1),e.setUint16(10,61440,!1),e.setUint32(12,(e=>{let t=0xffffffff;for(let r=0;r<e.length;r++)t=(t<<8^ti[t>>>24^e[r]])>>>0;return t})(ta.subarray(0,12)),!1)}r(3520);class to{getSupportedVideoCodecs(){return this.getSupportedCodecs().filter(e=>i.WN.includes(e))}getSupportedAudioCodecs(){return this.getSupportedCodecs().filter(e=>i.PP.includes(e))}getSupportedSubtitleCodecs(){return this.getSupportedCodecs().filter(e=>i.VW.includes(e))}_codecUnsupportedHint(e){return""}}class ts extends to{constructor(e={}){if(!e||"object"!=typeof e)throw TypeError("options must be an object.");if(void 0!==e.fastStart&&![!1,"in-memory","reserve","fragmented"].includes(e.fastStart))throw TypeError("options.fastStart, when provided, must be false, 'in-memory', 'reserve', or 'fragmented'.");if(void 0!==e.minimumFragmentDuration&&(!Number.isFinite(e.minimumFragmentDuration)||e.minimumFragmentDuration<0))throw TypeError("options.minimumFragmentDuration, when provided, must be a non-negative number.");if(void 0!==e.onFtyp&&"function"!=typeof e.onFtyp)throw TypeError("options.onFtyp, when provided, must be a function.");if(void 0!==e.onMoov&&"function"!=typeof e.onMoov)throw TypeError("options.onMoov, when provided, must be a function.");if(void 0!==e.onMdat&&"function"!=typeof e.onMdat)throw TypeError("options.onMdat, when provided, must be a function.");if(void 0!==e.onMoof&&"function"!=typeof e.onMoof)throw TypeError("options.onMoof, when provided, must be a function.");if(void 0!==e.metadataFormat&&!["mdir","mdta","udta","auto"].includes(e.metadataFormat))throw TypeError("options.metadataFormat, when provided, must be either 'auto', 'mdir', 'mdta', or 'udta'.");super(),this._options=e}getSupportedTrackCounts(){return{video:{min:0,max:0x100000000-1},audio:{min:0,max:0x100000000-1},subtitle:{min:0,max:0x100000000-1},total:{min:1,max:0x100000000-1}}}get supportsVideoRotationMetadata(){return!0}_createMuxer(e){return new e5(e,this)}}class tn extends ts{constructor(e){super(e)}get _name(){return"MP4"}get fileExtension(){return".mp4"}get mimeType(){return"video/mp4"}getSupportedCodecs(){return[...i.WN,...i.YB,"pcm-s16","pcm-s16be","pcm-s24","pcm-s24be","pcm-s32","pcm-s32be","pcm-f32","pcm-f32be","pcm-f64","pcm-f64be",...i.VW]}_codecUnsupportedHint(e){return new tl().getSupportedCodecs().includes(e)?" Switching to MOV will grant support for this codec.":""}}class tl extends ts{constructor(e){super(e)}get _name(){return"MOV"}get fileExtension(){return".mov"}get mimeType(){return"video/quicktime"}getSupportedCodecs(){return[...i.WN,...i.PP]}_codecUnsupportedHint(e){return new tn().getSupportedCodecs().includes(e)?" Switching to MP4 will grant support for this codec.":""}}class tc extends to{constructor(e={}){if(!e||"object"!=typeof e)throw TypeError("options must be an object.");if(void 0!==e.appendOnly&&"boolean"!=typeof e.appendOnly)throw TypeError("options.appendOnly, when provided, must be a boolean.");if(void 0!==e.minimumClusterDuration&&(!Number.isFinite(e.minimumClusterDuration)||e.minimumClusterDuration<0))throw TypeError("options.minimumClusterDuration, when provided, must be a non-negative number.");if(void 0!==e.onEbmlHeader&&"function"!=typeof e.onEbmlHeader)throw TypeError("options.onEbmlHeader, when provided, must be a function.");if(void 0!==e.onSegmentHeader&&"function"!=typeof e.onSegmentHeader)throw TypeError("options.onHeader, when provided, must be a function.");if(void 0!==e.onCluster&&"function"!=typeof e.onCluster)throw TypeError("options.onCluster, when provided, must be a function.");super(),this._options=e}_createMuxer(e){return new tr(e,this)}get _name(){return"Matroska"}getSupportedTrackCounts(){return{video:{min:0,max:127},audio:{min:0,max:127},subtitle:{min:0,max:127},total:{min:1,max:127}}}get fileExtension(){return".mkv"}get mimeType(){return"video/x-matroska"}getSupportedCodecs(){return[...i.WN,...i.YB,...i.Wq.filter(e=>!["pcm-s8","pcm-f32be","pcm-f64be","ulaw","alaw"].includes(e)),...i.VW]}get supportsVideoRotationMetadata(){return!1}}class td extends tc{constructor(e){super(e)}getSupportedCodecs(){return[...i.WN.filter(e=>["vp8","vp9","av1"].includes(e)),...i.PP.filter(e=>["opus","vorbis"].includes(e)),...i.VW]}get _name(){return"WebM"}get fileExtension(){return".webm"}get mimeType(){return"video/webm"}_codecUnsupportedHint(e){return new tc().getSupportedCodecs().includes(e)?" Switching to MKV will grant support for this codec.":""}}var th=r(2925);let tu=e=>{if(!e||"object"!=typeof e)throw TypeError("Encoding config must be an object.");if(!i.WN.includes(e.codec))throw TypeError(`Invalid video codec '${e.codec}'. Must be one of: ${i.WN.join(", ")}.`);if(!(e.bitrate instanceof tb)&&(!Number.isInteger(e.bitrate)||e.bitrate<=0))throw TypeError("config.bitrate must be a positive integer or a quality.");if(void 0!==e.keyFrameInterval&&(!Number.isFinite(e.keyFrameInterval)||e.keyFrameInterval<0))throw TypeError("config.keyFrameInterval, when provided, must be a non-negative number.");if(void 0!==e.sizeChangeBehavior&&!["deny","passThrough","fill","contain","cover"].includes(e.sizeChangeBehavior))throw TypeError("config.sizeChangeBehavior, when provided, must be 'deny', 'passThrough', 'fill', 'contain' or 'cover'.");if(void 0!==e.onEncodedPacket&&"function"!=typeof e.onEncodedPacket)throw TypeError("config.onEncodedChunk, when provided, must be a function.");if(void 0!==e.onEncoderConfig&&"function"!=typeof e.onEncoderConfig)throw TypeError("config.onEncoderConfig, when provided, must be a function.");tm(e.codec,e)},tm=(e,t)=>{if(!t||"object"!=typeof t)throw TypeError("Encoding options must be an object.");if(void 0!==t.alpha&&!["discard","keep"].includes(t.alpha))throw TypeError("options.alpha, when provided, must be 'discard' or 'keep'.");if(void 0!==t.bitrateMode&&!["constant","variable"].includes(t.bitrateMode))throw TypeError("bitrateMode, when provided, must be 'constant' or 'variable'.");if(void 0!==t.latencyMode&&!["quality","realtime"].includes(t.latencyMode))throw TypeError("latencyMode, when provided, must be 'quality' or 'realtime'.");if(void 0!==t.fullCodecString&&"string"!=typeof t.fullCodecString)throw TypeError("fullCodecString, when provided, must be a string.");if(void 0!==t.fullCodecString&&(0,i.oU)(t.fullCodecString)!==e)throw TypeError(`fullCodecString, when provided, must be a string that matches the specified codec (${e}).`);if(void 0!==t.hardwareAcceleration&&!["no-preference","prefer-hardware","prefer-software"].includes(t.hardwareAcceleration))throw TypeError("hardwareAcceleration, when provided, must be 'no-preference', 'prefer-hardware' or 'prefer-software'.");if(void 0!==t.scalabilityMode&&"string"!=typeof t.scalabilityMode)throw TypeError("scalabilityMode, when provided, must be a string.");if(void 0!==t.contentHint&&"string"!=typeof t.contentHint)throw TypeError("contentHint, when provided, must be a string.")},tf=e=>{let t=e.bitrate instanceof tb?e.bitrate._toVideoBitrate(e.codec,e.width,e.height):e.bitrate;return{codec:e.fullCodecString??(0,i.j7)(e.codec,e.width,e.height,t),width:e.width,height:e.height,bitrate:t,bitrateMode:e.bitrateMode,alpha:e.alpha??"discard",framerate:e.framerate,latencyMode:e.latencyMode,hardwareAcceleration:e.hardwareAcceleration,scalabilityMode:e.scalabilityMode,contentHint:e.contentHint,...(0,i.Rc)(e.codec)}},tp=e=>{if(!e||"object"!=typeof e)throw TypeError("Encoding config must be an object.");if(!i.PP.includes(e.codec))throw TypeError(`Invalid audio codec '${e.codec}'. Must be one of: ${i.PP.join(", ")}.`);if(void 0===e.bitrate&&(!i.Wq.includes(e.codec)||"flac"===e.codec))throw TypeError("config.bitrate must be provided for compressed audio codecs.");if(void 0!==e.bitrate&&!(e.bitrate instanceof tb)&&(!Number.isInteger(e.bitrate)||e.bitrate<=0))throw TypeError("config.bitrate, when provided, must be a positive integer or a quality.");if(void 0!==e.onEncodedPacket&&"function"!=typeof e.onEncodedPacket)throw TypeError("config.onEncodedChunk, when provided, must be a function.");if(void 0!==e.onEncoderConfig&&"function"!=typeof e.onEncoderConfig)throw TypeError("config.onEncoderConfig, when provided, must be a function.");tg(e.codec,e)},tg=(e,t)=>{if(!t||"object"!=typeof t)throw TypeError("Encoding options must be an object.");if(void 0!==t.bitrateMode&&!["constant","variable"].includes(t.bitrateMode))throw TypeError("bitrateMode, when provided, must be 'constant' or 'variable'.");if(void 0!==t.fullCodecString&&"string"!=typeof t.fullCodecString)throw TypeError("fullCodecString, when provided, must be a string.");if(void 0!==t.fullCodecString&&(0,i.oU)(t.fullCodecString)!==e)throw TypeError(`fullCodecString, when provided, must be a string that matches the specified codec (${e}).`)},tw=e=>{let t=e.bitrate instanceof tb?e.bitrate._toAudioBitrate(e.codec):e.bitrate;return{codec:e.fullCodecString??(0,i.KZ)(e.codec,e.numberOfChannels,e.sampleRate),numberOfChannels:e.numberOfChannels,sampleRate:e.sampleRate,bitrate:t,bitrateMode:e.bitrateMode,...(0,i.IJ)(e.codec)}};class tb{constructor(e){this._factor=e}_toVideoBitrate(e,t,r){return 1e3*Math.ceil(3e6*Math.pow(t*r/2073600,.95)*({avc:1,hevc:.6,vp9:.6,av1:.4,vp8:1.2})[e]*this._factor/1e3)}_toAudioBitrate(e){if(i.Wq.includes(e)||"flac"===e)return;let t={aac:128e3,opus:64e3,mp3:16e4,vorbis:64e3}[e];if(!t)throw Error(`Unhandled codec: ${e}`);let r=t*this._factor;return"aac"===e?r=[96e3,128e3,16e4,192e3].reduce((e,t)=>Math.abs(t-r)<Math.abs(e-r)?t:e):"opus"===e||"vorbis"===e?r=Math.max(6e3,r):"mp3"===e&&(r=[8e3,16e3,24e3,32e3,4e4,48e3,64e3,8e4,96e3,112e3,128e3,16e4,192e3,224e3,256e3,32e4].reduce((e,t)=>Math.abs(t-r)<Math.abs(e-r)?t:e)),1e3*Math.round(r/1e3)}}let ty=new tb(.3),tk=new tb(.6),tv=new tb(1),tC=new tb(2),tT=new tb(4),tx=async(e,t={})=>{let{numberOfChannels:r=2,sampleRate:a=48e3,bitrate:o=128e3,...s}=t;if(!i.PP.includes(e))return!1;if(!Number.isInteger(r)||r<=0)throw TypeError("numberOfChannels must be a positive integer.");if(!Number.isInteger(a)||a<=0)throw TypeError("sampleRate must be a positive integer.");if(!(o instanceof tb)&&(!Number.isInteger(o)||o<=0))throw TypeError("bitrate must be a positive integer.");tg(e,s);let n=null;return!!(th.Lr.length>0&&(n??=tw({codec:e,numberOfChannels:r,sampleRate:a,bitrate:o,...s}),th.Lr.some(t=>t.supports(e,n)))||i.Wq.includes(e))||"undefined"!=typeof AudioEncoder&&(n??=tw({codec:e,numberOfChannels:r,sampleRate:a,bitrate:o,...s}),!0===(await AudioEncoder.isConfigSupported(n)).supported)};var tE=r(697),tS=r(5356),tM=r(3722),tA=r(7914),t_=r(5854);class tR{constructor(){this._connectedTrack=null,this._closingPromise=null,this._closed=!1,this._timestampOffset=0}_ensureValidAdd(){if(!this._connectedTrack)throw Error("Source is not connected to an output track.");if("canceled"===this._connectedTrack.output.state)throw Error("Output has been canceled.");if("finalizing"===this._connectedTrack.output.state||"finalized"===this._connectedTrack.output.state)throw Error("Output has been finalized.");if("pending"===this._connectedTrack.output.state)throw Error("Output has not started.");if(this._closed)throw Error("Source is closed.")}async _start(){}async _flushAndClose(e){}close(){if(this._closingPromise)return;let e=this._connectedTrack;if(!e)throw Error("Cannot call close without connecting the source to an output track.");if("pending"===e.output.state)throw Error("Cannot call close before output has been started.");this._closingPromise=(async()=>{await this._flushAndClose(!1),this._closed=!0,"finalizing"!==e.output.state&&"finalized"!==e.output.state&&e.output._muxer.onTrackClose(e)})()}async _flushOrWaitForOngoingClose(e){return this._closingPromise??=(async()=>{await this._flushAndClose(e),this._closed=!0})()}}class tP extends tR{constructor(e){if(super(),this._connectedTrack=null,!i.WN.includes(e))throw TypeError(`Invalid video codec '${e}'. Must be one of: ${i.WN.join(", ")}.`);this._codec=e}}class tz{constructor(e,t){this.source=e,this.encodingConfig=t,this.ensureEncoderPromise=null,this.encoderInitialized=!1,this.encoder=null,this.muxer=null,this.lastMultipleOfKeyFrameInterval=-1,this.codedWidth=null,this.codedHeight=null,this.resizeCanvas=null,this.customEncoder=null,this.customEncoderCallSerializer=new a.dY,this.customEncoderQueueSize=0,this.alphaEncoder=null,this.splitter=null,this.splitterCreationFailed=!1,this.alphaFrameQueue=[],this.error=null,this.errorNeedsNewStack=!0}async add(e,t,r){try{if(this.checkForEncoderError(),this.source._ensureValidAdd(),null!==this.codedWidth&&null!==this.codedHeight){if(e.codedWidth!==this.codedWidth||e.codedHeight!==this.codedHeight){let r=this.encodingConfig.sizeChangeBehavior??"deny";if("passThrough"===r);else if("deny"===r)throw Error(`Video sample size must remain constant. Expected ${this.codedWidth}x${this.codedHeight}, got ${e.codedWidth}x${e.codedHeight}. To allow the sample size to change over time, set \`sizeChangeBehavior\` to a value other than 'strict' in the encoding options.`);else{let i=!1;this.resizeCanvas||("undefined"!=typeof document?(this.resizeCanvas=document.createElement("canvas"),this.resizeCanvas.width=this.codedWidth,this.resizeCanvas.height=this.codedHeight):this.resizeCanvas=new OffscreenCanvas(this.codedWidth,this.codedHeight),i=!0);let o=this.resizeCanvas.getContext("2d",{alpha:(0,a.gm)()});(0,a.vA)(o),i||((0,a.gm)()?(o.fillStyle="black",o.fillRect(0,0,this.codedWidth,this.codedHeight)):o.clearRect(0,0,this.codedWidth,this.codedHeight)),e.drawWithFit(o,{fit:r}),t&&e.close(),e=new tS.U2(this.resizeCanvas,{timestamp:e.timestamp,duration:e.duration,rotation:e.rotation}),t=!0}}}else this.codedWidth=e.codedWidth,this.codedHeight=e.codedHeight;this.encoderInitialized||(this.ensureEncoderPromise||this.ensureEncoder(e),this.encoderInitialized||await this.ensureEncoderPromise),(0,a.vA)(this.encoderInitialized);let i=this.encodingConfig.keyFrameInterval??5,o=Math.floor(e.timestamp/i),s={...r,keyFrame:r?.keyFrame||0===i||o!==this.lastMultipleOfKeyFrameInterval};if(this.lastMultipleOfKeyFrameInterval=o,this.customEncoder){this.customEncoderQueueSize++;let t=e.clone(),r=this.customEncoderCallSerializer.call(()=>this.customEncoder.encode(t,s)).then(()=>this.customEncoderQueueSize--).catch(e=>this.error??=e).finally(()=>{t.close()});this.customEncoderQueueSize>=4&&await r}else{(0,a.vA)(this.encoder);let r=e.toVideoFrame();if(this.alphaEncoder){if(r.format&&!r.format.includes("A")||this.splitterCreationFailed)this.alphaFrameQueue.push(null),this.encoder.encode(r,s),r.close();else{let e=r.displayWidth,t=r.displayHeight;if(!this.splitter)try{this.splitter=new tF(e,t)}catch(e){console.error("Due to an error, only color data will be encoded.",e),this.splitterCreationFailed=!0,this.alphaFrameQueue.push(null),this.encoder.encode(r,s),r.close()}if(this.splitter){let e=this.splitter.extractColor(r),t=this.splitter.extractAlpha(r);this.alphaFrameQueue.push(t),this.encoder.encode(e,s),e.close(),r.close()}}}else this.encoder.encode(r,s),r.close();t&&e.close(),this.encoder.encodeQueueSize>=4&&await new Promise(e=>this.encoder.addEventListener("dequeue",e,{once:!0}))}await this.muxer.mutex.currentPromise}finally{t&&e.close()}}ensureEncoder(e){let t=Error();this.ensureEncoderPromise=(async()=>{let r=tf({width:e.codedWidth,height:e.codedHeight,...this.encodingConfig,framerate:this.source._connectedTrack?.metadata.frameRate});this.encodingConfig.onEncoderConfig?.(r);let i=th.WE.find(e=>e.supports(this.encodingConfig.codec,r));if(i)this.customEncoder=new i,this.customEncoder.codec=this.encodingConfig.codec,this.customEncoder.config=r,this.customEncoder.onPacket=(e,t)=>{if(!(e instanceof t_.Z))throw TypeError("The first argument passed to onPacket must be an EncodedPacket.");if(void 0!==t&&(!t||"object"!=typeof t))throw TypeError("The second argument passed to onPacket must be an object or undefined.");this.encodingConfig.onEncodedPacket?.(e,t),this.muxer.addEncodedVideoPacket(this.source._connectedTrack,e,t).catch(e=>{this.error??=e,this.errorNeedsNewStack=!1})},await this.customEncoder.init();else{if("undefined"==typeof VideoEncoder)throw Error("VideoEncoder is not supported by this browser.");if(r.alpha="discard","keep"===this.encodingConfig.alpha&&(r.latencyMode="quality"),(r.width%2==1||r.height%2==1)&&("avc"===this.encodingConfig.codec||"hevc"===this.encodingConfig.codec))throw Error(`The dimensions ${r.width}x${r.height} are not supported for codec '${this.encodingConfig.codec}'; both width and height must be even numbers. Make sure to round your dimensions to the nearest even number.`);if(!(await VideoEncoder.isConfigSupported(r)).supported)throw Error(`This specific encoder configuration (${r.codec}, ${r.bitrate} bps, ${r.width}x${r.height}, hardware acceleration: ${r.hardwareAcceleration??"no-preference"}) is not supported by this browser. Consider using another codec or changing your video parameters.`);let e=[],i=[],o=0,s=0,n=(e,t,r)=>{let i={};if(t){let e=new Uint8Array(t.byteLength);t.copyTo(e),i.alpha=e}let a=t_.Z.fromEncodedChunk(e,i);this.encodingConfig.onEncodedPacket?.(a,r),this.muxer.addEncodedVideoPacket(this.source._connectedTrack,a,r).catch(e=>{this.error??=e,this.errorNeedsNewStack=!1})};this.encoder=new VideoEncoder({output:(t,r)=>{if(!this.alphaEncoder){n(t,null,r);return}let l=this.alphaFrameQueue.shift();(0,a.vA)(void 0!==l),l?(this.alphaEncoder.encode(l,{keyFrame:"key"===t.type}),s++,l.close(),e.push({chunk:t,meta:r})):0===s?n(t,null,r):(i.push(o+s),e.push({chunk:t,meta:r}))},error:e=>{e.stack=t.stack,this.error??=e}}),this.encoder.configure(r),"keep"===this.encodingConfig.alpha&&(this.alphaEncoder=new VideoEncoder({output:(t,r)=>{s--;let l=e.shift();for((0,a.vA)(void 0!==l),n(l.chunk,t,l.meta),o++;i.length>0&&i[0]===o;){i.shift();let t=e.shift();(0,a.vA)(void 0!==t),n(t.chunk,null,t.meta)}},error:e=>{e.stack=t.stack,this.error??=e}}),this.alphaEncoder.configure(r))}(0,a.vA)(this.source._connectedTrack),this.muxer=this.source._connectedTrack.output._muxer,this.encoderInitialized=!0})()}async flushAndClose(e){e||this.checkForEncoderError(),this.customEncoder?(e||this.customEncoderCallSerializer.call(()=>this.customEncoder.flush()),await this.customEncoderCallSerializer.call(()=>this.customEncoder.close())):this.encoder&&(e||(await this.encoder.flush(),await this.alphaEncoder?.flush()),"closed"!==this.encoder.state&&this.encoder.close(),this.alphaEncoder&&"closed"!==this.alphaEncoder.state&&this.alphaEncoder.close(),this.alphaFrameQueue.forEach(e=>e?.close()),this.splitter?.close()),e||this.checkForEncoderError()}getQueueSize(){return this.customEncoder?this.customEncoderQueueSize:this.encoder?.encodeQueueSize??0}checkForEncoderError(){if(this.error)throw this.errorNeedsNewStack&&(this.error.stack=Error().stack),this.error}}class tF{constructor(e,t){this.lastFrame=null,"undefined"!=typeof OffscreenCanvas?this.canvas=new OffscreenCanvas(e,t):(this.canvas=document.createElement("canvas"),this.canvas.width=e,this.canvas.height=t);let r=this.canvas.getContext("webgl2",{alpha:!0});if(!r)throw Error("Couldn't acquire WebGL 2 context.");this.gl=r,this.colorProgram=this.createColorProgram(),this.alphaProgram=this.createAlphaProgram(),this.vao=this.createVAO(),this.sourceTexture=this.createTexture(),this.alphaResolutionLocation=this.gl.getUniformLocation(this.alphaProgram,"u_resolution"),this.gl.useProgram(this.colorProgram),this.gl.uniform1i(this.gl.getUniformLocation(this.colorProgram,"u_sourceTexture"),0),this.gl.useProgram(this.alphaProgram),this.gl.uniform1i(this.gl.getUniformLocation(this.alphaProgram,"u_sourceTexture"),0)}createVertexShader(){return this.createShader(this.gl.VERTEX_SHADER,`#version 300 es
			in vec2 a_position;
			in vec2 a_texCoord;
			out vec2 v_texCoord;
			
			void main() {
				gl_Position = vec4(a_position, 0.0, 1.0);
				v_texCoord = a_texCoord;
			}
		`)}createColorProgram(){let e=this.createVertexShader(),t=this.createShader(this.gl.FRAGMENT_SHADER,`#version 300 es
			precision highp float;
			
			uniform sampler2D u_sourceTexture;
			in vec2 v_texCoord;
			out vec4 fragColor;
			
			void main() {
				vec4 source = texture(u_sourceTexture, v_texCoord);
				fragColor = vec4(source.rgb, 1.0);
			}
		`),r=this.gl.createProgram();return this.gl.attachShader(r,e),this.gl.attachShader(r,t),this.gl.linkProgram(r),r}createAlphaProgram(){let e=this.createVertexShader(),t=this.createShader(this.gl.FRAGMENT_SHADER,`#version 300 es
			precision highp float;
			
			uniform sampler2D u_sourceTexture;
			uniform vec2 u_resolution; // The width and height of the canvas
			in vec2 v_texCoord;
			out vec4 fragColor;

			// This function determines the value for a single byte in the YUV stream
			float getByteValue(float byteOffset) {
				float width = u_resolution.x;
				float height = u_resolution.y;

				float yPlaneSize = width * height;

				if (byteOffset < yPlaneSize) {
					// This byte is in the luma plane. Find the corresponding pixel coordinates to sample from
					float y = floor(byteOffset / width);
					float x = mod(byteOffset, width);
					
					// Add 0.5 to sample the center of the texel
					vec2 sampleCoord = (vec2(x, y) + 0.5) / u_resolution;
					
					// The luma value is the alpha from the source texture
					return texture(u_sourceTexture, sampleCoord).a;
				} else {
					// Write a fixed value for chroma and beyond
					return 128.0 / 255.0;
				}
			}
			
			void main() {
				// Each fragment writes 4 bytes (R, G, B, A)
				float pixelIndex = floor(gl_FragCoord.y) * u_resolution.x + floor(gl_FragCoord.x);
				float baseByteOffset = pixelIndex * 4.0;

				vec4 result;
				for (int i = 0; i < 4; i++) {
					float currentByteOffset = baseByteOffset + float(i);
					result[i] = getByteValue(currentByteOffset);
				}
				
				fragColor = result;
			}
		`),r=this.gl.createProgram();return this.gl.attachShader(r,e),this.gl.attachShader(r,t),this.gl.linkProgram(r),r}createShader(e,t){let r=this.gl.createShader(e);return this.gl.shaderSource(r,t),this.gl.compileShader(r),this.gl.getShaderParameter(r,this.gl.COMPILE_STATUS)||console.error("Shader compile error:",this.gl.getShaderInfoLog(r)),r}createVAO(){let e=this.gl.createVertexArray();this.gl.bindVertexArray(e);let t=new Float32Array([-1,-1,0,1,1,-1,1,1,-1,1,0,0,1,1,1,0]),r=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,r),this.gl.bufferData(this.gl.ARRAY_BUFFER,t,this.gl.STATIC_DRAW);let i=this.gl.getAttribLocation(this.colorProgram,"a_position"),a=this.gl.getAttribLocation(this.colorProgram,"a_texCoord");return this.gl.enableVertexAttribArray(i),this.gl.vertexAttribPointer(i,2,this.gl.FLOAT,!1,16,0),this.gl.enableVertexAttribArray(a),this.gl.vertexAttribPointer(a,2,this.gl.FLOAT,!1,16,8),e}createTexture(){let e=this.gl.createTexture();return this.gl.bindTexture(this.gl.TEXTURE_2D,e),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR),e}updateTexture(e){this.lastFrame!==e&&((e.displayWidth!==this.canvas.width||e.displayHeight!==this.canvas.height)&&(this.canvas.width=e.displayWidth,this.canvas.height=e.displayHeight),this.gl.activeTexture(this.gl.TEXTURE0),this.gl.bindTexture(this.gl.TEXTURE_2D,this.sourceTexture),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,e),this.lastFrame=e)}extractColor(e){return this.updateTexture(e),this.gl.useProgram(this.colorProgram),this.gl.viewport(0,0,this.canvas.width,this.canvas.height),this.gl.clear(this.gl.COLOR_BUFFER_BIT),this.gl.bindVertexArray(this.vao),this.gl.drawArrays(this.gl.TRIANGLE_STRIP,0,4),new VideoFrame(this.canvas,{timestamp:e.timestamp,duration:e.duration??void 0,alpha:"discard"})}extractAlpha(e){this.updateTexture(e),this.gl.useProgram(this.alphaProgram),this.gl.uniform2f(this.alphaResolutionLocation,this.canvas.width,this.canvas.height),this.gl.viewport(0,0,this.canvas.width,this.canvas.height),this.gl.clear(this.gl.COLOR_BUFFER_BIT),this.gl.bindVertexArray(this.vao),this.gl.drawArrays(this.gl.TRIANGLE_STRIP,0,4);let{width:t,height:r}=this.canvas,i=Math.ceil(t/2)*Math.ceil(r/2),o=t*r+2*i,s=Math.ceil(o/(4*t)),n=new Uint8Array(4*t*s);this.gl.readPixels(0,0,t,s,this.gl.RGBA,this.gl.UNSIGNED_BYTE,n),n=n.subarray(0,o),(0,a.vA)(128===n[t*r]),(0,a.vA)(128===n[n.length-1]);let l={format:"I420",codedWidth:t,codedHeight:r,timestamp:e.timestamp,duration:e.duration??void 0,transfer:[n.buffer]};return new VideoFrame(n,l)}close(){this.gl.getExtension("WEBGL_lose_context")?.loseContext(),this.gl=null}}class tW extends tP{constructor(e){tu(e),super(e.codec),this._encoder=new tz(this,e)}add(e,t){if(!(e instanceof tS.U2))throw TypeError("videoSample must be a VideoSample.");return this._encoder.add(e,!1,t)}_flushAndClose(e){return this._encoder.flushAndClose(e)}}class tI extends tR{constructor(e){if(super(),this._connectedTrack=null,!i.PP.includes(e))throw TypeError(`Invalid audio codec '${e}'. Must be one of: ${i.PP.join(", ")}.`);this._codec=e}}class tL{constructor(e,t){this.source=e,this.encodingConfig=t,this.ensureEncoderPromise=null,this.encoderInitialized=!1,this.encoder=null,this.muxer=null,this.lastNumberOfChannels=null,this.lastSampleRate=null,this.isPcmEncoder=!1,this.outputSampleSize=null,this.writeOutputValue=null,this.customEncoder=null,this.customEncoderCallSerializer=new a.dY,this.customEncoderQueueSize=0,this.lastEndSampleIndex=null,this.error=null,this.errorNeedsNewStack=!0}async add(e,t){try{if(this.checkForEncoderError(),this.source._ensureValidAdd(),null!==this.lastNumberOfChannels&&null!==this.lastSampleRate){if(e.numberOfChannels!==this.lastNumberOfChannels||e.sampleRate!==this.lastSampleRate)throw Error(`Audio parameters must remain constant. Expected ${this.lastNumberOfChannels} channels at ${this.lastSampleRate} Hz, got ${e.numberOfChannels} channels at ${e.sampleRate} Hz.`)}else this.lastNumberOfChannels=e.numberOfChannels,this.lastSampleRate=e.sampleRate;this.encoderInitialized||(this.ensureEncoderPromise||this.ensureEncoder(e),this.encoderInitialized||await this.ensureEncoderPromise),(0,a.vA)(this.encoderInitialized);{let t=Math.round(e.timestamp*e.sampleRate),r=Math.round((e.timestamp+e.duration)*e.sampleRate);if(null===this.lastEndSampleIndex)this.lastEndSampleIndex=r;else{let r=t-this.lastEndSampleIndex;if(r>=64){let t=new tS.B1({data:new Float32Array(r*e.numberOfChannels),format:"f32-planar",sampleRate:e.sampleRate,numberOfChannels:e.numberOfChannels,numberOfFrames:r,timestamp:this.lastEndSampleIndex/e.sampleRate});await this.add(t,!0)}this.lastEndSampleIndex+=e.numberOfFrames}}if(this.customEncoder){this.customEncoderQueueSize++;let t=e.clone(),r=this.customEncoderCallSerializer.call(()=>this.customEncoder.encode(t)).then(()=>this.customEncoderQueueSize--).catch(e=>this.error??=e).finally(()=>{t.close()});this.customEncoderQueueSize>=4&&await r,await this.muxer.mutex.currentPromise}else if(this.isPcmEncoder)await this.doPcmEncoding(e,t);else{(0,a.vA)(this.encoder);let r=e.toAudioData();this.encoder.encode(r),r.close(),t&&e.close(),this.encoder.encodeQueueSize>=4&&await new Promise(e=>this.encoder.addEventListener("dequeue",e,{once:!0})),await this.muxer.mutex.currentPromise}}finally{t&&e.close()}}async doPcmEncoding(e,t){(0,a.vA)(this.outputSampleSize),(0,a.vA)(this.writeOutputValue);let{numberOfChannels:r,numberOfFrames:i,sampleRate:o,timestamp:s}=e,n=[];for(let t=0;t<i;t+=2048){let i=Math.min(2048,e.numberOfFrames-t),a=new DataView(new ArrayBuffer(i*r*this.outputSampleSize));n.push({frameCount:i,view:a})}let l=new Float32Array(e.allocationSize({planeIndex:0,format:"f32-planar"})/Float32Array.BYTES_PER_ELEMENT);for(let t=0;t<r;t++){e.copyTo(l,{planeIndex:t,format:"f32-planar"});for(let e=0;e<n.length;e++){let{frameCount:i,view:a}=n[e];for(let o=0;o<i;o++)this.writeOutputValue(a,(o*r+t)*this.outputSampleSize,l[2048*e+o])}}t&&e.close();let c={decoderConfig:{codec:this.encodingConfig.codec,numberOfChannels:r,sampleRate:o}};for(let e=0;e<n.length;e++){let{frameCount:t,view:r}=n[e],i=r.buffer,a=2048*e,l=new t_.Z(new Uint8Array(i),"key",s+a/o,t/o);this.encodingConfig.onEncodedPacket?.(l,c),await this.muxer.addEncodedAudioPacket(this.source._connectedTrack,l,c)}}ensureEncoder(e){let t=Error();this.ensureEncoderPromise=(async()=>{let{numberOfChannels:r,sampleRate:o}=e,s=tw({numberOfChannels:r,sampleRate:o,...this.encodingConfig});this.encodingConfig.onEncoderConfig?.(s);let n=th.Lr.find(e=>e.supports(this.encodingConfig.codec,s));if(n)this.customEncoder=new n,this.customEncoder.codec=this.encodingConfig.codec,this.customEncoder.config=s,this.customEncoder.onPacket=(e,t)=>{if(!(e instanceof t_.Z))throw TypeError("The first argument passed to onPacket must be an EncodedPacket.");if(void 0!==t&&(!t||"object"!=typeof t))throw TypeError("The second argument passed to onPacket must be an object or undefined.");this.encodingConfig.onEncodedPacket?.(e,t),this.muxer.addEncodedAudioPacket(this.source._connectedTrack,e,t).catch(e=>{this.error??=e,this.errorNeedsNewStack=!1})},await this.customEncoder.init();else if(i.Wq.includes(this.encodingConfig.codec))this.initPcmEncoder();else{if("undefined"==typeof AudioEncoder)throw Error("AudioEncoder is not supported by this browser.");if(!(await AudioEncoder.isConfigSupported(s)).supported)throw Error(`This specific encoder configuration (${s.codec}, ${s.bitrate} bps, ${s.numberOfChannels} channels, ${s.sampleRate} Hz) is not supported by this browser. Consider using another codec or changing your audio parameters.`);this.encoder=new AudioEncoder({output:(e,t)=>{if("aac"===this.encodingConfig.codec&&t?.decoderConfig){let e=!1;if(!t.decoderConfig.description||t.decoderConfig.description.byteLength<2||0===(0,i.zF)((0,a.Fo)(t.decoderConfig.description)).objectType){let e=Number((0,a._g)(s.codec.split(".")));t.decoderConfig.description=(0,i.Wz)({objectType:e,numberOfChannels:t.decoderConfig.numberOfChannels,sampleRate:t.decoderConfig.sampleRate})}}let r=t_.Z.fromEncodedChunk(e);this.encodingConfig.onEncodedPacket?.(r,t),this.muxer.addEncodedAudioPacket(this.source._connectedTrack,r,t).catch(e=>{this.error??=e,this.errorNeedsNewStack=!1})},error:e=>{e.stack=t.stack,this.error??=e}}),this.encoder.configure(s)}(0,a.vA)(this.source._connectedTrack),this.muxer=this.source._connectedTrack.output._muxer,this.encoderInitialized=!0})()}initPcmEncoder(){this.isPcmEncoder=!0;let e=this.encodingConfig.codec,{dataType:t,sampleSize:r,littleEndian:o}=(0,i.Ei)(e);switch(this.outputSampleSize=r,r){case 1:"unsigned"===t?this.writeOutputValue=(e,t,r)=>e.setUint8(t,(0,a.qE)((r+1)*127.5,0,255)):"signed"===t?this.writeOutputValue=(e,t,r)=>{e.setInt8(t,(0,a.qE)(Math.round(128*r),-128,127))}:"ulaw"===t?this.writeOutputValue=(e,t,r)=>{let i=(0,a.qE)(Math.floor(32767*r),-32768,32767);e.setUint8(t,(0,tA.vX)(i))}:"alaw"===t?this.writeOutputValue=(e,t,r)=>{let i=(0,a.qE)(Math.floor(32767*r),-32768,32767);e.setUint8(t,(0,tA.xq)(i))}:(0,a.vA)(!1);break;case 2:"unsigned"===t?this.writeOutputValue=(e,t,r)=>e.setUint16(t,(0,a.qE)((r+1)*32767.5,0,65535),o):"signed"===t?this.writeOutputValue=(e,t,r)=>e.setInt16(t,(0,a.qE)(Math.round(32767*r),-32768,32767),o):(0,a.vA)(!1);break;case 3:"unsigned"===t?this.writeOutputValue=(e,t,r)=>(0,a.jD)(e,t,(0,a.qE)((r+1)*8388607.5,0,0xffffff),o):"signed"===t?this.writeOutputValue=(e,t,r)=>(0,a.iP)(e,t,(0,a.qE)(Math.round(8388607*r),-8388608,8388607),o):(0,a.vA)(!1);break;case 4:"unsigned"===t?this.writeOutputValue=(e,t,r)=>e.setUint32(t,(0,a.qE)((r+1)*2147483647.5,0,0xffffffff),o):"signed"===t?this.writeOutputValue=(e,t,r)=>e.setInt32(t,(0,a.qE)(Math.round(0x7fffffff*r),-0x80000000,0x7fffffff),o):"float"===t?this.writeOutputValue=(e,t,r)=>e.setFloat32(t,r,o):(0,a.vA)(!1);break;case 8:"float"===t?this.writeOutputValue=(e,t,r)=>e.setFloat64(t,r,o):(0,a.vA)(!1);break;default:(0,a.xb)(r),(0,a.vA)(!1)}}async flushAndClose(e){e||this.checkForEncoderError(),this.customEncoder?(e||this.customEncoderCallSerializer.call(()=>this.customEncoder.flush()),await this.customEncoderCallSerializer.call(()=>this.customEncoder.close())):this.encoder&&(e||await this.encoder.flush(),"closed"!==this.encoder.state&&this.encoder.close()),e||this.checkForEncoderError()}getQueueSize(){return this.customEncoder?this.customEncoderQueueSize:this.isPcmEncoder?0:this.encoder?.encodeQueueSize??0}checkForEncoderError(){if(this.error)throw this.errorNeedsNewStack&&(this.error.stack=Error().stack),this.error}}class tO extends tI{constructor(e){tp(e),super(e.codec),this._encoder=new tL(this,e)}add(e){if(!(e instanceof tS.B1))throw TypeError("audioSample must be an AudioSample.");return this._encoder.add(e,!1)}_flushAndClose(e){return this._encoder.flushAndClose(e)}}class tD extends tR{constructor(e){if(super(),this._connectedTrack=null,!i.VW.includes(e))throw TypeError(`Invalid subtitle codec '${e}'. Must be one of: ${i.VW.join(", ")}.`);this._codec=e}}var tB=r(2115),tU=r(7650),tN=r(2669),t$=r(5155);let tV=["video","audio","subtitle"],tH=e=>{if(!e||"object"!=typeof e)throw TypeError("metadata must be an object.");if(void 0!==e.languageCode&&!(0,a.Nu)(e.languageCode))throw TypeError("metadata.languageCode, when provided, must be a three-letter, ISO 639-2/T language code.");if(void 0!==e.name&&"string"!=typeof e.name)throw TypeError("metadata.name, when provided, must be a string.");if(void 0!==e.disposition&&(0,l.Ze)(e.disposition),void 0!==e.maximumPacketCount&&(!Number.isInteger(e.maximumPacketCount)||e.maximumPacketCount<0))throw TypeError("metadata.maximumPacketCount, when provided, must be a non-negative integer.")};class tQ{constructor(e){if(this.state="pending",this._tracks=[],this._startPromise=null,this._cancelPromise=null,this._finalizePromise=null,this._mutex=new a.aD,this._metadataTags={},!e||"object"!=typeof e)throw TypeError("options must be an object.");if(!(e.format instanceof to))throw TypeError("options.format must be an OutputFormat.");if(!(e.target instanceof eJ))throw TypeError("options.target must be a Target.");if(e.target._output)throw Error("Target is already used for another output.");e.target._output=this,this.format=e.format,this.target=e.target,this._writer=e.target._createWriter(),this._muxer=e.format._createMuxer(this)}addVideoTrack(e,t={}){if(!(e instanceof tP))throw TypeError("source must be a VideoSource.");if(tH(t),void 0!==t.rotation&&![0,90,180,270].includes(t.rotation))throw TypeError(`Invalid video rotation: ${t.rotation}. Has to be 0, 90, 180 or 270.`);if(!this.format.supportsVideoRotationMetadata&&t.rotation)throw Error(`${this.format._name} does not support video rotation metadata.`);if(void 0!==t.frameRate&&(!Number.isFinite(t.frameRate)||t.frameRate<=0))throw TypeError(`Invalid video frame rate: ${t.frameRate}. Must be a positive number.`);this._addTrack("video",e,t)}addAudioTrack(e,t={}){if(!(e instanceof tI))throw TypeError("source must be an AudioSource.");tH(t),this._addTrack("audio",e,t)}addSubtitleTrack(e,t={}){if(!(e instanceof tD))throw TypeError("source must be a SubtitleSource.");tH(t),this._addTrack("subtitle",e,t)}setMetadataTags(e){if((0,l.VD)(e),"pending"!==this.state)throw Error("Cannot set metadata tags after output has been started or canceled.");this._metadataTags=e}_addTrack(e,t,r){if("pending"!==this.state)throw Error("Cannot add track after output has been started or canceled.");if(t._connectedTrack)throw Error("Source is already used for a track.");let i=this.format.getSupportedTrackCounts(),a=this._tracks.reduce((t,r)=>t+ +(r.type===e),0),o=i[e].max;if(a===o)throw Error(0===o?`${this.format._name} does not support ${e} tracks.`:`${this.format._name} does not support more than ${o} ${e} track${1===o?"":"s"}.`);let s=i.total.max;if(this._tracks.length===s)throw Error(`${this.format._name} does not support more than ${s} tracks${1===s?"":"s"} in total.`);let n={id:this._tracks.length+1,output:this,type:e,source:t,metadata:r};if("video"===n.type){let e=this.format.getSupportedVideoCodecs();if(0===e.length)throw Error(`${this.format._name} does not support video tracks.`+this.format._codecUnsupportedHint(n.source._codec));if(!e.includes(n.source._codec))throw Error(`Codec '${n.source._codec}' cannot be contained within ${this.format._name}. Supported video codecs are: ${e.map(e=>`'${e}'`).join(", ")}.`+this.format._codecUnsupportedHint(n.source._codec))}else if("audio"===n.type){let e=this.format.getSupportedAudioCodecs();if(0===e.length)throw Error(`${this.format._name} does not support audio tracks.`+this.format._codecUnsupportedHint(n.source._codec));if(!e.includes(n.source._codec))throw Error(`Codec '${n.source._codec}' cannot be contained within ${this.format._name}. Supported audio codecs are: ${e.map(e=>`'${e}'`).join(", ")}.`+this.format._codecUnsupportedHint(n.source._codec))}else if("subtitle"===n.type){let e=this.format.getSupportedSubtitleCodecs();if(0===e.length)throw Error(`${this.format._name} does not support subtitle tracks.`+this.format._codecUnsupportedHint(n.source._codec));if(!e.includes(n.source._codec))throw Error(`Codec '${n.source._codec}' cannot be contained within ${this.format._name}. Supported subtitle codecs are: ${e.map(e=>`'${e}'`).join(", ")}.`+this.format._codecUnsupportedHint(n.source._codec))}this._tracks.push(n),t._connectedTrack=n}async start(){let e=this.format.getSupportedTrackCounts();for(let t of tV){let r=this._tracks.reduce((e,r)=>e+ +(r.type===t),0),i=e[t].min;if(r<i)throw Error(i===e[t].max?`${this.format._name} requires exactly ${i} ${t} track${1===i?"":"s"}.`:`${this.format._name} requires at least ${i} ${t} track${1===i?"":"s"}.`)}let t=e.total.min;if(this._tracks.length<t)throw Error(t===e.total.max?`${this.format._name} requires exactly ${t} track${1===t?"":"s"}.`:`${this.format._name} requires at least ${t} track${1===t?"":"s"}.`);if("canceled"===this.state)throw Error("Output has been canceled.");return this._startPromise?(console.warn("Output has already been started."),this._startPromise):this._startPromise=(async()=>{this.state="started",this._writer.start();let e=await this._mutex.acquire();await this._muxer.start();let t=this._tracks.map(e=>e.source._start());await Promise.all(t),e()})()}getMimeType(){return this._muxer.getMimeType()}async cancel(){if(this._cancelPromise)return console.warn("Output has already been canceled."),this._cancelPromise;if("finalizing"===this.state||"finalized"===this.state){console.warn("Output has already been finalized.");return}return this._cancelPromise=(async()=>{this.state="canceled";let e=await this._mutex.acquire(),t=this._tracks.map(e=>e.source._flushOrWaitForOngoingClose(!0));await Promise.all(t),await this._writer.close(),e()})()}async finalize(){if("pending"===this.state)throw Error("Cannot finalize before starting.");if("canceled"===this.state)throw Error("Cannot finalize after canceling.");return this._finalizePromise?(console.warn("Output has already been finalized."),this._finalizePromise):this._finalizePromise=(async()=>{this.state="finalizing";let e=await this._mutex.acquire(),t=this._tracks.map(e=>e.source._flushOrWaitForOngoingClose(!1));await Promise.all(t),await this._muxer.finalize(),await this._writer.flush(),await this._writer.finalize(),this.state="finalized",e()})()}}var tj=Symbol.dispose||Symbol.for("Symbol.dispose"),tq=Symbol.asyncDispose||Symbol.for("Symbol.asyncDispose"),tX=(e,t,r)=>{if(null!=t){var i;if("object"!=typeof t&&"function"!=typeof t)throw TypeError('Object expected to be assigned to "using" declaration');if(r&&(i=t[tq]),void 0===i&&(i=t[tj]),"function"!=typeof i)throw TypeError("Object not disposable");e.push([r,i,t])}else r&&e.push([r]);return t},tG=(e,t,r)=>{var i="function"==typeof SuppressedError?SuppressedError:function(e,t,r,i){return(i=Error(r)).name="SuppressedError",i.error=e,i.suppressed=t,i},a=e=>t=r?new i(e,t,"An error was suppressed during disposal"):(r=!0,e),o=i=>{for(;i=e.pop();)try{var s=i[1]&&i[1].call(i[2]);if(i[0])return Promise.resolve(s).then(o,e=>(a(e),o()))}catch(e){a(e)}if(r)throw t};return o()},tK=async()=>{if(!("storage"in navigator)||!("getDirectory"in navigator.storage))return!1;try{let e=await navigator.storage.getDirectory(),t=await e.getFileHandle("remotion-probe-web-fs-support",{create:!0});return void 0!==t.createWritable}catch{return!1}},tY=e=>{switch(e){case"h264":return"avc";case"h265":return"hevc";case"vp8":return"vp8";case"vp9":return"vp9";case"av1":return"av1";default:throw Error(`Unsupported codec: ${e}`)}},tZ=e=>{switch(e){case"mp4":return new tn;case"webm":return new td;default:throw Error(`Unsupported container: ${e}`)}},tJ=e=>{switch(e){case"mp4":return"h264";case"webm":return"vp8";default:throw Error(`Unsupported container: ${e}`)}},t0=e=>{switch(e){case"very-low":return ty;case"low":return tk;case"medium":return tv;case"high":return tC;case"very-high":return tT;default:throw Error(`Unsupported quality: ${e}`)}},t1=e=>{switch(e){case"mp4":return"video/mp4";case"webm":return"video/webm";default:throw Error(`Unsupported container: ${e}`)}},t2=e=>{switch(e){case"mp4":return"aac";case"webm":return"opus";default:throw Error(`Unsupported container: ${e}`)}},t3=["aac","opus"],t4=e=>{let t=tZ(e).getSupportedAudioCodecs();return t3.filter(e=>t.includes(e))},t6=e=>e,t8=async e=>{let t=[],{container:r,requestedCodec:i,userSpecifiedAudioCodec:a,bitrate:o}=e,s=i??t2(r),n=t4(r);if(!n.includes(s))return t.push({type:"audio-codec-unsupported",message:`Audio codec "${s}" is not supported for container "${r}". Supported: ${n.join(", ")}`,severity:"error"}),{codec:null,issues:t};let l=t6(s);if(await tx(l,{bitrate:o}))return{codec:s,issues:t};if(a)return t.push({type:"audio-codec-unsupported",message:`Audio codec "${s}" cannot be encoded by this browser. This is common for AAC on Firefox. Try using "opus" instead.`,severity:"error"}),{codec:null,issues:t};for(let e of n)if(e!==s){let r=t6(e);if(await tx(r,{bitrate:o}))return t.push({type:"audio-codec-unsupported",message:`Falling back from audio codec "${s}" to "${e}" because the original codec cannot be encoded by this browser.`,severity:"warning"}),{codec:e,issues:t}}return t.push({type:"audio-codec-unsupported",message:`No audio codec can be encoded by this browser for container "${r}".`,severity:"error"}),{codec:null,issues:t}},t5=async(e,t)=>{let r=new tS.U2(e);try{await t.add(r)}finally{r.close(),e.close()}},t7=async(e,t)=>{let r=new tS.B1(e);try{await t.add(r)}finally{r.close()}},t9=async({assets:e,frameBuffer:t})=>{let r=e.filter(e=>"artifact"===e.type),i=null,a=[];for(let e of r){if("binary"===e.contentType||"text"===e.contentType){a.push({frame:e.frame,content:e.content,filename:e.filename,downloadBehavior:e.downloadBehavior});continue}if("thumbnail"===e.contentType){if(null===t)continue;let r=t instanceof Blob?await t.arrayBuffer():new Uint8Array(await (await t.convertToBlob({type:"image/png"})).arrayBuffer());i=new Uint8Array(r),a.push({frame:e.frame,content:i,filename:e.filename,downloadBehavior:e.downloadBehavior});continue}throw Error("Unknown artifact type: "+e)}return a.filter(tM.JC.truthy)},re=()=>{let e=[];return{handle:async({imageData:t,frame:r,assets:i,onArtifact:a})=>{for(let o of(await t9({assets:i,frameBuffer:t}))){let t=e.find(e=>e.filename===o.filename);if(t)throw Error(`An artifact with output "${o.filename}" was already registered at frame ${t.frame}, but now registered again at frame ${r}. Artifacts must have unique names. https://remotion.dev/docs/artifacts`);a(o),e.push({frame:r,filename:o.filename})}}}},rt=({assets:e,fps:t,timestamp:r})=>{let i=e.filter(e=>"inline-audio"===e.type);if(0===i.length)return null;let a=Math.round(96e3/t);for(let e of i)if(1!==e.toneFrequency)throw Error("Setting the toneFrequency is not supported yet in web rendering.");return new AudioData({data:function(e,t){if(1===e.length&&e[0].length===t)return e[0];let r=new Int16Array(t);if(1===e.length)return r.set(e[0].subarray(0,t)),r;for(let i=0;i<t;i++){let t=e.reduce((e,t)=>e+(t[i]??0),0);r[i]=Math.max(-32768,Math.min(32767,t))}return r}(i.map(e=>e.audio),a),format:"s16",numberOfChannels:2,numberOfFrames:a/2,sampleRate:48e3,timestamp:r})},rr=`
let intervalId = null;
self.onmessage = (e) => {
	if (e.data.type === 'start') {
		if (intervalId !== null) {
			clearInterval(intervalId);
		}
		intervalId = setInterval(() => self.postMessage('tick'), e.data.intervalMs);
	} else if (e.data.type === 'stop') {
		if (intervalId !== null) {
			clearInterval(intervalId);
			intervalId = null;
		}
	}
};
`,ri=({muted:e,codec:t,bitrate:r})=>{if(e||null===t)return null;let i=new tO({codec:t,bitrate:r});return{audioSampleSource:i,[Symbol.dispose]:()=>i.close()}},ra=({children:e,audioEnabled:t,videoEnabled:r,logLevel:i,compId:a,initialFrame:o,timeUpdater:s})=>{let[n,l]=(0,tB.useState)(o);return(0,tB.useImperativeHandle)(s,()=>({update:e=>{(0,tU.flushSync)(()=>{l(e)})}})),(0,t$.jsx)(tE.Xp.RemotionRootContexts,{audioEnabled:t,videoEnabled:r,logLevel:i,numberOfAudioTags:0,audioLatencyHint:"interactive",frameState:{[a]:n},nonceContextSeed:0,children:e})};function ro(e){if(e.error)throw e.error}function rs({width:e,height:t,delayRenderTimeoutInMilliseconds:r,logLevel:i,resolvedProps:a,id:o,mediaCacheSizeInBytes:s,durationInFrames:n,fps:l,initialFrame:c,schema:d,Component:h,audioEnabled:u,videoEnabled:m,defaultCodec:f,defaultOutName:p}){if(!tN.createRoot)throw Error("@remotion/web-renderer requires React 18 or higher");let g=document.createElement("div");g.style.position="fixed",g.style.display="flex",g.style.flexDirection="column",g.style.backgroundColor="transparent",g.style.width=`${e}px`,g.style.height=`${t}px`,g.style.zIndex="-9999",g.style.top="0",g.style.left="0",g.style.right="0",g.style.bottom="0",g.style.visibility="hidden",g.style.pointerEvents="none";let w=`remotion-scaffold-${Math.random().toString(36).substring(2,15)}`;g.className=w;let b=tE.Xp.CSSUtils.injectCSS(tE.Xp.CSSUtils.makeDefaultPreviewCSS(`.${w}`,"white"));document.body.appendChild(g);let y={error:null},k=tN.createRoot(g,{onUncaughtError:e=>{y.error=e instanceof Error?e:Error(String(e))}}),v={remotion_renderReady:!0,remotion_delayRenderTimeouts:{},remotion_puppeteerTimeout:r,remotion_attempt:0,remotion_delayRenderHandles:[]},C=(0,tB.createRef)(),T=(0,tB.createRef)();return(0,tU.flushSync)(()=>{k.render((0,t$.jsx)(tE.Xp.MaxMediaCacheSizeContext.Provider,{value:s,children:(0,t$.jsx)(tE.Xp.RemotionEnvironmentContext.Provider,{value:{isStudio:!1,isRendering:!0,isPlayer:!1,isReadOnlyStudio:!1,isClientSideRendering:!0},children:(0,t$.jsx)(tE.Xp.DelayRenderContextType.Provider,{value:v,children:(0,t$.jsx)(tE.Xp.CompositionManager.Provider,{value:{compositions:[{id:o,component:h,nonce:0,defaultProps:{},folderName:null,parentFolderName:null,schema:d??null,calculateMetadata:null,durationInFrames:n,fps:l,height:t,width:e}],canvasContent:{type:"composition",compositionId:o},currentCompositionMetadata:{props:a,durationInFrames:n,fps:l,height:t,width:e,defaultCodec:f??null,defaultOutName:p??null,defaultVideoImageFormat:null,defaultPixelFormat:null,defaultProResProfile:null},folders:[]},children:(0,t$.jsx)(tE.Xp.RenderAssetManagerProvider,{collectAssets:T,children:(0,t$.jsx)(ra,{audioEnabled:u,videoEnabled:m,logLevel:i,compId:o,initialFrame:c,timeUpdater:C,children:(0,t$.jsx)(tE.Xp.CanUseRemotionHooks.Provider,{value:!0,children:(0,t$.jsx)(h,{...a})})})})})})})}))}),{delayRenderScope:v,div:g,errorHolder:y,[Symbol.dispose]:()=>{k.unmount(),g.remove(),b()},timeUpdater:C,collectAssets:T}}var rn=(e,t)=>{if(null===t)return[0,e-1];if("number"==typeof t){if(t<0||t>=e)throw Error(`Frame number is out of range, must be between 0 and ${e-1} but got ${t}`);return[t,t]}if(t[1]>=e||t[0]<0)throw Error(`The "durationInFrames" of the composition was evaluated to be ${e}, but frame range ${t.join("-")} is not inbetween 0-${e-1}`);return t},rl=()=>{let e=0,t=0,r=0,i=0,a=0,o=0,s={current:null};return{getDrawn3dPixels:()=>e,getPrecomposedTiles:()=>t,addPrecompose:({canvasWidth:r,canvasHeight:i})=>{e+=r*i,t++},helperCanvasState:s,[Symbol.dispose]:()=>{s.current&&s.current.cleanup()},getWaitForReadyTime:()=>r,addWaitForReadyTime:e=>{r+=e},getAddSampleTime:()=>i,addAddSampleTime:e=>{i+=e},getCreateFrameTime:()=>a,addCreateFrameTime:e=>{a+=e},getAudioMixingTime:()=>o,addAudioMixingTime:e=>{o+=e}}},rc=e=>{let t=new tQ(e);return{output:t,[Symbol.dispose]:()=>{"finalized"!==t.state&&"canceled"!==t.state&&t.cancel()}}},rd=e=>{let t=new tW(e);return{videoSampleSource:t,[Symbol.dispose]:()=>{t.close()}}},rh={ref:Promise.resolve()},ru=e=>1e3*2**(e-1),rm=e=>new Promise(t=>{setTimeout(t,e)}),rf={internalRegisterUsageEvent:async({host:e,succeeded:t,event:r,isStill:i,isProduction:a,licenseKey:o})=>{let s;for(let n=1;n<=4;n++){let l=new AbortController,c=setTimeout(()=>{l.abort()},1e4);try{let s=await fetch("https://www.remotion.pro/api/track/register-usage-point",{method:"POST",body:JSON.stringify({event:r,apiKey:o,host:e,succeeded:t,isStill:i,isProduction:a}),headers:{"Content-Type":"application/json"},signal:l.signal});clearTimeout(c);let n=await s.json();if(n.success)return{billable:n.billable,classification:n.classification};if(!s.ok)throw Error(n.error);throw Error(`Unexpected response from server: ${JSON.stringify(n)}`)}catch(t){clearTimeout(c);let e="AbortError"===t.name;if(!(function(e){return!!(e.message.includes("Failed to fetch")||e.message.includes("Load failed")||e.message.includes("NetworkError when attempting to fetch resource"))}(t)||e))throw t;if(s=e?Error("Request timed out after 10 seconds"):t,n<4){let e=ru(n);console.log(`Failed to send usage event (attempt ${n}/4), retrying in ${e}ms...`,t),await rm(e)}}}throw s}},rp=async({licenseKey:e,succeeded:t,apiName:r,isStill:i,isProduction:a})=>{let o="undefined"==typeof window?null:void 0===window.location?null:window.location.origin??null;null!==o&&(null===e&&tE.Xp.Log.warn({logLevel:"warn",tag:"web-renderer"},`Pass "licenseKey" to ${r}(). If you qualify for the Free License (https://remotion.dev/license), pass "free-license" instead.`),await rf.internalRegisterUsageEvent({licenseKey:"free-license"===e?null:e,event:"webcodec-conversion",host:o,succeeded:t,isStill:i,isProduction:a}))},rg=e=>{let t=[];return{checkCleanUpAtBeginningOfIteration:()=>{for(let r=0;r<t.length;){let i=t[r];i.element===e.currentNode||i.element.contains(e.currentNode)?r++:(i.cleanupFn(),t.splice(r,1))}},addCleanup:(e,r)=>{t.unshift({element:e,cleanupFn:r})},[Symbol.dispose]:()=>{for(let e of t)e.cleanupFn()}}},rw=({containerSize:e,intrinsicSize:t})=>({sourceX:0,sourceY:0,sourceWidth:t.width,sourceHeight:t.height,destX:e.left,destY:e.top,destWidth:e.width,destHeight:e.height}),rb=({containerSize:e,intrinsicSize:t})=>{let r,i;let a=e.width/e.height,o=t.width/t.height;o>a?(r=e.width,i=e.width/o):(i=e.height,r=e.height*o);let s=e.left+(e.width-r)/2,n=e.top+(e.height-i)/2;return{sourceX:0,sourceY:0,sourceWidth:t.width,sourceHeight:t.height,destX:s,destY:n,destWidth:r,destHeight:i}},ry=({containerSize:e,intrinsicSize:t})=>{if(e.height<=0||t.height<=0)return{sourceX:0,sourceY:0,sourceWidth:0,sourceHeight:0,destX:e.left,destY:e.top,destWidth:0,destHeight:0};let r=e.width/e.height,i=t.width/t.height,a=0,o=0,s=t.width,n=t.height;return i>r?(s=t.height*r,a=(t.width-s)/2):(n=t.width/r,o=(t.height-n)/2),{sourceX:a,sourceY:o,sourceWidth:s,sourceHeight:n,destX:e.left,destY:e.top,destWidth:e.width,destHeight:e.height}},rk=({containerSize:e,intrinsicSize:t})=>{let r=e.left+(e.width-t.width)/2,i=e.top+(e.height-t.height)/2,a=0,o=0,s=t.width,n=t.height,l=r,c=i,d=t.width,h=t.height;if(l<e.left){let t=e.left-l;a=t,s-=t,l=e.left,d-=t}if(c<e.top){let t=e.top-c;o=t,n-=t,c=e.top,h-=t}let u=e.left+e.width;if(l+d>u){let e=l+d-u;s-=e,d-=e}let m=e.top+e.height;if(c+h>m){let e=c+h-m;n-=e,h-=e}return{sourceX:a,sourceY:o,sourceWidth:s,sourceHeight:n,destX:l,destY:c,destWidth:d,destHeight:h}},rv=({objectFit:e,containerSize:t,intrinsicSize:r})=>{switch(e){case"fill":return rw({containerSize:t,intrinsicSize:r});case"contain":return rb({containerSize:t,intrinsicSize:r});case"cover":return ry({containerSize:t,intrinsicSize:r});case"none":return rk({containerSize:t,intrinsicSize:r});case"scale-down":{let e=rb({containerSize:t,intrinsicSize:r}),i=rk({containerSize:t,intrinsicSize:r});return e.destWidth*e.destHeight<i.destWidth*i.destHeight?e:i}default:throw Error(`Unknown object-fit value: ${e}`)}},rC=e=>{if(!e)return"fill";let t=e.trim().toLowerCase();switch(t){case"fill":case"contain":case"cover":case"none":case"scale-down":return t;default:return"fill"}},rT=({containerSize:e,elementSize:t})=>{if(Math.round(e.width)===Math.round(t.width)&&Math.round(e.height)===Math.round(t.height))return{width:e.width,height:e.height,top:e.top,left:e.left};if(e.width<=0||e.height<=0)throw Error(`Container must have positive dimensions, but got ${e.width}x${e.height}`);if(t.width<=0||t.height<=0)throw Error(`Element must have positive dimensions, but got ${t.width}x${t.height}`);let r=Math.min(e.height/t.height,e.width/t.width),i=t.width*r,a=t.height*r;if(i>e.width+1e-6||a>e.height+1e-6)throw Error(`Element is too big to fit into the container. Max size: ${e.width}x${e.height}, element size: ${i}x${a}`);return{width:i,height:a,top:(e.height-a)/2+e.top,left:(e.width-i)/2+e.left}},rx=e=>{let{fill:t,color:r}=getComputedStyle(e),i=e.style.transform,a=e.style.transformOrigin,o=e.style.marginLeft,s=e.style.marginRight,n=e.style.marginTop,l=e.style.marginBottom,c=e.style.fill,d=e.style.color;e.style.transform="none",e.style.transformOrigin="",e.style.marginLeft="0",e.style.marginRight="0",e.style.marginTop="0",e.style.marginBottom="0",e.style.fill=t,e.style.color=r;let h=new XMLSerializer().serializeToString(e);return e.style.marginLeft=o,e.style.marginRight=s,e.style.marginTop=n,e.style.marginBottom=l,e.style.transform=i,e.style.transformOrigin=a,e.style.fill=c,e.style.color=d,new Promise((e,t)=>{let r=new Image,i=`data:image/svg+xml;base64,${btoa(h)}`;r.onload=function(){e(r)},r.onerror=()=>{t(Error("Failed to convert SVG to image"))},r.src=i})},rE=(e,t)=>e instanceof DOMException?"SecurityError"===e.name?Error(`Could not draw image with src="${t.src}" to canvas: The image is tainted due to CORS restrictions. The server hosting this image must respond with the "Access-Control-Allow-Origin" header. See: https://remotion.dev/docs/client-side-rendering/migration`):"InvalidStateError"===e.name?Error(`Could not draw image with src="${t.src}" to canvas: The image is in a broken state. This usually means the image failed to load - check that the URL is valid and accessible.`):null:null,rS=({drawable:e,dimensions:t,contextToDraw:r})=>{let i=rT({containerSize:t,elementSize:{width:e.width,height:e.height}});r.drawImage(e,i.left,i.top,i.width,i.height)},rM=({drawable:e,dimensions:t,computedStyle:r,contextToDraw:i})=>{let a=rC(r.objectFit),o=e instanceof HTMLImageElement?{width:e.naturalWidth,height:e.naturalHeight}:{width:e.width,height:e.height},s=rv({objectFit:a,containerSize:{width:t.width,height:t.height,left:t.left,top:t.top},intrinsicSize:o});i.drawImage(e,s.sourceX,s.sourceY,s.sourceWidth,s.sourceHeight,s.destX,s.destY,s.destWidth,s.destHeight)},rA=e=>async({dimensions:t,contextToDraw:r,computedStyle:i})=>{if(e instanceof SVGSVGElement){rS({drawable:await rx(e),dimensions:t,contextToDraw:r});return}if(e instanceof HTMLImageElement||e instanceof HTMLCanvasElement)try{rM({drawable:e,dimensions:t,computedStyle:i,contextToDraw:r})}catch(t){if(e instanceof HTMLImageElement){let r=rE(t,e);if(r)throw r}throw t}},r_=e=>"none"!==e.transform&&""!==e.transform,rR=e=>"none"!==e.rotate&&""!==e.rotate,rP=e=>"none"!==e.scale&&""!==e.scale,rz=e=>r_(e)||rR(e)||rP(e),rF=e=>{try{let t=tM.JC.processColor(e);return null!=t}catch{return!1}},rW=e=>{let t=e.trim().toLowerCase();if(t.startsWith("to "))switch(t.substring(3).trim()){case"top":return 0;case"right":return 90;case"bottom":default:return 180;case"left":return 270;case"top right":case"right top":return 45;case"bottom right":case"right bottom":return 135;case"bottom left":case"left bottom":return 225;case"top left":case"left top":return 315}let r=t.match(/^(-?\d+\.?\d*)(deg|rad|grad|turn)$/);if(r){let e=parseFloat(r[1]);switch(r[2]){case"deg":default:return e;case"rad":return 180*e/Math.PI;case"grad":return 360*e/400;case"turn":return 360*e}}return 180},rI=e=>{let t=e.split(/,(?![^(]*\))/),r=[];for(let e of t){let t=e.trim();if(!t)continue;let i=t.match(/(rgba?\([^)]+\)|hsla?\([^)]+\)|#[0-9a-f]{3,8}|[a-z]+)/i);if(!i)continue;let a=i[0];if(!rF(a))continue;let o=t.substring(i.index+a.length).trim(),s=null;if(o){let e=o.match(/(-?\d+\.?\d*)(%|px)?/);if(e){let t=parseFloat(e[1]),r=e[2];s="%"===r?t/100:"px"===r?null:t/100}}r.push({color:a,position:null!==s?s:-1})}if(0===r.length)return null;let i=-1,a=0;for(let e=0;e<r.length;e++)if(-1!==r[e].position){if(i>=0){let t=e-i-1;if(t>0){let o=(r[e].position-a)/(t+1);for(let t=i+1;t<e;t++)r[t].position=a+o*(t-i)}}else{let t=e;if(t>0){let i=r[e].position/(t+1);for(let t=0;t<e;t++)r[t].position=i*(t+1)}}i=e,a=r[e].position}if(r.every(e=>-1===e.position)){if(1===r.length)r[0].position=.5;else for(let e=0;e<r.length;e++)r[e].position=e/(r.length-1)}else if(i<r.length-1){let e=(1-a)/(r.length-1-i+1);for(let t=i+1;t<r.length;t++)r[t].position=a+e*(t-i)}for(let e of r)e.position=Math.max(0,Math.min(1,e.position));return r},rL=e=>{let t="linear-gradient(",r=e.toLowerCase().indexOf(t);if(-1===r)return null;let i=0,a=r+t.length;for(let t=a;t<e.length;t++){let r=e[t];if("("===r)i++;else if(")"===r){if(0===i)return e.substring(a,t).trim();i--}}return null},rO=e=>{if(!e||"none"===e)return null;let t=rL(e);if(!t)return null;let r=t.split(/,(?![^(]*\))/),i=180,a=0;if(r.length>0){let e=r[0].trim();(e.startsWith("to ")||/^-?\d+\.?\d*(deg|rad|grad|turn)$/.test(e))&&(i=rW(e),a=1)}let o=rI(r.slice(a).join(","));return o&&0!==o.length?{angle:i,colorStops:o}:null},rD=({ctx:e,rect:t,gradientInfo:r,offsetLeft:i,offsetTop:a})=>{let o=(r.angle-90)*Math.PI/180,s=t.left-i+t.width/2,n=t.top-a+t.height/2,l=Math.cos(o),c=Math.sin(o),d=t.width/2,h=t.height/2,u=Math.abs(l)*d+Math.abs(c)*h;Number.isFinite(u)&&0!==u||(u=Math.sqrt(d**2+h**2));let m=s-l*u,f=n-c*u,p=s+l*u,g=n+c*u,w=e.createLinearGradient(m,f,p,g);for(let e of r.colorStops)w.addColorStop(e.position,e.color);return w},rB=e=>{let{maskImage:t,webkitMaskImage:r}=e,i=t||r;return i&&"none"!==i?i:null},rU=e=>rO(e),rN=e=>{if(""===e.trim())return null;let[t,r]=e.split(" ");return{x:parseFloat(t),y:parseFloat(r)}},r$=e=>{let t=e.boundingClientRect.width/2,r=e.boundingClientRect.height/2;return rN(e.transformOrigin)??{x:t,y:r}},rV=({transform:e})=>{let{x:t,y:r}=r$(e);return{x:t+e.boundingClientRect.left,y:r+e.boundingClientRect.top}},rH=({element:e,rootElement:t})=>{let r=e,i=[],a=[],o=1,s=null,n=null;for(;r;){let l=getComputedStyle(r);if(r===e){s=l,o=parseFloat(l.opacity);let e=rB(l);n=e?rU(e):null;let t=r.style.maskImage,i=r.style.webkitMaskImage;r.style.maskImage="none",r.style.webkitMaskImage="none";let c=r;a.push(()=>{c.style.maskImage=t,c.style.webkitMaskImage=i})}if(rz(l)||r===e){let e=new DOMMatrix(r_(l)?l.transform:void 0),{transform:t,scale:o,rotate:s}=r.style,n=[];""!==s&&"none"!==s&&n.push(new DOMMatrix(`rotate(${s})`)),""!==o&&"none"!==o&&n.push(new DOMMatrix(`scale(${o})`)),n.push(e),r.style.transform="none",r.style.scale="none",r.style.rotate="none",i.push({element:r,transformOrigin:l.transformOrigin,boundingClientRect:null,matrices:n});let c=r;a.push(()=>{c.style.transform=t,c.style.scale=o,c.style.rotate=s})}if(r===t)break;r=r.parentElement}for(let e of i)e.boundingClientRect=e.element.getBoundingClientRect();let l=i[0].boundingClientRect,c=r$(i[0]),d=new DOMMatrix;for(let e of i.slice().reverse())for(let t of e.matrices){let r=rV({transform:e}),i=new DOMMatrix().translate(r.x,r.y).multiply(t).translate(-r.x,-r.y);d.multiplySelf(i)}if(!s)throw Error("Element computed style not found");let h=!d.is2D,u=null!==n;return{dimensions:l,totalMatrix:d,[Symbol.dispose]:()=>{for(let e of a)e()},nativeTransformOrigin:c,computedStyle:s,opacity:o,maskImageInfo:n,precompositing:{needs3DTransformViaWebGL:h,needsMaskImage:n,needsPrecompositing:!!(h||u)}}},rQ=e=>{let t=Math.floor(e.left),r=Math.floor(e.top);return new DOMRect(t,r,Math.ceil(e.right)-t,Math.ceil(e.bottom)-r)},rj=({firstRect:e,secondRect:t})=>{let r=Math.max(e.left,t.left),i=Math.max(e.top,t.top),a=Math.min(e.bottom,t.bottom);return new DOMRect(r,i,Math.min(e.right,t.right)-r,a-i)},rq=({firstRect:e,secondRect:t})=>{if(null===e)return rQ(t);let r=Math.min(e.left,t.left),i=Math.min(e.top,t.top),a=Math.max(e.bottom,t.bottom);return rQ(new DOMRect(r,i,Math.max(e.right,t.right)-r,a-i))},rX=({ctx:e,x:t,y:r,width:i,height:a,borderRadius:o})=>{e.beginPath(),e.moveTo(t+o.topLeft.horizontal,r),e.lineTo(t+i-o.topRight.horizontal,r),(o.topRight.horizontal>0||o.topRight.vertical>0)&&e.ellipse(t+i-o.topRight.horizontal,r+o.topRight.vertical,o.topRight.horizontal,o.topRight.vertical,0,-Math.PI/2,0),e.lineTo(t+i,r+a-o.bottomRight.vertical),(o.bottomRight.horizontal>0||o.bottomRight.vertical>0)&&e.ellipse(t+i-o.bottomRight.horizontal,r+a-o.bottomRight.vertical,o.bottomRight.horizontal,o.bottomRight.vertical,0,0,Math.PI/2),e.lineTo(t+o.bottomLeft.horizontal,r+a),(o.bottomLeft.horizontal>0||o.bottomLeft.vertical>0)&&e.ellipse(t+o.bottomLeft.horizontal,r+a-o.bottomLeft.vertical,o.bottomLeft.horizontal,o.bottomLeft.vertical,0,Math.PI/2,Math.PI),e.lineTo(t,r+o.topLeft.vertical),(o.topLeft.horizontal>0||o.topLeft.vertical>0)&&e.ellipse(t+o.topLeft.horizontal,r+o.topLeft.vertical,o.topLeft.horizontal,o.topLeft.vertical,0,Math.PI,3*Math.PI/2),e.closePath()},rG=(e,t)=>{let r=parseFloat(t.borderLeftWidth),i=parseFloat(t.borderRightWidth),a=parseFloat(t.borderTopWidth),o=parseFloat(t.borderBottomWidth);return new DOMRect(e.left+r,e.top+a,e.width-r-i,e.height-a-o)},rK=(e,t)=>{let r=rG(e,t),i=parseFloat(t.paddingLeft),a=parseFloat(t.paddingRight),o=parseFloat(t.paddingTop),s=parseFloat(t.paddingBottom);return new DOMRect(r.left+i,r.top+o,r.width-i-a,r.height-o-s)},rY=(e,t,r)=>!r||r.includes("text")?e:r.includes("padding-box")?rG(e,t):r.includes("content-box")?rK(e,t):e;function rZ({value:e,reference:t}){return(e=e.trim()).endsWith("%")?parseFloat(e)/100*t:(e.endsWith("px"),parseFloat(e))}function rJ(e){return 1===e.length?[e[0],e[0],e[0],e[0]]:2===e.length?[e[0],e[1],e[0],e[1]]:3===e.length?[e[0],e[1],e[2],e[1]]:[e[0],e[1],e[2],e[3]]}function r0({ctx:e,rect:t,borderRadius:r,forceClipEvenWhenZero:i=!1,computedStyle:a,backgroundClip:o}){if(0===r.topLeft.horizontal&&0===r.topLeft.vertical&&0===r.topRight.horizontal&&0===r.topRight.vertical&&0===r.bottomRight.horizontal&&0===r.bottomRight.vertical&&0===r.bottomLeft.horizontal&&0===r.bottomLeft.vertical&&!i)return()=>{};e.save();let s=rY(t,a,o),n={topLeft:{horizontal:Math.max(0,r.topLeft.horizontal-(s.left-t.left)),vertical:Math.max(0,r.topLeft.vertical-(s.top-t.top))},topRight:{horizontal:Math.max(0,r.topRight.horizontal-(t.right-s.right)),vertical:Math.max(0,r.topRight.vertical-(s.top-t.top))},bottomRight:{horizontal:Math.max(0,r.bottomRight.horizontal-(t.right-s.right)),vertical:Math.max(0,r.bottomRight.vertical-(t.bottom-s.bottom))},bottomLeft:{horizontal:Math.max(0,r.bottomLeft.horizontal-(s.left-t.left)),vertical:Math.max(0,r.bottomLeft.vertical-(t.bottom-s.bottom))}};return rX({ctx:e,x:s.left,y:s.top,width:s.width,height:s.height,borderRadius:n}),e.clip(),()=>{e.restore()}}var r1=e=>"transparent"===e||e.startsWith("rgba")&&(e.endsWith(", 0)")||e.endsWith(",0")),r2=({backgroundColor:e,backgroundImage:t,contextToDraw:r,boundingRect:i,offsetLeft:a,offsetTop:o})=>{if(t&&"none"!==t){let e=rO(t);if(e)return rD({ctx:r,rect:i,gradientInfo:e,offsetLeft:a,offsetTop:o})}return e&&"transparent"!==e&&!r1(e)?e:null},r3=async({backgroundImage:e,context:t,rect:r,backgroundColor:i,backgroundClip:a,element:o,logLevel:s,internalState:n,computedStyle:l,offsetLeft:c,offsetTop:d,scale:h})=>{let u=[];try{let m=t,f=t.globalCompositeOperation,p=0,g=0;tX(u,{[Symbol.dispose]:()=>{t.globalCompositeOperation=f,t!==m&&t.drawImage(m.canvas,p,g,m.canvas.width/h,m.canvas.height/h)}},0);let w=rY(r,l,a);if(a.includes("text")){p=w.left,g=w.top;let e=o.style.backgroundClip,t=o.style.webkitBackgroundClip;o.style.backgroundClip="initial",o.style.webkitBackgroundClip="initial";let r=await iW({element:o,cutout:new DOMRect(w.left+c,w.top+d,w.width,w.height),logLevel:s,internalState:n,scale:h,onlyBackgroundClipText:!0});r.setTransform(new DOMMatrix().scale(h,h)),o.style.backgroundClip=e,o.style.webkitBackgroundClip=t,(m=r).globalCompositeOperation="source-in"}let b=r2({backgroundImage:e,backgroundColor:i,contextToDraw:m,boundingRect:w,offsetLeft:p,offsetTop:g});if(!b)return;let y=m.fillStyle;m.fillStyle=b,m.fillRect(w.left-p,w.top-g,w.width,w.height),m.fillStyle=y}catch(e){var m=e,f=1}finally{tG(u,m,f)}},r4=e=>parseFloat(e)||0,r6=e=>({top:{width:r4(e.borderTopWidth),color:e.borderTopColor||e.borderColor||"black",style:e.borderTopStyle||e.borderStyle||"solid"},right:{width:r4(e.borderRightWidth),color:e.borderRightColor||e.borderColor||"black",style:e.borderRightStyle||e.borderStyle||"solid"},bottom:{width:r4(e.borderBottomWidth),color:e.borderBottomColor||e.borderColor||"black",style:e.borderBottomStyle||e.borderStyle||"solid"},left:{width:r4(e.borderLeftWidth),color:e.borderLeftColor||e.borderColor||"black",style:e.borderLeftStyle||e.borderStyle||"solid"}}),r8=(e,t)=>"dashed"===e?[2*t,t]:"dotted"===e?[t,t]:[],r5=({ctx:e,side:t,x:r,y:i,width:a,height:o,borderRadius:s,borderProperties:n})=>{let{width:l,color:c,style:d}=n;if(l<=0||"none"===d||"hidden"===d)return;e.beginPath(),e.strokeStyle=c,e.lineWidth=l,e.setLineDash(r8(d,l));let h=l/2;if("top"===t){let t=r+s.topLeft.horizontal,o=r+a-s.topRight.horizontal;e.moveTo(t,i+h),e.lineTo(o,i+h)}else if("right"===t){let t=i+s.topRight.vertical,n=i+o-s.bottomRight.vertical;e.moveTo(r+a-h,t),e.lineTo(r+a-h,n)}else if("bottom"===t){let t=r+s.bottomLeft.horizontal,n=r+a-s.bottomRight.horizontal;e.moveTo(t,i+o-h),e.lineTo(n,i+o-h)}else if("left"===t){let t=i+s.topLeft.vertical,a=i+o-s.bottomLeft.vertical;e.moveTo(r+h,t),e.lineTo(r+h,a)}e.stroke()},r7=({ctx:e,corner:t,x:r,y:i,width:a,height:o,borderRadius:s,topBorder:n,rightBorder:l,bottomBorder:c,leftBorder:d})=>{let h,u,m,f,p,g;let w=s[t];if(w.horizontal<=0&&w.vertical<=0)return;"topLeft"===t?(h=d,u=n,m=r+w.horizontal,f=i+w.vertical,p=Math.PI,g=3*Math.PI/2):"topRight"===t?(h=n,u=l,m=r+a-w.horizontal,f=i+w.vertical,p=-Math.PI/2,g=0):"bottomRight"===t?(h=l,u=c,m=r+a-w.horizontal,f=i+o-w.vertical,p=0,g=Math.PI/2):(h=c,u=d,m=r+w.horizontal,f=i+o-w.vertical,p=Math.PI/2,g=Math.PI);let b=(h.width+u.width)/2,y=h.width>=u.width?h.color:u.color,k=h.width>=u.width?h.style:u.style;if(b>0&&"none"!==k&&"hidden"!==k){e.beginPath(),e.strokeStyle=y,e.lineWidth=b,e.setLineDash(r8(k,b));let t=Math.max(0,w.horizontal-b/2),r=Math.max(0,w.vertical-b/2);e.ellipse(m,f,t,r,0,p,g),e.stroke()}},r9=({ctx:e,x:t,y:r,width:i,height:a,borderRadius:o,borderWidth:s,borderColor:n,borderStyle:l})=>{e.beginPath(),e.strokeStyle=n,e.lineWidth=s,e.setLineDash(r8(l,s));let c=s/2,d=t+c,h=r+c,u=i-s,m=a-s,f={topLeft:{horizontal:Math.max(0,o.topLeft.horizontal-c),vertical:Math.max(0,o.topLeft.vertical-c)},topRight:{horizontal:Math.max(0,o.topRight.horizontal-c),vertical:Math.max(0,o.topRight.vertical-c)},bottomRight:{horizontal:Math.max(0,o.bottomRight.horizontal-c),vertical:Math.max(0,o.bottomRight.vertical-c)},bottomLeft:{horizontal:Math.max(0,o.bottomLeft.horizontal-c),vertical:Math.max(0,o.bottomLeft.vertical-c)}};e.moveTo(d+f.topLeft.horizontal,h),e.lineTo(d+u-f.topRight.horizontal,h),(f.topRight.horizontal>0||f.topRight.vertical>0)&&e.ellipse(d+u-f.topRight.horizontal,h+f.topRight.vertical,f.topRight.horizontal,f.topRight.vertical,0,-Math.PI/2,0),e.lineTo(d+u,h+m-f.bottomRight.vertical),(f.bottomRight.horizontal>0||f.bottomRight.vertical>0)&&e.ellipse(d+u-f.bottomRight.horizontal,h+m-f.bottomRight.vertical,f.bottomRight.horizontal,f.bottomRight.vertical,0,0,Math.PI/2),e.lineTo(d+f.bottomLeft.horizontal,h+m),(f.bottomLeft.horizontal>0||f.bottomLeft.vertical>0)&&e.ellipse(d+f.bottomLeft.horizontal,h+m-f.bottomLeft.vertical,f.bottomLeft.horizontal,f.bottomLeft.vertical,0,Math.PI/2,Math.PI),e.lineTo(d,h+f.topLeft.vertical),(f.topLeft.horizontal>0||f.topLeft.vertical>0)&&e.ellipse(d+f.topLeft.horizontal,h+f.topLeft.vertical,f.topLeft.horizontal,f.topLeft.vertical,0,Math.PI,3*Math.PI/2),e.closePath(),e.stroke()},ie=({ctx:e,rect:t,borderRadius:r,computedStyle:i})=>{let a=r6(i);if(!(a.top.width>0||a.right.width>0||a.bottom.width>0||a.left.width>0))return;let o=e.strokeStyle,s=e.lineWidth,n=e.getLineDash();a.top.width===a.right.width&&a.top.width===a.bottom.width&&a.top.width===a.left.width&&a.top.color===a.right.color&&a.top.color===a.bottom.color&&a.top.color===a.left.color&&a.top.style===a.right.style&&a.top.style===a.bottom.style&&a.top.style===a.left.style&&a.top.width>0?r9({ctx:e,x:t.left,y:t.top,width:t.width,height:t.height,borderRadius:r,borderWidth:a.top.width,borderColor:a.top.color,borderStyle:a.top.style}):(r7({ctx:e,corner:"topLeft",x:t.left,y:t.top,width:t.width,height:t.height,borderRadius:r,topBorder:a.top,rightBorder:a.right,bottomBorder:a.bottom,leftBorder:a.left}),r7({ctx:e,corner:"topRight",x:t.left,y:t.top,width:t.width,height:t.height,borderRadius:r,topBorder:a.top,rightBorder:a.right,bottomBorder:a.bottom,leftBorder:a.left}),r7({ctx:e,corner:"bottomRight",x:t.left,y:t.top,width:t.width,height:t.height,borderRadius:r,topBorder:a.top,rightBorder:a.right,bottomBorder:a.bottom,leftBorder:a.left}),r7({ctx:e,corner:"bottomLeft",x:t.left,y:t.top,width:t.width,height:t.height,borderRadius:r,topBorder:a.top,rightBorder:a.right,bottomBorder:a.bottom,leftBorder:a.left}),r5({ctx:e,side:"top",x:t.left,y:t.top,width:t.width,height:t.height,borderRadius:r,borderProperties:a.top}),r5({ctx:e,side:"right",x:t.left,y:t.top,width:t.width,height:t.height,borderRadius:r,borderProperties:a.right}),r5({ctx:e,side:"bottom",x:t.left,y:t.top,width:t.width,height:t.height,borderRadius:r,borderProperties:a.bottom}),r5({ctx:e,side:"left",x:t.left,y:t.top,width:t.width,height:t.height,borderRadius:r,borderProperties:a.left})),e.strokeStyle=o,e.lineWidth=s,e.setLineDash(n)},it=e=>{if(!e||"none"===e)return[];let t=[];for(let r of e.split(/,(?![^(]*\))/)){let e=r.trim();if(!e||"none"===e)continue;let i={offsetX:0,offsetY:0,blurRadius:0,color:"rgba(0, 0, 0, 0.5)",inset:!1};i.inset=/\binset\b/i.test(e);let a=e.replace(/\binset\b/gi,"").trim(),o=a.match(/(rgba?\([^)]+\)|hsla?\([^)]+\)|#[0-9a-f]{3,8}|[a-z]+)/i);o&&(i.color=o[0],a=a.replace(o[0],"").trim());let s=(a.match(/[+-]?\d*\.?\d+(?:px|em|rem|%)?/gi)||[]).map(e=>parseFloat(e)||0);s.length>=2&&(i.offsetX=s[0],i.offsetY=s[1],s.length>=3&&(i.blurRadius=Math.max(0,s[2]))),t.push(i)}return t},ir=({ctx:e,rect:t,borderRadius:r,computedStyle:i,logLevel:a})=>{let o=it(i.boxShadow);if(0!==o.length)for(let i=o.length-1;i>=0;i--){let s=o[i],n=t.left+Math.min(s.offsetX,0)-s.blurRadius,l=t.right+Math.max(s.offsetX,0)+s.blurRadius,c=t.top+Math.min(s.offsetY,0)-s.blurRadius,d=new DOMRect(n,c,l-n,t.bottom+Math.max(s.offsetY,0)+s.blurRadius-c),h=t.left-n,u=t.top-c,m=new OffscreenCanvas(d.width,d.height),f=m.getContext("2d");if(!f)throw Error("Failed to get context");if(s.inset){tE.Xp.Log.warn({logLevel:a,tag:"@remotion/web-renderer"},'Detected "box-shadow" with "inset". This is not yet supported in @remotion/web-renderer');continue}f.shadowBlur=s.blurRadius,f.shadowColor=s.color,f.shadowOffsetX=s.offsetX,f.shadowOffsetY=s.offsetY,f.fillStyle="black",rX({ctx:f,x:h,y:u,width:t.width,height:t.height,borderRadius:r}),f.fill(),f.shadowColor="transparent",f.globalCompositeOperation="destination-out",rX({ctx:f,x:h,y:u,width:t.width,height:t.height,borderRadius:r}),f.fill(),e.drawImage(m,t.left-h,t.top-u)}},ii=e=>parseFloat(e)||0,ia=e=>parseFloat(e)||0,io=(e,t)=>"dashed"===e?[2*t,t]:"dotted"===e?[t,t]:[],is=({ctx:e,rect:t,borderRadius:r,computedStyle:i})=>{let a=ii(i.outlineWidth),{outlineStyle:o}=i,s=i.outlineColor||"black",n=ia(i.outlineOffset);if(a<=0||"none"===o||"hidden"===o)return;let l=e.strokeStyle,c=e.lineWidth,d=e.getLineDash();e.strokeStyle=s,e.lineWidth=a,e.setLineDash(io(o,a));let h=n+a/2,u=t.left-h,m=t.top-h,f=t.width+2*h;rX({ctx:e,x:u,y:m,width:f,height:t.height+2*h,borderRadius:{topLeft:{horizontal:0===r.topLeft.horizontal?0:Math.max(0,r.topLeft.horizontal+h),vertical:0===r.topLeft.vertical?0:Math.max(0,r.topLeft.vertical+h)},topRight:{horizontal:0===r.topRight.horizontal?0:Math.max(0,r.topRight.horizontal+h),vertical:0===r.topRight.vertical?0:Math.max(0,r.topRight.vertical+h)},bottomRight:{horizontal:0===r.bottomRight.horizontal?0:Math.max(0,r.bottomRight.horizontal+h),vertical:0===r.bottomRight.vertical?0:Math.max(0,r.bottomRight.vertical+h)},bottomLeft:{horizontal:0===r.bottomLeft.horizontal?0:Math.max(0,r.bottomLeft.horizontal+h),vertical:0===r.bottomLeft.vertical?0:Math.max(0,r.bottomLeft.vertical+h)}}}),e.stroke(),e.strokeStyle=l,e.lineWidth=c,e.setLineDash(d)},il=({ctx:e,opacity:t})=>{let r=e.globalAlpha;return e.globalAlpha=r*t,()=>{e.globalAlpha=r}},ic=({ctx:e,rect:t,borderRadius:r,overflowHidden:i,computedStyle:a,backgroundClip:o})=>i?r0({ctx:e,rect:t,borderRadius:r,forceClipEvenWhenZero:!0,computedStyle:a,backgroundClip:o}):()=>{},id=({ctx:e,transform:t,parentRect:r,scale:i})=>{let a=new DOMMatrix().scale(i,i).translate(-r.x,-r.y).multiply(t).translate(r.x,r.y);return e.setTransform(a),()=>{e.setTransform(new DOMMatrix)}},ih=async({rect:e,computedStyle:t,context:r,draw:i,opacity:a,totalMatrix:o,parentRect:s,logLevel:n,element:l,internalState:c,scale:d})=>{let{backgroundImage:h,backgroundColor:u,backgroundClip:m}=t,f=function({borderRadius:e,width:t,height:r}){let i=e.split("/").map(e=>e.trim()),a=i[0],o=i[1],s=a.split(/\s+/).filter(e=>e),n=o?o.split(/\s+/).filter(e=>e):s,[l,c,d,h]=rJ(s),[u,m,f,p]=rJ(n);return function({borderRadius:e,width:t,height:r}){let i={topLeft:{...e.topLeft},topRight:{...e.topRight},bottomRight:{...e.bottomRight},bottomLeft:{...e.bottomLeft}},a=i.topLeft.horizontal+i.topRight.horizontal;if(a>t){let e=t/a;i.topLeft.horizontal*=e,i.topRight.horizontal*=e}let o=i.topRight.vertical+i.bottomRight.vertical;if(o>r){let e=r/o;i.topRight.vertical*=e,i.bottomRight.vertical*=e}let s=i.bottomRight.horizontal+i.bottomLeft.horizontal;if(s>t){let e=t/s;i.bottomRight.horizontal*=e,i.bottomLeft.horizontal*=e}let n=i.bottomLeft.vertical+i.topLeft.vertical;if(n>r){let e=r/n;i.bottomLeft.vertical*=e,i.topLeft.vertical*=e}return i}({borderRadius:{topLeft:{horizontal:rZ({value:l,reference:t}),vertical:rZ({value:u,reference:r})},topRight:{horizontal:rZ({value:c,reference:t}),vertical:rZ({value:m,reference:r})},bottomRight:{horizontal:rZ({value:d,reference:t}),vertical:rZ({value:f,reference:r})},bottomLeft:{horizontal:rZ({value:h,reference:t}),vertical:rZ({value:p,reference:r})}},width:t,height:r})}({borderRadius:t.borderRadius,width:e.width,height:e.height}),p=id({ctx:r,transform:o,parentRect:s,scale:d}),g=il({ctx:r,opacity:a});ir({ctx:r,computedStyle:t,rect:e,borderRadius:f,logLevel:n});let w=r0({ctx:r,rect:e,borderRadius:f,forceClipEvenWhenZero:!1,computedStyle:t,backgroundClip:m});await r3({backgroundImage:h,context:r,rect:e,backgroundColor:u,backgroundClip:m,element:l,logLevel:n,internalState:c,computedStyle:t,offsetLeft:s.left,offsetTop:s.top,scale:d}),await i({dimensions:e,computedStyle:t,contextToDraw:r}),w(),ie({ctx:r,rect:e,borderRadius:f,computedStyle:t}),is({ctx:r,rect:e,borderRadius:f,computedStyle:t});let b=ic({ctx:r,rect:e,borderRadius:f,overflowHidden:"hidden"===t.overflow,computedStyle:t,backgroundClip:m});return p(),{cleanupAfterChildren:()=>{g(),b()}}};function iu(e){if(e.nextSibling())return!0;for(;e.parentNode();)if(e.nextSibling())return!0;return!1}var im=e=>{let t=document.createTreeWalker(e,NodeFilter.SHOW_ELEMENT),r=1/0,i=1/0,a=-1/0,o=-1/0;for(;;){let e=getComputedStyle(t.currentNode),s=ii(e.outlineWidth),n=ia(e.outlineOffset),l=t.currentNode.getBoundingClientRect(),c=it(e.boxShadow),d=0,h=0,u=0,m=0;for(let e of c)e.inset||(d=Math.max(d,Math.abs(Math.min(e.offsetX,0))+e.blurRadius),h=Math.max(h,Math.max(e.offsetX,0)+e.blurRadius),u=Math.max(u,Math.abs(Math.min(e.offsetY,0))+e.blurRadius),m=Math.max(m,Math.max(e.offsetY,0)+e.blurRadius));if(r=Math.min(r,l.left-n-s-d),i=Math.min(i,l.top-n-s-u),a=Math.max(a,l.right+n+s+h),o=Math.max(o,l.bottom+n+s+m),"hidden"===e.overflow&&!iu(t)||!t.nextNode())break}return new DOMRect(r,i,a-r,o-i)},ip=e=>{let t=new DOMPoint(0,0).matrixTransform(e),r=new DOMPoint(1,0).matrixTransform(e),i=new DOMPoint(0,1).matrixTransform(e),a={x:r.x-t.x,y:r.y-t.y},o={x:i.x-t.x,y:i.y-t.y};return Math.max(1/Math.hypot(a.x,a.y),1/Math.hypot(o.x,o.y))>100},ig=`
    attribute vec2 aPosition;
    attribute vec2 aTexCoord;
    uniform mat4 uTransform;
    uniform vec2 uResolution;
    uniform vec2 uOffset;
    varying vec2 vTexCoord;

    void main() {
        vec4 pos = uTransform * vec4(aPosition, 0.0, 1.0);
        pos.xy = pos.xy + uOffset * pos.w;

        // Convert homogeneous coords to clip space
        gl_Position = vec4(
            (pos.x / uResolution.x) * 2.0 - pos.w,   // x
            pos.w - (pos.y / uResolution.y) * 2.0,   // y (flipped)
            0.0,
            pos.w
        );

        vTexCoord = aTexCoord;
    }
`,iw=`
		precision mediump float;
		uniform sampler2D uTexture;
		varying vec2 vTexCoord;

		void main() {
				gl_FragColor = texture2D(uTexture, vTexCoord);
		}
`;function ib(e,t,r){let i=e.createShader(r);if(!i)throw Error("Could not create shader");if(e.shaderSource(i,t),e.compileShader(i),!e.getShaderParameter(i,e.COMPILE_STATUS)){let t=e.getShaderInfoLog(i);throw e.deleteShader(i),Error("Shader compile error: "+t)}return i}var iy=({canvasWidth:e,canvasHeight:t,helperCanvasState:r})=>{if(r.current)return(r.current.canvas.width!==e||r.current.canvas.height!==t)&&(r.current.canvas.width=e,r.current.canvas.height=t),r.current.gl.viewport(0,0,e,t),r.current.gl.clearColor(0,0,0,0),r.current.gl.clear(r.current.gl.COLOR_BUFFER_BIT),r.current;let i=new OffscreenCanvas(e,t),a=i.getContext("webgl",{premultipliedAlpha:!0})??void 0;if(!a)throw Error("WebGL not supported");let o=ib(a,ig,a.VERTEX_SHADER),s=ib(a,iw,a.FRAGMENT_SHADER),n=a.createProgram();if(!n)throw Error("Could not create program");if(a.attachShader(n,o),a.attachShader(n,s),a.linkProgram(n),!a.getProgramParameter(n,a.LINK_STATUS))throw Error("Program link error: "+a.getProgramInfoLog(n));let l={aPosition:a.getAttribLocation(n,"aPosition"),aTexCoord:a.getAttribLocation(n,"aTexCoord"),uTransform:a.getUniformLocation(n,"uTransform"),uResolution:a.getUniformLocation(n,"uResolution"),uOffset:a.getUniformLocation(n,"uOffset"),uTexture:a.getUniformLocation(n,"uTexture")};return a.deleteShader(o),a.deleteShader(s),r.current={canvas:i,gl:a,program:n,locations:l,cleanup:()=>{a.deleteProgram(n);let e=a.getExtension("WEBGL_lose_context");e&&e.loseContext()}},r.current},ik=({matrix:e,sourceCanvas:t,sourceRect:r,destRect:i,internalState:a,scale:o})=>{let{canvas:s,gl:n,program:l,locations:c}=iy({canvasWidth:i.width,canvasHeight:i.height,helperCanvasState:a.helperCanvasState});n.useProgram(l),n.viewport(0,0,i.width,i.height),n.clearColor(0,0,0,0),n.clear(n.COLOR_BUFFER_BIT),n.enable(n.BLEND),n.blendFunc(n.ONE,n.ONE_MINUS_SRC_ALPHA),n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0);let d=n.createBuffer();n.bindBuffer(n.ARRAY_BUFFER,d);let h=new Float32Array([r.x,r.y,r.x+r.width,r.y,r.x,r.y+r.height,r.x,r.y+r.height,r.x+r.width,r.y,r.x+r.width,r.y+r.height]);n.bufferData(n.ARRAY_BUFFER,h,n.STATIC_DRAW),n.enableVertexAttribArray(c.aPosition),n.vertexAttribPointer(c.aPosition,2,n.FLOAT,!1,0,0);let u=n.createBuffer();n.bindBuffer(n.ARRAY_BUFFER,u);let m=new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]);n.bufferData(n.ARRAY_BUFFER,m,n.STATIC_DRAW),n.enableVertexAttribArray(c.aTexCoord),n.vertexAttribPointer(c.aTexCoord,2,n.FLOAT,!1,0,0);let f=n.createTexture();n.bindTexture(n.TEXTURE_2D,f),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.LINEAR),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.LINEAR),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,n.RGBA,n.UNSIGNED_BYTE,t);let p=(1!==o?new DOMMatrix().scale(o,o).multiply(e):e).toFloat32Array();return n.uniformMatrix4fv(c.uTransform,!1,p),n.uniform2f(c.uResolution,i.width,i.height),n.uniform2f(c.uOffset,-i.x,-i.y),n.uniform1i(c.uTexture,0),n.drawArrays(n.TRIANGLES,0,6),n.disableVertexAttribArray(c.aPosition),n.disableVertexAttribArray(c.aTexCoord),n.deleteTexture(f),n.deleteBuffer(d),n.deleteBuffer(u),n.bindTexture(n.TEXTURE_2D,null),n.bindBuffer(n.ARRAY_BUFFER,null),n.disable(n.BLEND),n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),s},iv=({element:e,parentRect:t,matrix:r})=>{let i=im(e),a=function(e,t){if(ip(t))return null;let r=[{x:e.x,y:e.y},{x:e.x+e.width,y:e.y},{x:e.x+e.width,y:e.y+e.height},{x:e.x,y:e.y+e.height}],i=[];for(let e of r){let r=function(e,t,r){let i=r.m11-e*r.m14,a=r.m21-e*r.m24,o=e*r.m44-r.m41,s=r.m12-t*r.m14,n=r.m22-t*r.m24,l=t*r.m44-r.m42,c=i*n-a*s;return 1e-10>Math.abs(c)?null:{x:(o*n-a*l)/c,y:(i*l-o*s)/c}}(e.x,e.y,t);if(null===r)return null;i.push(r)}let a=i.map(e=>e.x),o=i.map(e=>e.y);return new DOMRect(Math.min(...a),Math.min(...o),Math.max(...a)-Math.min(...a),Math.max(...o)-Math.min(...o))}(t,r);return a?rj({firstRect:i,secondRect:a}):null},iC=({matrix:e,sourceRect:t,tempCanvas:r,rectAfterTransforms:i,internalState:a,scale:o})=>i.width<=0||i.height<=0?null:ik({sourceRect:t,matrix:e,sourceCanvas:r,destRect:i,internalState:a,scale:o}),iT=e=>im(e),ix=({gradientInfo:e,rect:t,precomposeRect:r,tempContext:i,scale:a})=>{let o=new DOMRect((t.left-r.left)*a,(t.top-r.top)*a,t.width*a,t.height*a),s=rD({ctx:i,rect:o,gradientInfo:e,offsetLeft:0,offsetTop:0});i.globalCompositeOperation="destination-in",i.fillStyle=s,i.fillRect(o.left,o.top,o.width,o.height)},iE=({rect:e,scale:t})=>new DOMRect(e.x*t,e.y*t,e.width*t,e.height*t),iS=async({element:e,context:t,draw:r,logLevel:i,parentRect:a,internalState:o,rootElement:s,scale:n})=>{let l=[];try{let{opacity:c,computedStyle:d,totalMatrix:h,dimensions:u,precompositing:m}=tX(l,rH({element:e,rootElement:s}),0);if(0===c||"hidden"===d.backfaceVisibility&&h.m33<0)return{type:"skip-children"};if(u.width<=0||u.height<=0)return{type:"continue",cleanupAfterChildren:null};let f=new DOMRect(u.left-a.x,u.top-a.y,u.width,u.height);if(m.needsPrecompositing){let r=Date.now(),s=null;if(m.needsMaskImage&&(s=rQ(iT(e))),m.needs3DTransformViaWebGL){let t=iv({element:e,parentRect:a,matrix:h});if(!t)return{type:"continue",cleanupAfterChildren:null};s=rQ(rq({firstRect:s,secondRect:t}))}if(!s)throw Error("Precompose rect not found");if(s.width<=0||s.height<=0||!function(e,t){return!(e.right<=t.left||e.left>=t.right||e.bottom<=t.top||e.top>=t.bottom)}(s,a))return{type:"continue",cleanupAfterChildren:null};let l=await iW({cutout:s,element:e,logLevel:i,internalState:o,scale:n,onlyBackgroundClipText:!1}),c=l.canvas,d=rQ(iE({scale:n,rect:function({rect:e,matrix:t}){let r=new DOMPointReadOnly(e.left,e.top),i=new DOMPointReadOnly(e.right,e.top),a=new DOMPointReadOnly(e.left,e.bottom),o=new DOMPointReadOnly(e.right,e.bottom),s=r.matrixTransform(t),n=i.matrixTransform(t),l=a.matrixTransform(t),c=o.matrixTransform(t),d=Math.min(s.x/s.w,n.x/n.w,l.x/l.w,c.x/c.w),h=Math.max(s.x/s.w,n.x/n.w,l.x/l.w,c.x/c.w),u=Math.min(s.y/s.w,n.y/n.w,l.y/l.w,c.y/c.w);return new DOMRect(d,u,h-d,Math.max(s.y/s.w,n.y/n.w,l.y/l.w,c.y/c.w)-u)}({rect:s,matrix:h})}));if(m.needsMaskImage&&ix({gradientInfo:m.needsMaskImage,rect:f,precomposeRect:s,tempContext:l,scale:n}),m.needs3DTransformViaWebGL){let e=iC({matrix:h,sourceRect:s,tempCanvas:c,rectAfterTransforms:d,internalState:o,scale:n});e&&(c=e)}let u=t.getTransform();return t.setTransform(new DOMMatrix),t.drawImage(c,0,c.height-d.height,d.width,d.height,d.left-a.x,d.top-a.y,d.width,d.height),t.setTransform(u),tE.Xp.Log.trace({logLevel:i,tag:"@remotion/web-renderer"},`Transforming element in 3D - canvas size: ${s.width}x${s.height} - compose: ${Date.now()-r}ms - helper canvas: ${c.width}x${c.height}`),o.addPrecompose({canvasWidth:s.width,canvasHeight:s.height}),{type:"skip-children"}}let{cleanupAfterChildren:p}=await ih({rect:f,computedStyle:d,context:t,draw:r,opacity:c,totalMatrix:h,parentRect:a,logLevel:i,element:e,internalState:o,scale:n});return{type:"continue",cleanupAfterChildren:p}}catch(e){var c=e,d=1}finally{tG(l,c,d)}},iM=(e,t)=>"uppercase"===t?e.toUpperCase():"lowercase"===t?e.toLowerCase():"capitalize"===t?e.replace(/\b\w/g,e=>e.toUpperCase()):e,iA=e=>{let t=e.textContent,r=Array.from(new Intl.Segmenter("en",{granularity:"word"}).segment(e.textContent)).map(e=>e.segment),i=[];for(let a=0;a<r.length;a++){let o=r.slice(0,a),s=r.slice(a+1),n=r[a],l=o.join(""),c=s.join(""),d=document.createTextNode(l),h=document.createTextNode(c),u=document.createElement("span");u.textContent=n,e.textContent="",e.appendChild(d),e.appendChild(u),e.appendChild(h);let m=u.getBoundingClientRect();e.textContent=t,i.push({text:n,rect:m})}return i},i_=({span:e,logLevel:t,onlyBackgroundClipText:r,parentRect:i})=>({computedStyle:a,contextToDraw:o})=>{let{fontFamily:s,fontSize:n,fontWeight:l,direction:c,writingMode:d,letterSpacing:h,textTransform:u,webkitTextFillColor:m}=a;if("horizontal-tb"!==d){tE.Xp.Log.warn({logLevel:t,tag:"@remotion/web-renderer"},'Detected "writing-mode" CSS property. Vertical text is not yet supported in @remotion/web-renderer');return}o.save();let f=parseFloat(n);o.font=`${l} ${f}px ${s}`,o.fillStyle=r?"black":m,o.letterSpacing=h;let p="rtl"===c;o.textAlign=p?"right":"left",o.textBaseline="alphabetic";let g=e.textContent;for(let t of(e.textContent=iM(g,u),iA(e))){let{fontBoundingBoxDescent:e,fontBoundingBoxAscent:r}=o.measureText(g),a=r+e,s=(t.rect.height-a)/2;o.fillText(t.text,(p?t.rect.right:t.rect.left)-i.x,t.rect.top+r+s-i.y)}e.textContent=g,o.restore()},iR=async({node:e,context:t,logLevel:r,parentRect:i,internalState:a,rootElement:o,onlyBackgroundClipText:s,scale:n})=>{let l=document.createElement("span"),c=e.parentNode;if(!c)throw Error("Text node has no parent");c.insertBefore(l,e),l.appendChild(e);let d=await iS({context:t,element:l,draw:i_({span:l,logLevel:r,onlyBackgroundClipText:s,parentRect:i}),logLevel:r,parentRect:i,internalState:a,rootElement:o,scale:n});return c.insertBefore(e,l),c.removeChild(l),d},iP=({node:e,context:t,logLevel:r,parentRect:i,internalState:a,rootElement:o,onlyBackgroundClipText:s,scale:n})=>{if(e instanceof HTMLElement||e instanceof SVGElement)return iS({element:e,context:t,draw:rA(e),logLevel:r,parentRect:i,internalState:a,rootElement:o,scale:n});if(e instanceof Text)return iR({node:e,context:t,logLevel:r,parentRect:i,internalState:a,rootElement:o,onlyBackgroundClipText:s,scale:n});throw Error("Unknown node type")},iz=e=>e instanceof Element&&(e.parentElement instanceof SVGSVGElement||"none"===getComputedStyle(e).display)?NodeFilter.FILTER_REJECT:NodeFilter.FILTER_ACCEPT,iF=async({element:e,context:t,logLevel:r,parentRect:i,internalState:a,onlyBackgroundClipText:o,scale:s})=>{let n=[];try{let l=document.createTreeWalker(e,o?NodeFilter.SHOW_TEXT:NodeFilter.SHOW_ELEMENT|NodeFilter.SHOW_TEXT,iz);if(o&&(l.nextNode(),!l.currentNode))return;let{checkCleanUpAtBeginningOfIteration:c,addCleanup:d}=tX(n,rg(l),0);for(;;){c();let n=await iP({node:l.currentNode,context:t,logLevel:r,parentRect:i,internalState:a,rootElement:e,onlyBackgroundClipText:o,scale:s});if("skip-children"===n.type){if(!iu(l))break}else if(n.cleanupAfterChildren&&d(l.currentNode,n.cleanupAfterChildren),!l.nextNode())break}}catch(e){var l=e,c=1}finally{tG(n,l,c)}},iW=async({element:e,scale:t,logLevel:r,internalState:i,onlyBackgroundClipText:a,cutout:o})=>{let s=new OffscreenCanvas(Math.ceil(o.width*t),Math.ceil(o.height*t)).getContext("2d");if(!s)throw Error("Could not get context");return await iF({element:e,context:s,logLevel:r,parentRect:o,internalState:i,onlyBackgroundClipText:a,scale:t}),s},iI=250,iL=(e,t=iI)=>{if(!e)return null;let r=0,i=null,a=null;return{throttled:o=>{let s=Date.now(),n=s-r;i=o,n>=t?(r=s,e(o),i=null,null!==a&&(clearTimeout(a),a=null)):null===a&&(a=setTimeout(()=>{null!==i&&(r=Date.now(),e(i),i=null),a=null},t-n))},[Symbol.dispose]:()=>{null!==a&&(clearTimeout(a),a=null),i=null}}},iO=e=>{if(void 0!==e){if("number"!=typeof e)throw Error('Scale should be a number or undefined, but is "'+JSON.stringify(e)+'"');if(Number.isNaN(e))throw Error("`scale` should not be NaN, but is NaN");if(!Number.isFinite(e))throw Error(`"scale" must be finite, but is ${e}`);if(e<=0)throw Error(`"scale" must be bigger than 0, but is ${e}`);if(e>16)throw Error(`"scale" must be smaller or equal than 16, but is ${e}`)}},iD=({originalFrame:e,returnedFrame:t,expectedWidth:r,expectedHeight:i,expectedTimestamp:a})=>{if(!(t instanceof VideoFrame))throw e.close(),Error("onFrame callback must return a VideoFrame or void");if(t===e)return t;if(t.displayWidth!==r||t.displayHeight!==i)throw e.close(),t.close(),Error(`VideoFrame dimensions mismatch: expected ${r}x${i}, got ${t.displayWidth}x${t.displayHeight}`);if(t.timestamp!==a)throw e.close(),t.close(),Error(`VideoFrame timestamp mismatch: expected ${a}, got ${t.timestamp}`);return e.close(),t},iB=function(){let e,t;return{promise:new Promise((r,i)=>{e=r,t=i}),resolve:e,reject:t}},iU=({timeoutInMilliseconds:e,scope:t,signal:r,apiName:i,internalState:a,keepalive:o})=>{let s=performance.now(),{promise:n,resolve:l,reject:c}=iB(),d=!1,h=()=>{if(!d){if(r?.aborted){d=!0,a?.addWaitForReadyTime(performance.now()-s),c(Error(`${i}() was cancelled`));return}if(!0===t.remotion_renderReady){a?.addWaitForReadyTime(performance.now()-s),l();return}if(void 0!==t.remotion_cancelledError){d=!0,a?.addWaitForReadyTime(performance.now()-s);let e=t.remotion_cancelledError,r=Error(e.split(`
`)[0].replace(/^Error: /,""));r.stack=e,c(r);return}if(performance.now()-s>e+3e3){d=!0,a?.addWaitForReadyTime(performance.now()-s),c(Error(Object.values(t.remotion_delayRenderTimeouts).map(e=>e.label).join(", ")));return}u()}},u=()=>{let e=new Promise(e=>{requestAnimationFrame(()=>e())});(o?Promise.race([e,o.waitForTick()]):e).then(h)};return h(),n},iN=null,i$=()=>(iN||(iN=crypto.randomUUID()),`__remotion_render:${iN}:`),iV=async()=>{try{let e=await navigator.storage.getDirectory();for await(let[t]of e.entries())t.startsWith("__remotion_render:")&&!t.startsWith(i$())&&await e.removeEntry(t)}catch{}},iH=async()=>{let e=await navigator.storage.getDirectory(),t=`${i$()}${crypto.randomUUID()}`,r=await e.getFileHandle(t,{create:!0}),i=await r.createWritable(),a=new WritableStream({async write(e){await i.seek(e.position),await i.write(e)}});return{stream:a,getBlob:async()=>(await e.getFileHandle(t)).getFile(),close:()=>i.close()}},iQ=async({composition:e,inputProps:t,delayRenderTimeoutInMilliseconds:r,logLevel:i,mediaCacheSizeInBytes:a,schema:o,videoCodec:s,audioCodec:n,audioBitrate:l,container:c,signal:d,onProgress:h,hardwareAcceleration:u,keyframeIntervalInSeconds:m,videoBitrate:f,frameRange:p,transparent:g,onArtifact:w,onFrame:b,outputTarget:y,licenseKey:k,muted:v,scale:C,isProduction:T})=>{let x=[];try{iO(C);let M=null===y?await tK()?"web-fs":"arraybuffer":y;"web-fs"===M&&await iV();let A=tZ(c);if(s&&!A.getSupportedCodecs().includes(tY(s)))return Promise.reject(Error(`Codec ${s} is not supported for container ${c}`));let _="number"==typeof l?l:t0(l),R=null;if(!v){let e=await t8({container:c,requestedCodec:n,userSpecifiedAudioCodec:null!=n,bitrate:_});for(let t of e.issues){if("error"===t.severity)return Promise.reject(Error(t.message));tE.Xp.Log.warn({logLevel:i,tag:"@remotion/web-renderer"},t.message)}R=e.codec}let P=await tE.Xp.resolveVideoConfig({calculateMetadata:e.calculateMetadata??null,signal:d??new AbortController().signal,defaultProps:e.defaultProps??{},inputProps:t??{},compositionId:e.id,compositionDurationInFrames:e.durationInFrames??null,compositionFps:e.fps??null,compositionHeight:e.height??null,compositionWidth:e.width??null}),z=rn(P.durationInFrames,p);if(d?.aborted)return Promise.reject(Error("renderMediaOnWeb() was cancelled"));let{delayRenderScope:F,div:W,timeUpdater:I,collectAssets:L,errorHolder:O}=tX(x,rs({width:P.width,height:P.height,fps:P.fps,durationInFrames:P.durationInFrames,Component:e.component,resolvedProps:P.props,id:P.id,delayRenderTimeoutInMilliseconds:r,logLevel:i,mediaCacheSizeInBytes:a,schema:o??null,audioEnabled:!v,videoEnabled:!0,initialFrame:0,defaultCodec:P.defaultCodec,defaultOutName:P.defaultOutName}),0),D=tX(x,rl(),0),B=tX(x,function({fps:e,logLevel:t}){let r=Math.round(1e3/e),i=[],a=null,o=!1;if("undefined"==typeof Worker)return tE.Xp.Log.warn({logLevel:t,tag:"@remotion/web-renderer"},"Web Workers not available. Rendering may pause when tab is backgrounded."),{waitForTick:()=>new Promise(e=>{setTimeout(e,r)}),[Symbol.dispose]:()=>{}};let s=new Blob([rr],{type:"application/javascript"}),n=URL.createObjectURL(s);return(a=new Worker(n)).onmessage=()=>{let e=i;for(let t of(i=[],e))t()},a.onerror=e=>{tE.Xp.Log.error({logLevel:t,tag:"@remotion/web-renderer"},"Background keepalive worker encountered an error and will be terminated.",e);let r=i;for(let e of(i=[],r))e();o||(o=!0,a?.terminate(),a=null,URL.revokeObjectURL(n))},a.postMessage({type:"start",intervalMs:r}),{waitForTick:()=>new Promise(e=>{i.push(e)}),[Symbol.dispose]:()=>{if(o)return;o=!0,a?.postMessage({type:"stop"}),a?.terminate(),a=null,URL.revokeObjectURL(n);let e=i;for(let t of(i=[],e))t()}}}({fps:P.fps,logLevel:i}),0),U=re(),N="web-fs"===M?await iH():null,$=N?new e1(N.stream):new e0,V=tX(x,rc({format:A,target:$}),0),H=tX(x,iL(h),0),Q=H?.throttled??null;try{let e=[];try{if(d?.aborted||(await iU({timeoutInMilliseconds:r,scope:F,signal:d,apiName:"renderMediaOnWeb",internalState:D,keepalive:B}),ro(O),d?.aborted))throw Error("renderMediaOnWeb() was cancelled");let t=tX(e,rd({codec:tY(s),bitrate:"number"==typeof f?f:t0(f),sizeChangeBehavior:"deny",hardwareAcceleration:u,latencyMode:"quality",keyFrameInterval:m,alpha:g?"keep":"discard"}),0);V.output.addVideoTrack(t.videoSampleSource);let a=tX(e,ri({muted:v,codec:R?t6(R):null,bitrate:_}),0);if(a&&V.output.addAudioTrack(a.audioSampleSource),await V.output.start(),d?.aborted)throw Error("renderMediaOnWeb() was cancelled");let o={renderedFrames:0,encodedFrames:0};for(let e=z[0];e<=z[1];e++){if(d?.aborted||(I.current?.update(e),await iU({timeoutInMilliseconds:r,scope:F,signal:d,apiName:"renderMediaOnWeb",keepalive:B,internalState:D}),ro(O),d?.aborted))throw Error("renderMediaOnWeb() was cancelled");let s=performance.now(),n=await iW({element:W,scale:C,logLevel:i,internalState:D,onlyBackgroundClipText:!1,cutout:new DOMRect(0,0,P.width,P.height)});if(D.addCreateFrameTime(performance.now()-s),d?.aborted)throw Error("renderMediaOnWeb() was cancelled");let l=Math.round((e-z[0])/P.fps*1e6),c=new VideoFrame(n.canvas,{timestamp:l});o.renderedFrames++,Q?.({...o});let h=c;if(b){let e=await b(c);if(d?.aborted)throw Error("renderMediaOnWeb() was cancelled");h=iD({originalFrame:c,returnedFrame:e,expectedWidth:Math.round(P.width*C),expectedHeight:Math.round(P.height*C),expectedTimestamp:l})}let u=performance.now(),m=L.current.collectAssets();if(w&&await U.handle({imageData:n.canvas,frame:e,assets:m,onArtifact:w}),d?.aborted)throw Error("renderMediaOnWeb() was cancelled");let f=v?null:rt({assets:m,fps:P.fps,timestamp:l});D.addAudioMixingTime(performance.now()-u);let p=performance.now();if(await Promise.all([t5(h,t.videoSampleSource),f&&a?t7(f,a.audioSampleSource):Promise.resolve()]),D.addAddSampleTime(performance.now()-p),o.encodedFrames++,Q?.({...o}),d?.aborted)throw Error("renderMediaOnWeb() was cancelled")}if(h?.({...o}),t.videoSampleSource.close(),a?.audioSampleSource.close(),await V.output.finalize(),tE.Xp.Log.verbose({logLevel:i,tag:"web-renderer"},`Render timings: waitForReady=${D.getWaitForReadyTime().toFixed(2)}ms, createFrame=${D.getCreateFrameTime().toFixed(2)}ms, addSample=${D.getAddSampleTime().toFixed(2)}ms, audioMixing=${D.getAudioMixingTime().toFixed(2)}ms`),N)return rp({licenseKey:k??null,succeeded:!0,apiName:"renderMediaOnWeb",isStill:!1,isProduction:T??!0}),await N.close(),{getBlob:()=>N.getBlob(),internalState:D};if(!($ instanceof e0))throw Error("Expected target to be a BufferTarget");return rp({licenseKey:k??null,succeeded:!0,apiName:"renderMediaOnWeb",isStill:!1,isProduction:T??!0}),{getBlob:()=>{if(!$.buffer)throw Error("The resulting buffer is empty");return Promise.resolve(new Blob([$.buffer],{type:t1(c)}))},internalState:D}}catch(e){var E=e,S=1}finally{tG(e,E,S)}}catch(e){throw d?.aborted||rp({succeeded:!1,licenseKey:k??null,apiName:"renderMediaOnWeb",isStill:!1,isProduction:T??!0}).catch(e=>{tE.Xp.Log.error({logLevel:"error",tag:"web-renderer"},"Failed to send usage event",e)}),e}}catch(e){var M=e,A=1}finally{tG(x,M,A)}},ij=e=>{let t=e.container??"mp4",r=e.videoCodec??tJ(t);return rh.ref=rh.ref.catch(()=>Promise.resolve()).then(()=>iQ({...e,delayRenderTimeoutInMilliseconds:e.delayRenderTimeoutInMilliseconds??3e4,logLevel:e.logLevel??window.remotion_logLevel??"info",schema:e.schema??void 0,mediaCacheSizeInBytes:e.mediaCacheSizeInBytes??null,videoCodec:r,audioCodec:e.audioCodec??null,audioBitrate:e.audioBitrate??"medium",container:t,signal:e.signal??null,onProgress:e.onProgress??null,hardwareAcceleration:e.hardwareAcceleration??"no-preference",keyframeIntervalInSeconds:e.keyframeIntervalInSeconds??5,videoBitrate:e.videoBitrate??"medium",frameRange:e.frameRange??null,transparent:e.transparent??!1,onArtifact:e.onArtifact??null,onFrame:e.onFrame??null,outputTarget:e.outputTarget??null,licenseKey:e.licenseKey??null,muted:e.muted??!1,scale:e.scale??1,isProduction:e.isProduction??!0})),rh.ref}}}]);